# 設計変更履歴 - 2025年12月4日

**変更日**: 2025-12-04  
**変更理由**: 外部サーバー参照テーブルのローカルテーブル化

---

## 1. 変更概要

旧システムで外部の別サーバーからリンクテーブルとして参照していた以下のテーブルを、新システムでは DEV-SE02\SQL22 / SUPPORTDB 内にローカルテーブルとして構築し、直接参照する方式に変更しました。

### 対象テーブル

| テーブル名 | 旧方式 | 新方式 |
|-----------|--------|--------|
| SQL_顧客 | 外部サーバーからリンク | SUPPORTDB内ローカルテーブル |
| SQL_作業担当 | 外部サーバーからリンク | SUPPORTDB内ローカルテーブル |
| SQL_部門 | 外部サーバーからリンク | SUPPORTDB内ローカルテーブル |

---

## 2. 追加されたテーブル定義ファイル

以下のテーブル作成SQLファイルがナレッジディレクトリに追加されました：

| ファイル名 | 内容 |
|-----------|------|
| CRETab_SQL_顧客.sql | SQL_顧客テーブルのCREATE文 |
| CRETab_SQL_作業担当.sql | SQL_作業担当テーブルのCREATE文 |
| CRETab_SQL_部門.sql | SQL_部門テーブルのCREATE文 |

---

## 3. 改修対象設計書

以下の設計書を改修しました：

### 3.1 DB詳細設計書.md (v1.0 → v1.1)

**改修内容**:
- セクション4「外部参照テーブル（ビュー/リンクテーブル）」を「参照テーブル（ローカルテーブル）」に改名
- SQL_顧客、SQL_作業担当、SQL_部門の定義を実際のテーブル定義に準拠して更新
- テーブル情報に「データベース: DEV-SE02\SQL22 / SUPPORTDB」を明記
- 各テーブルのカラム定義、インデックス定義、外部キー制約を詳細化

### 3.2 data_flow.md (v1.0 → v1.1)

**改修内容**:
- セクション5.1「D1: 担当者」に変更注記を追加
- セクション5.4「D4: 参照テーブル」を新規追加
- SQL_顧客、SQL_作業担当、SQL_部門のデータストア定義を追記

### 3.3 ストアドプロシージャ詳細設計書.md (v1.0 → v1.1)

**改修内容**:
- セクション4.5「CHK_ログイン」に変更注記を追加
- 戻り値から権限レベルカラムを削除（テーブルに存在しないため）
- SQL内に「SQL_作業担当はSUPPORTDB内のローカルテーブルを参照」のコメントを追加

### 3.4 機能設計書/auth.md (v1.0 → v1.1)

**改修内容**:
- 認証SQL（セクション3.2）を更新
  - 参照先をローカルテーブルに変更
  - 権限レベルカラムを削除
  - 削除日時条件を削除（カラム不在のため）
- セッション変数（セクション3.3）を更新
  - AUTH_LEVELを固定値（2）に変更
  - USER_NAMEの参照元を「担当者名」に修正
- 実装コード（セクション3.4）を更新
  - 英語エイリアスでの取得に変更（文字化け対策）
  - AUTH_LEVELを固定値設定に変更
- 備考（セクション11.1）を更新

---

## 4. 主要な技術的変更点

### 4.1 権限レベルの取り扱い

**変更前**: SQL_作業担当テーブルから権限レベルを取得  
**変更後**: テーブルに権限レベルカラムが存在しないため、全ユーザーを管理者権限（AUTH_LEVEL = 2）として扱う

### 4.2 認証SQLの変更

```sql
-- 変更前
SELECT 
    担当者コード,
    作業担当名,
    部門コード,
    権限レベル
FROM SQL_作業担当
WHERE 担当者コード = @user_code
  AND パスワード = @password
  AND 削除日時 IS NULL

-- 変更後
SELECT 
    担当者コード AS tantou_code,
    担当者名 AS tantou_name,
    部門コード AS bumon_code
FROM SQL_作業担当
WHERE 担当者コード = @user_code
  AND パスワード = @password
```

### 4.3 外部キー制約

SQL_作業担当テーブルに以下の外部キー制約が設定されています：
- FK_SQL_作業担当_部門: 部門コード → SQL_部門.部門コード

---

## 5. 影響範囲

### 5.1 影響を受けるプログラム

| ファイル | 影響内容 |
|---------|---------|
| login.php | 認証SQL変更、セッション変数設定変更 |
| includes/auth.php | 権限レベル取得方法の変更 |
| api/get_customers.php | SQL_顧客参照方法の確認 |
| api/get_tantousha.php | SQL_作業担当参照方法の確認 |
| api/get_bumon.php | SQL_部門参照方法の確認 |

### 5.2 データベース作業

以下のテーブルをSUPPORTDBに作成する必要があります：
1. SQL_部門（先に作成：外部キー参照元）
2. SQL_作業担当（SQL_部門に依存）
3. SQL_顧客

---

## 6. 今後の検討事項

1. **権限管理の実装**: 現在は全ユーザー管理者権限として扱っているが、将来的には権限テーブルの追加や権限レベルカラムの追加を検討
2. **パスワードのハッシュ化**: セキュリティ強化のため、将来的にはパスワードのハッシュ化を検討
3. **データ同期**: 旧システムのデータをローカルテーブルに移行する際のデータ同期方法の検討

---

**作成者**: Claude AI  
**作成日**: 2025-12-04
