# サポート報告書WEBシステム セッション管理仕様書

**作成日**: 2025-11-25  
**バージョン**: 1.0  
**Phase**: 04

---

## 1. 概要

本資料は、サポート報告書WEBシステムで使用するセッション管理の仕様を定義したものです。

---

## 2. セッション基本設定

### 2.1 セッション設定値

| 項目 | 設定値 | 説明 |
|------|--------|------|
| session.gc_maxlifetime | 32400秒（9時間） | セッション有効期限 |
| session.cookie_lifetime | 0 | ブラウザ閉じるまで有効 |
| session.cookie_httponly | true | JavaScript無効化 |
| session.cookie_secure | false | HTTP通信（社内） |
| session.use_strict_mode | true | 不正セッションID拒否 |
| session.use_only_cookies | true | Cookie以外のID受付拒否 |

### 2.2 設定ファイル（config.php）

```php
<?php
// セッション設定
ini_set('session.gc_maxlifetime', 32400);  // 9時間
ini_set('session.cookie_lifetime', 0);
ini_set('session.cookie_httponly', 1);
ini_set('session.cookie_secure', 0);
ini_set('session.use_strict_mode', 1);
ini_set('session.use_only_cookies', 1);

// セッション開始前に設定
session_set_cookie_params([
    'lifetime' => 0,
    'path' => '/',
    'domain' => '',
    'secure' => false,
    'httponly' => true,
    'samesite' => 'Lax'
]);

// セッション開始
session_start();
```

---

## 3. セッション変数一覧

### 3.1 認証関連

| 変数名 | 型 | 説明 | 設定タイミング |
|--------|-----|------|--------------|
| $_SESSION['LOGIN'] | bool | ログイン状態 | ログイン成功時 |
| $_SESSION['USER_ID'] | int | 担当者コード | ログイン成功時 |
| $_SESSION['USER_NAME'] | string | 担当者名 | ログイン成功時 |
| $_SESSION['BUMON_CODE'] | int | 部門コード | ログイン成功時 |
| $_SESSION['BUMON_NAME'] | string | 部門名 | ログイン成功時 |
| $_SESSION['AUTH_LEVEL'] | int | 権限レベル（1:一般、2:管理者） | ログイン成功時 |
| $_SESSION['LOGIN_TIME'] | string | ログイン日時 | ログイン成功時 |

### 3.2 画面状態関連

| 変数名 | 型 | 説明 | 設定タイミング |
|--------|-----|------|--------------|
| $_SESSION['SEARCH_PARAMS'] | array | 検索条件保持 | 検索実行時 |
| $_SESSION['CURRENT_PAGE'] | int | 現在のページ番号 | ページ遷移時 |
| $_SESSION['SORT_COLUMN'] | string | ソートカラム | ソート変更時 |
| $_SESSION['SORT_ORDER'] | string | ソート順（ASC/DESC） | ソート変更時 |
| $_SESSION['DISPLAY_COUNT'] | int | 表示件数 | 表示件数変更時 |

### 3.3 一時データ関連

| 変数名 | 型 | 説明 | 設定タイミング |
|--------|-----|------|--------------|
| $_SESSION['TEMP_DATA'] | array | 一時保存データ | 入力途中保存時 |
| $_SESSION['MESSAGE'] | string | 画面メッセージ | 処理完了時 |
| $_SESSION['ERROR'] | array | エラーメッセージ | エラー発生時 |
| $_SESSION['CSRF_TOKEN'] | string | CSRFトークン（将来用） | - |

---

## 4. セッションライフサイクル

### 4.1 ライフサイクル図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        セッションライフサイクル                          │
└─────────────────────────────────────────────────────────────────────────┘

[ブラウザ起動]
      │
      ↓
┌─────────────┐
│ login.php   │ ← セッション開始（空）
│             │
│ ID/PW入力   │
└──────┬──────┘
       │ 認証成功
       ↓
┌─────────────────────────────────────────────────────────────────┐
│                      認証済みセッション                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  セッション変数設定                                       │   │
│  │  ・LOGIN = true                                         │   │
│  │  ・USER_ID = 担当者コード                               │   │
│  │  ・USER_NAME = 担当者名                                 │   │
│  │  ・BUMON_CODE = 部門コード                              │   │
│  │  ・AUTH_LEVEL = 権限レベル                              │   │
│  │  ・LOGIN_TIME = ログイン日時                            │   │
│  │  ・session_regenerate_id(true)                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ↓                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │               アクティブ状態                             │   │
│  │                                                         │   │
│  │  support_main.php                                       │   │
│  │    ├─ 検索実行 → SEARCH_PARAMS更新                      │   │
│  │    ├─ ページ遷移 → CURRENT_PAGE更新                     │   │
│  │    ├─ 入力途中 → TEMP_DATA更新                          │   │
│  │    └─ 保存完了 → MESSAGE設定                            │   │
│  │                                                         │   │
│  │  master_*.php                                           │   │
│  │    └─ マスタ編集 → 各種状態更新                         │   │
│  │                                                         │   │
│  │  Ajax通信時もセッションチェック実施                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│              ┌────────────┼────────────┐                       │
│              │            │            │                        │
│              ↓            ↓            ↓                        │
│      ┌───────────┐ ┌───────────┐ ┌───────────┐                 │
│      │ログアウト │ │タイムアウト│ │ブラウザ閉じ│                │
│      │ボタン押下 │ │（9時間）  │ │           │                 │
│      └─────┬─────┘ └─────┬─────┘ └─────┬─────┘                 │
└────────────│─────────────│─────────────│───────────────────────┘
             │             │             │
             ↓             ↓             ↓
      ┌─────────────────────────────────────────┐
      │            セッション終了              │
      │  ・session_unset()                     │
      │  ・session_destroy()                   │
      │  ・Cookie削除                          │
      └─────────────────────────────────────────┘
             │
             ↓
      ┌─────────────┐
      │ login.php   │ ← リダイレクト
      └─────────────┘
```

### 4.2 状態遷移表

| 現在状態 | イベント | 次状態 | アクション |
|---------|---------|--------|-----------|
| 未認証 | ログイン成功 | 認証済み | セッション変数設定、ID再生成 |
| 未認証 | ログイン失敗 | 未認証 | エラーメッセージ表示 |
| 認証済み | 画面操作 | 認証済み | 最終アクセス時刻更新 |
| 認証済み | ログアウト | 未認証 | セッション破棄、ログイン画面へ |
| 認証済み | タイムアウト | 未認証 | セッション無効、ログイン画面へ |
| 認証済み | ブラウザ閉じる | 未認証 | Cookie削除によりセッション無効 |

---

## 5. セッション管理処理

### 5.1 ログイン処理（auth.php）

```php
<?php
/**
 * ログイン認証処理
 * @param int $user_id 担当者コード
 * @param string $password パスワード
 * @return bool 認証結果
 */
function authenticate($user_id, $password) {
    global $pdo_conn;
    
    // 入力値のバリデーション
    if (empty($user_id) || empty($password)) {
        return false;
    }
    
    // 認証SP実行
    $stmt = $pdo_conn->prepare("EXEC dbo.CHK_ログイン @担当者コード = ?, @パスワード = ?");
    $stmt->execute(array($user_id, $password));
    $user = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($user) {
        // セッション固定攻撃対策
        session_regenerate_id(true);
        
        // セッション変数設定
        $_SESSION['LOGIN'] = true;
        $_SESSION['USER_ID'] = (int)$user['担当者コード'];
        $_SESSION['USER_NAME'] = $user['担当者名'];
        $_SESSION['BUMON_CODE'] = (int)$user['部門コード'];
        $_SESSION['AUTH_LEVEL'] = (int)$user['権限レベル'];
        $_SESSION['LOGIN_TIME'] = date('Y-m-d H:i:s');
        
        // 部門名取得
        $stmt2 = $pdo_conn->query("SELECT 部門名 FROM SQL_部門 WHERE 部門コード = " . (int)$user['部門コード']);
        $bumon = $stmt2->fetch(PDO::FETCH_ASSOC);
        $_SESSION['BUMON_NAME'] = $bumon ? $bumon['部門名'] : '';
        
        // 検索条件初期化
        $_SESSION['SEARCH_PARAMS'] = array();
        $_SESSION['CURRENT_PAGE'] = 1;
        $_SESSION['SORT_COLUMN'] = '対応開始日時';
        $_SESSION['SORT_ORDER'] = 'DESC';
        $_SESSION['DISPLAY_COUNT'] = 50;
        
        return true;
    }
    
    return false;
}

/**
 * ログアウト処理
 */
function logout() {
    // セッション変数をクリア
    $_SESSION = array();
    
    // セッションCookieを削除
    if (isset($_COOKIE[session_name()])) {
        setcookie(session_name(), '', time() - 42000, '/');
    }
    
    // セッションを破棄
    session_destroy();
}

/**
 * セッションチェック
 * @return bool 認証済みかどうか
 */
function isLoggedIn() {
    return isset($_SESSION['LOGIN']) && $_SESSION['LOGIN'] === true;
}

/**
 * 管理者チェック
 * @return bool 管理者かどうか
 */
function isAdmin() {
    return isLoggedIn() && isset($_SESSION['AUTH_LEVEL']) && $_SESSION['AUTH_LEVEL'] >= 2;
}

/**
 * セッションチェック（ページ用）
 * 未認証の場合はログイン画面にリダイレクト
 */
function requireLogin() {
    if (!isLoggedIn()) {
        header('Location: login.php?timeout=1');
        exit;
    }
}

/**
 * 管理者権限チェック（ページ用）
 * 管理者でない場合はメイン画面にリダイレクト
 */
function requireAdmin() {
    requireLogin();
    if (!isAdmin()) {
        header('Location: support_main.php?error=permission');
        exit;
    }
}
```

### 5.2 Ajax用セッションチェック

```php
<?php
/**
 * Ajax用セッションチェック
 * 未認証の場合はJSONでエラーを返す
 */
function checkSessionForAjax() {
    if (!isLoggedIn()) {
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode(array(
            'status' => 'error',
            'message' => 'セッションが切れました。再度ログインしてください。',
            'redirect' => 'login.php'
        ));
        exit;
    }
}

/**
 * Ajax用管理者権限チェック
 */
function checkAdminForAjax() {
    checkSessionForAjax();
    if (!isAdmin()) {
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode(array(
            'status' => 'error',
            'message' => '権限がありません。'
        ));
        exit;
    }
}
```

### 5.3 各ページでの使用方法

```php
<?php
// support_main.php
require_once("../../func/inc.php");
require_once("includes/auth.php");

// セッションチェック
requireLogin();

// 以下、認証済みの処理
$user_name = $_SESSION['USER_NAME'];
$bumon_code = $_SESSION['BUMON_CODE'];
?>
```

```php
<?php
// master_product.php（管理者専用）
require_once("../../func/inc.php");
require_once("includes/auth.php");

// 管理者権限チェック
requireAdmin();

// 以下、管理者のみの処理
?>
```

```php
<?php
// support_ajax01.php（Ajax処理）
require_once("../../func/inc.php");
require_once("includes/auth.php");

// Ajax用セッションチェック
checkSessionForAjax();

// 以下、認証済みのAjax処理
?>
```

---

## 6. 検索条件の保持

### 6.1 検索条件の保存

```php
<?php
/**
 * 検索条件をセッションに保存
 */
function saveSearchParams($params) {
    $_SESSION['SEARCH_PARAMS'] = array(
        'taiou_date_from' => isset($params['taiou_date_from']) ? $params['taiou_date_from'] : '',
        'taiou_date_to' => isset($params['taiou_date_to']) ? $params['taiou_date_to'] : '',
        'tantou_code' => isset($params['tantou_code']) ? (int)$params['tantou_code'] : '',
        'kokyaku_name' => isset($params['kokyaku_name']) ? $params['kokyaku_name'] : '',
        'shohin_code' => isset($params['shohin_code']) ? (int)$params['shohin_code'] : '',
        'kubun_code' => isset($params['kubun_code']) ? (int)$params['kubun_code'] : '',
        'keyword' => isset($params['keyword']) ? $params['keyword'] : '',
        'taiou_flags' => isset($params['taiou_flags']) ? $params['taiou_flags'] : array()
    );
}

/**
 * 検索条件をセッションから取得
 */
function getSearchParams() {
    return isset($_SESSION['SEARCH_PARAMS']) ? $_SESSION['SEARCH_PARAMS'] : array();
}

/**
 * 検索条件をクリア
 */
function clearSearchParams() {
    $_SESSION['SEARCH_PARAMS'] = array();
    $_SESSION['CURRENT_PAGE'] = 1;
}
```

### 6.2 ページング状態の保存

```php
<?php
/**
 * 現在ページを保存
 */
function setCurrentPage($page) {
    $_SESSION['CURRENT_PAGE'] = max(1, (int)$page);
}

/**
 * 現在ページを取得
 */
function getCurrentPage() {
    return isset($_SESSION['CURRENT_PAGE']) ? (int)$SESSION['CURRENT_PAGE'] : 1;
}

/**
 * ソート条件を保存
 */
function setSortParams($column, $order) {
    $allowed_columns = array('対応開始日時', 'SEQNO', '顧客名', '作業担当名');
    $allowed_orders = array('ASC', 'DESC');
    
    if (in_array($column, $allowed_columns)) {
        $_SESSION['SORT_COLUMN'] = $column;
    }
    if (in_array(strtoupper($order), $allowed_orders)) {
        $_SESSION['SORT_ORDER'] = strtoupper($order);
    }
}

/**
 * 表示件数を保存
 */
function setDisplayCount($count) {
    $allowed_counts = array(25, 50, 100);
    if (in_array((int)$count, $allowed_counts)) {
        $_SESSION['DISPLAY_COUNT'] = (int)$count;
    }
}
```

---

## 7. メッセージ管理

### 7.1 フラッシュメッセージ

```php
<?php
/**
 * 成功メッセージを設定
 */
function setSuccessMessage($message) {
    $_SESSION['MESSAGE'] = array(
        'type' => 'success',
        'text' => $message
    );
}

/**
 * エラーメッセージを設定
 */
function setErrorMessage($message) {
    $_SESSION['ERROR'] = array($message);
}

/**
 * エラーメッセージを追加
 */
function addErrorMessage($message) {
    if (!isset($_SESSION['ERROR'])) {
        $_SESSION['ERROR'] = array();
    }
    $_SESSION['ERROR'][] = $message;
}

/**
 * メッセージを取得して削除（フラッシュ）
 */
function getFlashMessage() {
    $message = isset($_SESSION['MESSAGE']) ? $_SESSION['MESSAGE'] : null;
    unset($_SESSION['MESSAGE']);
    return $message;
}

/**
 * エラーメッセージを取得して削除（フラッシュ）
 */
function getFlashErrors() {
    $errors = isset($_SESSION['ERROR']) ? $_SESSION['ERROR'] : array();
    unset($_SESSION['ERROR']);
    return $errors;
}
```

### 7.2 画面での表示

```php
<?php
// メッセージ表示
$flash_message = getFlashMessage();
if ($flash_message) {
    if ($flash_message['type'] === 'success') {
        echo '<div class="alert alert-success">' . htmlspecialchars($flash_message['text']) . '</div>';
    }
}

// エラー表示
$flash_errors = getFlashErrors();
if (count($flash_errors) > 0) {
    echo '<div class="alert alert-danger">';
    foreach ($flash_errors as $error) {
        echo '<p>' . htmlspecialchars($error) . '</p>';
    }
    echo '</div>';
}
?>
```

---

## 8. タイムアウト処理

### 8.1 自動タイムアウト

PHPのsession.gc_maxlifetime（32400秒 = 9時間）で自動的にセッションが無効化されます。

### 8.2 JavaScript側のタイムアウト検知

```javascript
// Ajax通信でセッション切れを検知
function handleAjaxResponse(response) {
    if (response.status === 'error' && response.redirect) {
        alert(response.message);
        window.location.href = response.redirect;
        return false;
    }
    return true;
}

// Ajax通信の共通処理
function ajaxRequest(url, data, successCallback) {
    $.ajax({
        type: 'POST',
        url: url,
        dataType: 'json',
        data: data,
        success: function(response) {
            if (handleAjaxResponse(response)) {
                successCallback(response);
            }
        },
        error: function(xhr, status, error) {
            if (xhr.status === 401) {
                alert('セッションが切れました。再度ログインしてください。');
                window.location.href = 'login.php';
            } else {
                alert('通信エラーが発生しました。');
            }
        }
    });
}
```

### 8.3 ログイン画面でのタイムアウト表示

```php
<?php
// login.php
if (isset($_GET['timeout']) && $_GET['timeout'] == '1') {
    echo '<div class="alert alert-warning">セッションがタイムアウトしました。再度ログインしてください。</div>';
}
?>
```

---

## 9. セキュリティ考慮事項

### 9.1 実装済みセキュリティ対策

| 対策 | 実装方法 |
|------|---------|
| セッション固定攻撃 | session_regenerate_id(true) |
| セッションハイジャック | HTTPOnly Cookie |
| XSS | Cookie SameSite設定 |
| 不正セッションID | strict_mode有効化 |

### 9.2 今後の強化案（外部公開時）

| 対策 | 実装方法 |
|------|---------|
| HTTPS化 | session.cookie_secure = true |
| CSRF対策 | トークンベース検証 |
| IPアドレス検証 | セッションとIP紐付け |
| User-Agent検証 | セッションとUA紐付け |

---

## 10. デバッグ・ログ

### 10.1 セッションデバッグ（開発時のみ）

```php
<?php
// 開発環境でのみ有効
if (defined('DEBUG_MODE') && DEBUG_MODE) {
    function debugSession() {
        echo '<pre style="background:#f5f5f5;padding:10px;font-size:12px;">';
        echo 'Session ID: ' . session_id() . "\n";
        echo 'Session Data: ' . print_r($_SESSION, true);
        echo '</pre>';
    }
}
?>
```

### 10.2 ログイン・ログアウトログ

```php
<?php
/**
 * 認証ログを記録
 */
function logAuth($action, $user_id, $result) {
    $log_message = sprintf(
        "[%s] %s - User: %d - Result: %s - IP: %s",
        date('Y-m-d H:i:s'),
        $action,
        $user_id,
        $result ? 'SUCCESS' : 'FAILED',
        $_SERVER['REMOTE_ADDR']
    );
    error_log($log_message, 3, 'logs/auth.log');
}
```

---

**作成者**: Claude AI  
**レビュー**: Phase 04完了時  
**改訂履歴**:
- v1.0 (2025-11-25): 初版作成
