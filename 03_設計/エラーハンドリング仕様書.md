# サポート報告書WEBシステム エラーハンドリング仕様書

**作成日**: 2025-11-25  
**バージョン**: 1.0  
**Phase**: 04

---

## 1. 概要

本資料は、サポート報告書WEBシステムで使用するエラーハンドリングの仕様を定義したものです。

---

## 2. エラー分類

### 2.1 エラーカテゴリ

| カテゴリ | コード接頭辞 | 説明 |
|---------|-------------|------|
| 認証エラー | AUTH | ログイン・権限関連 |
| バリデーションエラー | VALID | 入力検証関連 |
| データベースエラー | DB | データベース操作関連 |
| ビジネスロジックエラー | BIZ | 業務処理関連 |
| システムエラー | SYS | システム全般 |

### 2.2 エラー重大度

| レベル | 名称 | 説明 | 対応 |
|--------|------|------|------|
| 1 | INFO | 情報 | ログのみ |
| 2 | WARNING | 警告 | 画面表示 |
| 3 | ERROR | エラー | 処理中断、画面表示 |
| 4 | CRITICAL | 致命的 | 処理中断、管理者通知 |

---

## 3. エラーコード一覧

### 3.1 認証エラー（AUTH）

| コード | メッセージ | 発生条件 | 重大度 |
|--------|-----------|---------|--------|
| AUTH_001 | セッションが切れました。再度ログインしてください。 | 未認証でのアクセス | 3 |
| AUTH_002 | ログインに失敗しました。ID・パスワードを確認してください。 | 認証失敗 | 3 |
| AUTH_003 | このページへのアクセス権限がありません。 | 権限不足 | 3 |
| AUTH_004 | アカウントがロックされています。管理者に連絡してください。 | アカウントロック（将来用） | 3 |

### 3.2 バリデーションエラー（VALID）

| コード | メッセージ | 発生条件 | 重大度 |
|--------|-----------|---------|--------|
| VALID_001 | {項目名}は必須項目です。 | 必須項目未入力 | 2 |
| VALID_002 | {項目名}の形式が正しくありません。 | 形式不正 | 2 |
| VALID_003 | {項目名}は{最大}文字以内で入力してください。 | 文字数オーバー | 2 |
| VALID_004 | {項目名}は{最小}〜{最大}の範囲で入力してください。 | 範囲外 | 2 |
| VALID_005 | {項目名}は数値で入力してください。 | 数値以外 | 2 |
| VALID_006 | 日付の形式が正しくありません。（YYYY-MM-DD） | 日付形式不正 | 2 |
| VALID_007 | 開始日は終了日より前の日付を指定してください。 | 日付範囲不正 | 2 |
| VALID_008 | 選択された{項目名}は無効です。 | マスタ不整合 | 2 |

### 3.3 データベースエラー（DB）

| コード | メッセージ | 発生条件 | 重大度 |
|--------|-----------|---------|--------|
| DB_001 | データベース接続に失敗しました。 | DB接続エラー | 4 |
| DB_002 | データの取得に失敗しました。 | SELECT失敗 | 3 |
| DB_003 | データの保存に失敗しました。 | INSERT/UPDATE失敗 | 3 |
| DB_004 | データの削除に失敗しました。 | DELETE失敗 | 3 |
| DB_005 | 指定されたデータが見つかりません。 | レコード未存在 | 3 |
| DB_006 | データが他のユーザーにより更新されています。 | 楽観的ロック競合 | 3 |
| DB_007 | このデータは使用中のため削除できません。 | 参照整合性エラー | 3 |
| DB_008 | トランザクションエラーが発生しました。 | トランザクション失敗 | 4 |

### 3.4 ビジネスロジックエラー（BIZ）

| コード | メッセージ | 発生条件 | 重大度 |
|--------|-----------|---------|--------|
| BIZ_001 | この操作は実行できません。 | 業務ルール違反 | 3 |
| BIZ_002 | 既に登録されているコードです。 | 重複登録 | 3 |
| BIZ_003 | 対応終了日時は開始日時より後を指定してください。 | 日時矛盾 | 2 |
| BIZ_004 | 報告内容を入力してください。 | 内容未入力 | 2 |

### 3.5 システムエラー（SYS）

| コード | メッセージ | 発生条件 | 重大度 |
|--------|-----------|---------|--------|
| SYS_001 | 不正なリクエストです。 | actionパラメータ不正 | 3 |
| SYS_002 | ファイルのアップロードに失敗しました。 | ファイル処理エラー | 3 |
| SYS_003 | システムエラーが発生しました。管理者に連絡してください。 | 予期せぬエラー | 4 |
| SYS_004 | 処理がタイムアウトしました。 | タイムアウト | 3 |

---

## 4. エラーハンドリング実装

### 4.1 エラークラス定義（error.php）

```php
<?php
/**
 * アプリケーションエラークラス
 */
class AppError extends Exception {
    private $error_code;
    private $severity;
    private $details;
    
    /**
     * コンストラクタ
     * @param string $code エラーコード
     * @param string $message エラーメッセージ
     * @param int $severity 重大度（1-4）
     * @param array $details 詳細情報
     */
    public function __construct($code, $message, $severity = 3, $details = array()) {
        parent::__construct($message);
        $this->error_code = $code;
        $this->severity = $severity;
        $this->details = $details;
    }
    
    public function getErrorCode() { return $this->error_code; }
    public function getSeverity() { return $this->severity; }
    public function getDetails() { return $this->details; }
}

/**
 * バリデーションエラークラス
 */
class ValidationError extends AppError {
    private $errors = array();
    
    public function __construct($errors = array()) {
        parent::__construct('VALID_000', 'バリデーションエラーが発生しました。', 2);
        $this->errors = $errors;
    }
    
    public function addError($field, $message) {
        $this->errors[$field] = $message;
    }
    
    public function getErrors() { return $this->errors; }
    public function hasErrors() { return count($this->errors) > 0; }
}
```

### 4.2 エラーメッセージ定義

```php
<?php
/**
 * エラーメッセージ定義
 */
$ERROR_MESSAGES = array(
    // 認証エラー
    'AUTH_001' => 'セッションが切れました。再度ログインしてください。',
    'AUTH_002' => 'ログインに失敗しました。ID・パスワードを確認してください。',
    'AUTH_003' => 'このページへのアクセス権限がありません。',
    'AUTH_004' => 'アカウントがロックされています。管理者に連絡してください。',
    
    // バリデーションエラー
    'VALID_001' => '{field}は必須項目です。',
    'VALID_002' => '{field}の形式が正しくありません。',
    'VALID_003' => '{field}は{max}文字以内で入力してください。',
    'VALID_004' => '{field}は{min}〜{max}の範囲で入力してください。',
    'VALID_005' => '{field}は数値で入力してください。',
    'VALID_006' => '日付の形式が正しくありません。（YYYY-MM-DD）',
    'VALID_007' => '開始日は終了日より前の日付を指定してください。',
    'VALID_008' => '選択された{field}は無効です。',
    
    // データベースエラー
    'DB_001' => 'データベース接続に失敗しました。',
    'DB_002' => 'データの取得に失敗しました。',
    'DB_003' => 'データの保存に失敗しました。',
    'DB_004' => 'データの削除に失敗しました。',
    'DB_005' => '指定されたデータが見つかりません。',
    'DB_006' => 'データが他のユーザーにより更新されています。',
    'DB_007' => 'このデータは使用中のため削除できません。',
    'DB_008' => 'トランザクションエラーが発生しました。',
    
    // ビジネスロジックエラー
    'BIZ_001' => 'この操作は実行できません。',
    'BIZ_002' => '既に登録されているコードです。',
    'BIZ_003' => '対応終了日時は開始日時より後を指定してください。',
    'BIZ_004' => '報告内容を入力してください。',
    
    // システムエラー
    'SYS_001' => '不正なリクエストです。',
    'SYS_002' => 'ファイルのアップロードに失敗しました。',
    'SYS_003' => 'システムエラーが発生しました。管理者に連絡してください。',
    'SYS_004' => '処理がタイムアウトしました。'
);

/**
 * エラーメッセージ取得
 * @param string $code エラーコード
 * @param array $params 置換パラメータ
 * @return string エラーメッセージ
 */
function getErrorMessage($code, $params = array()) {
    global $ERROR_MESSAGES;
    
    if (!isset($ERROR_MESSAGES[$code])) {
        return 'エラーが発生しました。';
    }
    
    $message = $ERROR_MESSAGES[$code];
    
    // プレースホルダー置換
    foreach ($params as $key => $value) {
        $message = str_replace('{' . $key . '}', $value, $message);
    }
    
    return $message;
}
```

### 4.3 グローバルエラーハンドラー

```php
<?php
/**
 * グローバルエラーハンドラー設定
 */

// エラーレポート設定
error_reporting(E_ALL ^ E_NOTICE);
ini_set('display_errors', 'Off');  // 本番環境
ini_set('log_errors', 'On');
ini_set('error_log', 'logs/php_error.log');

/**
 * 例外ハンドラー
 */
set_exception_handler(function($exception) {
    // ログ記録
    $log_message = sprintf(
        "[%s] EXCEPTION: %s in %s:%d\nStack trace:\n%s",
        date('Y-m-d H:i:s'),
        $exception->getMessage(),
        $exception->getFile(),
        $exception->getLine(),
        $exception->getTraceAsString()
    );
    error_log($log_message, 3, 'logs/exception.log');
    
    // Ajax通信の場合
    if (isAjaxRequest()) {
        header('Content-Type: application/json; charset=utf-8');
        http_response_code(500);
        echo json_encode(array(
            'status' => 'error',
            'message' => 'システムエラーが発生しました。'
        ));
        exit;
    }
    
    // 通常リクエストの場合
    http_response_code(500);
    include('error_page.php');
    exit;
});

/**
 * エラーハンドラー（Warningなど）
 */
set_error_handler(function($errno, $errstr, $errfile, $errline) {
    // E_NOTICEは無視
    if ($errno === E_NOTICE) {
        return false;
    }
    
    // ログ記録
    $log_message = sprintf(
        "[%s] PHP ERROR (%d): %s in %s:%d",
        date('Y-m-d H:i:s'),
        $errno,
        $errstr,
        $errfile,
        $errline
    );
    error_log($log_message, 3, 'logs/php_error.log');
    
    // E_WARNING以上はExceptionとして再throw
    if ($errno === E_WARNING || $errno === E_USER_ERROR) {
        throw new ErrorException($errstr, 0, $errno, $errfile, $errline);
    }
    
    return true;
});

/**
 * Ajax判定
 */
function isAjaxRequest() {
    return !empty($_SERVER['HTTP_X_REQUESTED_WITH']) && 
           strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
}
```

### 4.4 バリデーション処理

```php
<?php
/**
 * バリデーションクラス
 */
class Validator {
    private $errors = array();
    private $data = array();
    
    public function __construct($data) {
        $this->data = $data;
    }
    
    /**
     * 必須チェック
     */
    public function required($field, $label) {
        if (!isset($this->data[$field]) || trim($this->data[$field]) === '') {
            $this->errors[$field] = getErrorMessage('VALID_001', array('field' => $label));
        }
        return $this;
    }
    
    /**
     * 最大文字数チェック
     */
    public function maxLength($field, $label, $max) {
        if (isset($this->data[$field]) && mb_strlen($this->data[$field], 'UTF-8') > $max) {
            $this->errors[$field] = getErrorMessage('VALID_003', array('field' => $label, 'max' => $max));
        }
        return $this;
    }
    
    /**
     * 数値チェック
     */
    public function numeric($field, $label) {
        if (isset($this->data[$field]) && $this->data[$field] !== '' && !is_numeric($this->data[$field])) {
            $this->errors[$field] = getErrorMessage('VALID_005', array('field' => $label));
        }
        return $this;
    }
    
    /**
     * 日付形式チェック
     */
    public function date($field, $label) {
        if (isset($this->data[$field]) && $this->data[$field] !== '') {
            $date = DateTime::createFromFormat('Y-m-d', $this->data[$field]);
            if (!$date || $date->format('Y-m-d') !== $this->data[$field]) {
                $this->errors[$field] = getErrorMessage('VALID_006', array('field' => $label));
            }
        }
        return $this;
    }
    
    /**
     * 日付範囲チェック
     */
    public function dateRange($from_field, $to_field) {
        if (isset($this->data[$from_field]) && isset($this->data[$to_field]) && 
            $this->data[$from_field] !== '' && $this->data[$to_field] !== '') {
            if ($this->data[$from_field] > $this->data[$to_field]) {
                $this->errors[$from_field] = getErrorMessage('VALID_007');
            }
        }
        return $this;
    }
    
    /**
     * エラー有無チェック
     */
    public function hasErrors() {
        return count($this->errors) > 0;
    }
    
    /**
     * エラー取得
     */
    public function getErrors() {
        return $this->errors;
    }
}
```

### 4.5 使用例

```php
<?php
// バリデーション使用例
$validator = new Validator($_POST);
$validator
    ->required('taiou_date', '対応日')
    ->date('taiou_date', '対応日')
    ->required('kokyaku_code', '顧客')
    ->numeric('kokyaku_code', '顧客コード')
    ->required('tantou_code', '担当者')
    ->required('houkoku_naiyo', '報告内容')
    ->maxLength('houkoku_naiyo', '報告内容', 10000);

if ($validator->hasErrors()) {
    // エラーがある場合
    $errors = $validator->getErrors();
    
    if (isAjaxRequest()) {
        // Ajax応答
        echo json_encode(array(
            'status' => 'error',
            'errors' => $errors
        ));
    } else {
        // 通常画面
        foreach ($errors as $field => $message) {
            $err_msg[] = $message;
        }
    }
    return;
}
```

---

## 5. エラー表示

### 5.1 画面でのエラー表示（HTML）

```php
<?php if (count($err_msg) > 0): ?>
<div class="error-box">
    <?php foreach ($err_msg as $msg): ?>
    <p class="error-message"><span class="icon-error">！</span><?php echo htmlspecialchars($msg); ?></p>
    <?php endforeach; ?>
</div>
<?php endif; ?>
```

### 5.2 エラー表示用CSS

```css
/* エラーボックス */
.error-box {
    background-color: #fef2f2;
    border: 1px solid #f87171;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
}

.error-message {
    color: #dc2626;
    margin: 5px 0;
    padding-left: 20px;
    position: relative;
}

.icon-error {
    position: absolute;
    left: 0;
    color: #dc2626;
    font-weight: bold;
}

/* 成功メッセージ */
.success-box {
    background-color: #f0fdf4;
    border: 1px solid #4ade80;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
}

.success-message {
    color: #16a34a;
}

/* 入力エラー状態 */
.input-error {
    border-color: #f87171 !important;
    background-color: #fef2f2 !important;
}

.field-error-message {
    color: #dc2626;
    font-size: 12px;
    margin-top: 3px;
}
```

### 5.3 JavaScript側のエラー処理

```javascript
/**
 * Ajax共通エラーハンドラー
 */
function handleAjaxError(xhr, status, error) {
    var message = '通信エラーが発生しました。';
    
    if (xhr.status === 401) {
        message = 'セッションが切れました。再度ログインしてください。';
        window.location.href = 'login.php?timeout=1';
        return;
    } else if (xhr.status === 403) {
        message = 'アクセス権限がありません。';
    } else if (xhr.status === 404) {
        message = '指定されたページが見つかりません。';
    } else if (xhr.status === 500) {
        message = 'サーバーエラーが発生しました。';
    }
    
    showErrorMessage(message);
}

/**
 * エラーメッセージ表示
 */
function showErrorMessage(message) {
    // 既存のエラーを削除
    $('.error-box').remove();
    
    // エラーボックスを追加
    var html = '<div class="error-box"><p class="error-message"><span class="icon-error">！</span>' 
             + escapeHtml(message) + '</p></div>';
    
    $('.main-content').prepend(html);
    
    // スクロール
    $('html, body').animate({ scrollTop: 0 }, 300);
}

/**
 * フィールドエラー表示
 */
function showFieldErrors(errors) {
    // 既存のエラー状態をクリア
    $('.input-error').removeClass('input-error');
    $('.field-error-message').remove();
    
    // フィールドごとにエラー表示
    for (var field in errors) {
        var $input = $('[name="' + field + '"]');
        $input.addClass('input-error');
        $input.after('<span class="field-error-message">' + escapeHtml(errors[field]) + '</span>');
    }
}

/**
 * HTMLエスケープ
 */
function escapeHtml(str) {
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}
```

---

## 6. Ajax応答形式

### 6.1 成功時

```json
{
    "status": "success",
    "data": { ... },
    "message": "保存しました。"
}
```

### 6.2 エラー時（単一エラー）

```json
{
    "status": "error",
    "message": "データの保存に失敗しました。"
}
```

### 6.3 エラー時（バリデーションエラー）

```json
{
    "status": "error",
    "message": "入力内容にエラーがあります。",
    "errors": {
        "taiou_date": "対応日は必須項目です。",
        "houkoku_naiyo": "報告内容は10000文字以内で入力してください。"
    }
}
```

### 6.4 セッション切れ

```json
{
    "status": "error",
    "message": "セッションが切れました。再度ログインしてください。",
    "redirect": "login.php"
}
```

---

## 7. ログ設計

### 7.1 ログファイル構成

| ファイル名 | 内容 | ローテーション |
|-----------|------|--------------|
| logs/php_error.log | PHPエラー | 日次 |
| logs/exception.log | 例外エラー | 日次 |
| logs/auth.log | 認証ログ | 月次 |
| logs/app.log | アプリケーションログ | 日次 |

### 7.2 ログフォーマット

```
[2025-11-25 10:30:45] ERROR: データベースエラー - Code: DB_003 - User: 101 - IP: 192.168.1.100
[2025-11-25 10:30:45] TRACE: PDOException: SQLSTATE[HY000] Connection refused
```

### 7.3 ログ出力関数

```php
<?php
/**
 * アプリケーションログ出力
 */
function logApp($level, $message, $context = array()) {
    $user_id = isset($_SESSION['USER_ID']) ? $_SESSION['USER_ID'] : 'guest';
    $ip = $_SERVER['REMOTE_ADDR'];
    
    $log_message = sprintf(
        "[%s] %s: %s - User: %s - IP: %s",
        date('Y-m-d H:i:s'),
        strtoupper($level),
        $message,
        $user_id,
        $ip
    );
    
    if (!empty($context)) {
        $log_message .= " - Context: " . json_encode($context, JSON_UNESCAPED_UNICODE);
    }
    
    error_log($log_message . "\n", 3, 'logs/app.log');
}

// 使用例
logApp('error', 'データの保存に失敗', array('seqno' => $seqno, 'code' => 'DB_003'));
logApp('info', 'ユーザーがログイン', array('user_id' => $user_id));
```

---

## 8. エラーページ

### 8.1 エラーページ（error_page.php）

```php
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>エラー | サポート報告書システム</title>
<style>
body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 50px; }
.error-container { max-width: 600px; margin: 0 auto; background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
h1 { color: #dc2626; margin-bottom: 20px; }
p { color: #666; line-height: 1.8; }
a { color: #2563eb; text-decoration: none; }
a:hover { text-decoration: underline; }
</style>
</head>
<body>
<div class="error-container">
    <h1>エラーが発生しました</h1>
    <p>申し訳ございません。システムエラーが発生しました。</p>
    <p>しばらく待ってから再度お試しください。</p>
    <p>問題が続く場合は、システム管理者にご連絡ください。</p>
    <p style="margin-top: 30px;">
        <a href="support_main.php">メイン画面に戻る</a>
    </p>
</div>
</body>
</html>
```

---

**作成者**: Claude AI  
**レビュー**: Phase 04完了時  
**改訂履歴**:
- v1.0 (2025-11-25): 初版作成
