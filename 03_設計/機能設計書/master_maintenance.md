# マスタ保守機能設計書

**作成日**: 2025-11-25  
**バージョン**: 1.0  
**Phase**: 03  
**機能ID**: master_maintenance  
**関連ファイル**: master_ajax.php, master_product.php, master_template.php, master_category.php, master_content.php

---

## 1. 概要

### 1.1 機能の目的
各種マスタデータの登録・編集・削除を行い、システムの基盤データを管理する。

### 1.2 機能範囲
- 商品マスタの保守
- 定型文マスタの保守
- 対応区分マスタの保守
- 対応内容項目マスタの保守

### 1.3 アクセス権限
ログインユーザー全員が利用可能

---

## 2. 共通処理仕様

### 2.1 共通処理フロー（一覧取得）

```
START
  │
  ↓
┌─────────────────────┐
│ログイン確認          │
└────────┬────────────┘
         │
    ┌────┴────┐
    │         │
   OK        NG
    │         │
    ↓         ↓
  継続     ログイン画面へ
    │
    ↓
┌─────────────────────┐
│フィルタ条件取得      │
│（部門等）           │
└────────┬────────────┘
         │
         ↓
┌─────────────────────┐
│SEL_M_*ストアドプロシージャ│
│実行                 │
└────────┬────────────┘
         │
         ↓
┌─────────────────────┐
│JSON形式で返却       │
└─────────────────────┘
         │
        END
```

### 2.2 共通処理フロー（登録・更新）

```
START
  │
  ↓
┌─────────────────────┐
│ログイン確認          │
└────────┬────────────┘
         │
         ↓
┌─────────────────────┐
│入力データ取得        │
│・mode（new/edit）   │
│・各項目データ        │
└────────┬────────────┘
         │
         ↓
┌─────────────────────┐
│サニタイズ           │
└────────┬────────────┘
         │
         ↓
┌─────────────────────┐
│バリデーション        │
└────────┬────────────┘
         │
    ┌────┴────┐
    │         │
   OK        NG
    │         │
    ↓         ↓
┌─────────┐  エラー返却
│mode判定  │
└────┬────┘
     │
┌────┴────┐
│         │
new      edit
│         │
↓         ↓
コード採番  既存コード
│         │
└────┬────┘
     │
     ↓
┌─────────────────────┐
│UPD_M_*ストアドプロシージャ│
│実行                 │
└────────┬────────────┘
         │
    ┌────┴────┐
    │         │
  成功      失敗
    │         │
    ↓         ↓
成功返却   エラー返却
    │
   END
```

### 2.3 共通処理フロー（削除）

```
START
  │
  ↓
┌─────────────────────┐
│ログイン確認          │
└────────┬────────────┘
         │
         ↓
┌─────────────────────┐
│削除対象コード取得    │
└────────┬────────────┘
         │
         ↓
┌─────────────────────┐
│存在確認             │
└────────┬────────────┘
         │
    ┌────┴────┐
    │         │
  存在     存在しない
    │         │
    ↓         ↓
  継続     エラー返却
    │
    ↓
┌─────────────────────┐
│DEL_*ストアドプロシージャ│
│（DELDATA_*へ移動）  │
└────────┬────────────┘
         │
    ┌────┴────┐
    │         │
  成功      失敗
    │         │
    ↓         ↓
成功返却   エラー返却
    │
   END
```

---

## 3. 商品マスタ保守

### 3.1 テーブル構造（M_商品）

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| 部門コード | int | NO | 主キー |
| 商品コード | int | NO | 主キー |
| 商品名 | nvarchar(255) | NO | - |
| 使用区分 | int | NO | 1:使用する、0:使用しない |
| 入力日時 | datetime | YES | - |
| 更新日時 | datetime | YES | - |

### 3.2 ストアドプロシージャ

| SP名 | 用途 |
|------|------|
| SEL_M_商品 | 一覧取得 |
| UPD_M_商品 | 登録・更新 |
| DEL_商品 | 削除（DELDATA_商品へ移動） |

### 3.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 部門 | 必須 | 部門を選択してください。 |
| 2 | 商品名 | 必須 | 商品名を入力してください。 |
| 3 | 商品名 | 最大255文字 | 商品名は255文字以内で入力してください。 |
| 4 | 使用区分 | 必須 | 使用区分を選択してください。 |

### 3.4 コード採番

新規登録時、部門内で商品コードの最大値+1を採番

```sql
SELECT ISNULL(MAX(商品コード), 0) + 1 AS NewCode
FROM M_商品
WHERE 部門コード = @bumon_code
```

---

## 4. 定型文マスタ保守

### 4.1 テーブル構造（M_定型文）

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| 部門コード | int | NO | 主キー |
| 定型文コード | int | NO | 主キー |
| 定型文 | nvarchar(MAX) | NO | - |
| 入力日時 | datetime | YES | - |
| 更新日時 | datetime | YES | - |

### 4.2 ストアドプロシージャ

| SP名 | 用途 |
|------|------|
| SEL_M_定型文 | 一覧取得 |
| UPD_M_定型文 | 登録・更新 |
| DEL_定型文 | 削除（DELDATA_定型文へ移動） |

### 4.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 部門 | 必須 | 部門を選択してください。 |
| 2 | 定型文 | 必須 | 定型文を入力してください。 |

### 4.4 コード採番

新規登録時、部門内で定型文コードの最大値+1を採番

```sql
SELECT ISNULL(MAX(定型文コード), 0) + 1 AS NewCode
FROM M_定型文
WHERE 部門コード = @bumon_code
```

---

## 5. 対応区分マスタ保守

### 5.1 テーブル構造（M_対応区分）

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| 対応区分コード | int | NO | 主キー |
| 対応区分名 | nvarchar(255) | NO | - |
| 入力日時 | datetime | YES | - |
| 更新日時 | datetime | YES | - |

### 5.2 ストアドプロシージャ

| SP名 | 用途 |
|------|------|
| SEL_M_対応区分 | 一覧取得 |
| UPD_M_対応区分 | 登録・更新 |
| DEL_対応区分 | 削除（DELDATA_対応区分へ移動） |

### 5.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 対応区分名 | 必須 | 対応区分名を入力してください。 |
| 2 | 対応区分名 | 最大255文字 | 対応区分名は255文字以内で入力してください。 |

### 5.4 コード採番

新規登録時、対応区分コードの最大値+1を採番

```sql
SELECT ISNULL(MAX(対応区分コード), 0) + 1 AS NewCode
FROM M_対応区分
```

---

## 6. 対応内容項目マスタ保守

### 6.1 テーブル構造（M_対応内容項目）

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| 対応内容コード | int | NO | 主キー（1〜20） |
| 対応内容名 | nvarchar(255) | NO | - |
| 入力日時 | datetime | YES | - |
| 更新日時 | datetime | YES | - |

### 6.2 ストアドプロシージャ

| SP名 | 用途 |
|------|------|
| SEL_M_対応内容項目 | 一覧取得 |
| UPD_M_対応内容項目 | 登録・更新 |
| DEL_対応内容項目 | 削除（DELDATA_対応内容項目へ移動） |

### 6.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 項目コード | 必須 | 項目コードを入力してください。 |
| 2 | 項目コード | 範囲（1〜20） | 項目コードは1〜20の範囲で入力してください。 |
| 3 | 項目コード | 重複チェック | この項目コードは既に使用されています。 |
| 4 | 項目名 | 必須 | 項目名を入力してください。 |
| 5 | 項目名 | 最大255文字 | 項目名は255文字以内で入力してください。 |

### 6.4 コード採番

自動採番なし。ユーザーが1〜20の範囲で手動指定。

---

## 7. Ajax通信仕様

### 7.1 共通エンドポイント

**URL**: `master_ajax.php`  
**Method**: POST

### 7.2 一覧取得

**リクエスト**:

| パラメータ名 | 型 | 必須 | 説明 |
|-------------|-----|------|------|
| action | string | ○ | 'list' |
| master_type | string | ○ | 'product'/'template'/'category'/'content' |
| filter_bumon | int | - | 部門フィルタ（商品・定型文のみ） |
| filter_use | int | - | 使用区分フィルタ（商品のみ） |

**レスポンス**:

```json
{
    "status": "success",
    "data": [
        {
            "code": 1,
            "name": "SILPS",
            "bumon_code": 1,
            "bumon_name": "LPG支援部",
            "use_flag": 1,
            "update_date": "2025/11/25 10:30"
        }
    ]
}
```

### 7.3 保存（登録・更新）

**リクエスト**:

| パラメータ名 | 型 | 必須 | 説明 |
|-------------|-----|------|------|
| action | string | ○ | 'save' |
| master_type | string | ○ | マスタ種別 |
| mode | string | ○ | 'new' or 'edit' |
| code | int | △ | 編集時必須（主キー） |
| bumon_code | int | △ | 商品・定型文の場合 |
| name | string | ○ | 名称 |
| use_flag | int | △ | 商品の場合（使用区分） |
| text | string | △ | 定型文の場合（本文） |

**レスポンス（成功）**:

```json
{
    "status": "success",
    "message": "保存しました。",
    "code": 5
}
```

**レスポンス（エラー）**:

```json
{
    "status": "error",
    "message": "保存に失敗しました。",
    "errors": [
        "商品名を入力してください。"
    ]
}
```

### 7.4 削除

**リクエスト**:

| パラメータ名 | 型 | 必須 | 説明 |
|-------------|-----|------|------|
| action | string | ○ | 'delete' |
| master_type | string | ○ | マスタ種別 |
| code | int | ○ | 削除対象コード |
| bumon_code | int | △ | 商品・定型文の場合 |

**レスポンス**:

```json
{
    "status": "success",
    "message": "削除しました。"
}
```

---

## 8. PHP実装

### 8.1 メイン処理（master_ajax.php）

```php
<?php
require_once("includes/config.php");
require_once("includes/auth.php");
require_once("includes/functions.php");
require_once("includes/error.php");

// ログインチェック
checkSessionForAjax();

// パラメータ取得
$action = isset($_POST['action']) ? chkSunitize($_POST['action']) : '';
$master_type = isset($_POST['master_type']) ? chkSunitize($_POST['master_type']) : '';

// 処理分岐
switch ($action) {
    case 'list':
        $result = getMasterList($master_type, $_POST);
        break;
    case 'save':
        $result = saveMaster($master_type, $_POST);
        break;
    case 'delete':
        $result = deleteMaster($master_type, $_POST);
        break;
    default:
        $result = array('status' => 'error', 'message' => '不正なリクエストです。');
}

// JSON出力
header('Content-Type: application/json; charset=utf-8');
echo json_encode($result);
```

### 8.2 一覧取得

```php
function getMasterList($master_type, $params) {
    global $pdo_conn;
    
    try {
        switch ($master_type) {
            case 'product':
                $sql = "EXEC SEL_M_商品";
                // フィルタ追加
                break;
            case 'template':
                $sql = "EXEC SEL_M_定型文";
                break;
            case 'category':
                $sql = "EXEC SEL_M_対応区分";
                break;
            case 'content':
                $sql = "EXEC SEL_M_対応内容項目";
                break;
            default:
                return array('status' => 'error', 'message' => '不正なマスタ種別です。');
        }
        
        $stmt = $pdo_conn->query($sql);
        $data = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        return array('status' => 'success', 'data' => $data);
        
    } catch (PDOException $e) {
        return array('status' => 'error', 'message' => 'データベースエラーが発生しました。');
    }
}
```

---

## 9. エラーハンドリング

### 9.1 エラーコード

| コード | メッセージ |
|--------|-----------|
| MASTER_001 | セッションが切れました。 |
| MASTER_002 | 不正なリクエストです。 |
| MASTER_003 | 不正なマスタ種別です。 |
| MASTER_004 | データの保存に失敗しました。 |
| MASTER_005 | データの削除に失敗しました。 |
| MASTER_006 | 指定されたデータが見つかりません。 |
| MASTER_010 | データベースエラーが発生しました。 |

---

## 10. 備考

### 10.1 削除処理について

- 物理削除ではなく、DELDATA_*テーブルへの移動
- 移動先に削除日時カラムを追加
- 復元機能は将来検討

### 10.2 テスト観点

- 新規登録：必須項目入力、保存成功
- 新規登録：バリデーションエラー各パターン
- 編集：既存データ選択、変更保存
- 削除：確認ダイアログ、削除成功
- セッション：未ログイン時のアクセス拒否
- フィルタ：部門フィルタ、使用区分フィルタ

---

**作成者**: Claude AI  
**レビュー**: Phase 03完了時  
**改訂履歴**:
- v1.0 (2025-11-25): 初版作成
- v1.1 (2025-12-11): 権限制御撤廃（ログインユーザー全員利用可能に変更）
