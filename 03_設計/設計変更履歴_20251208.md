# 設計変更履歴 - 2025年12月8日

**変更日**: 2025-12-08  
**変更理由**: SQL_顧客テーブルとのJOINキー仕様の明確化・修正

---

## 1. 変更概要

D_作業報告テーブルとSQL_顧客テーブルの結合キーについて、正しい仕様を明確化し、設計ドキュメントを修正しました。

### 重要な修正点

| 項目 | 誤った記載 | 正しい仕様 |
|------|-----------|-----------|
| JOINキー | D_作業報告.顧客コード = SQL_顧客.顧客コード | **D_作業報告.顧客コード = SQL_顧客.SEQNO** |

**注意**: SQL_顧客テーブルには「顧客コード」カラムが存在しますが、これは検索用のカラムであり、D_作業報告との結合には使用しません。

---

## 2. 改修対象設計書

以下の設計書を改修しました：

### 2.1 02_分析/テーブル定義書.md (v1.0 → v1.1)

**改修内容**:
- D_作業報告テーブルのカラム説明に結合キー情報を追記
  - 顧客コード: `（※SQL_顧客.seqと結合）`
  - 部門コード: `（※SQL_部門.部門コードと結合）`
  - 作業担当コード: `（※SQL_作業担当.担当コードと結合）`
  - 引継担当コード: `（※SQL_作業担当.担当コードと結合）`
- セクション4「外部システム連携用テーブル」を詳細化
  - SQL_顧客の主キー、結合条件、主要カラムを明記
  - SQL_作業担当、SQL_部門も同様に詳細化
- セクション6「テーブル関連図」を改善
  - 視覚的に分かりやすい形式に変更
  - 外部マスタ（CEWEB）と内部テーブル（SUPPORTDB）を区別
- セクション6.1「テーブル間リレーション定義（キー対応表）」を新規追加

### 2.2 03_設計/DB詳細設計書.md (v1.1 → v1.2)

**改修内容**:
- セクション4.1.4「JOINの注意事項」を修正
  - 誤: `D_作業報告.顧客コード と SQL_顧客.顧客コード でJOINする`
  - 正: `D_作業報告.顧客コード = SQL_顧客.SEQNO でJOINする`
  - 正しいJOIN例のSQLを追加
- セクション5「テーブル関連図」を修正
  - SQL_顧客の主キー表記を修正（顧客コード → SEQNO）
  - JOINキーの説明コメントを追加

### 2.3 03_設計/data_flow.md (v1.1 → v1.2)

**改修内容**:
- セクション5.4「D4: 参照テーブル」にJOINキー列を追加
  - SQL_顧客: `D_作業報告.顧客コード = SQL_顧客.SEQNO`
  - SQL_作業担当: `D_作業報告.作業担当コード = SQL_作業担当.担当者コード`
  - SQL_部門: `D_作業報告.部門コード = SQL_部門.部門コード`

### 2.4 03_設計/機能設計書/search.md (v1.0 → v1.1)

**改修内容**:
- セクション4.1「基本検索SQL」のJOIN句を修正
  - 誤: `LEFT JOIN SQL_顧客 C ON D.顧客コード = C.顧客コード`
  - 正: `LEFT JOIN SQL_顧客 C ON D.顧客コード = C.SEQNO`
  - コメント追加: `-- ※重要: SQL_顧客.SEQNOと結合`
- セクション4.3「件数取得SQL」のJOIN句を同様に修正

### 2.5 03_設計/機能設計書/crud.md (v1.0 → v1.1)

**改修内容**:
- セクション4.2「取得SQL」のJOIN句を修正
  - 誤: `LEFT JOIN SQL_顧客 C ON D.顧客コード = C.顧客コード`
  - 正: `LEFT JOIN SQL_顧客 C ON D.顧客コード = C.SEQNO`
  - コメント追加: `-- ※重要: SQL_顧客.SEQNOと結合`

---

## 3. 影響範囲

### 3.1 影響を受けるプログラム

以下のプログラムで、SQL_顧客との結合処理を確認・修正しました：

| ファイル | 影響内容 | 修正状況 |
|---------|---------|----------|
| support_ajax01.php | 検索SQLのJOIN句 | ✅ 修正済み（SEQNO対応 + 英語エイリアス対応） |
| support_ajax02.php | 顧客検索・バリデーション | ✅ 修正済み（SEQNO対応） |
| export_excel.php | Excel出力SQLのJOIN句 | ✅ 修正済み（SEQNO対応 + 英語エイリアス対応） |

### 3.2 正しいJOIN例

```sql
-- 正しいJOIN
SELECT 
    D.*,
    C.顧客名
FROM D_作業報告 D
LEFT JOIN SQL_顧客 C ON D.顧客コード = C.SEQNO
WHERE D.削除日時 IS NULL;

-- 誤ったJOIN（使用禁止）
-- LEFT JOIN SQL_顧客 C ON D.顧客コード = C.顧客コード  ← これは誤り
```

---

## 4. SQL_顧客テーブルの構造

参考のため、SQL_顧客テーブルの主要カラムを記載：

| カラム名 | データ型 | 説明 | 用途 |
|---------|---------|------|------|
| SEQNO | int | 主キー | **D_作業報告とのJOINに使用** |
| 顧客コード | int | 顧客コード | 検索用（JOINには使用しない） |
| 顧客名 | nvarchar(50) | 顧客名 | 表示用 |

**注意**: カラム名「顧客コード」と「SEQNO」が存在するため混同しやすいが、D_作業報告.顧客コードに格納されているのは**SQL_顧客.SEQNOの値**である。

---

## 5. 今後の注意事項

1. 新規でSQL_顧客を参照するクエリを作成する際は、必ず`SQL_顧客.SEQNO`で結合すること
2. コードレビュー時に、SQL_顧客との結合キーが正しいか確認すること
3. テストデータ作成時に、D_作業報告.顧客コードにはSQL_顧客.SEQNOの値を設定すること

---

**作成者**: Claude AI  
**作成日**: 2025-12-08
