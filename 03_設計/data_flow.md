# サポート報告書WEBシステム データフロー図

**作成日**: 2025-11-25  
**更新日**: 2025-12-08  
**バージョン**: 1.2  
**Phase**: 03

---

## 1. 概要

本資料は、サポート報告書WEBシステムにおけるデータの流れを図示したものです。

---

## 2. コンテキスト図（レベル0）

```
                              ┌─────────────────────────────────────────┐
                              │                                         │
    ┌─────────┐               │     サポート報告書WEBシステム           │
    │         │──────────────→│                                         │
    │ ユーザー │  ログイン要求  │                                         │
    │ (担当者) │←──────────────│                                         │
    │         │  認証結果     │                                         │
    │         │               │                                         │
    │         │──────────────→│                                         │
    │         │  報告書登録   │                                         │
    │         │←──────────────│                                         │
    │         │  登録結果     │                                         │
    │         │               │                                         │
    │         │──────────────→│                                         │
    │         │  検索要求     │                                         │
    │         │←──────────────│                                         │
    │         │  検索結果     │                                         │
    └─────────┘               │                                         │
                              │                                         │
                              │                                         │
    ┌─────────┐               │                                         │
    │         │──────────────→│                                         │
    │ 管理者  │  マスタ更新   │                                         │
    │         │←──────────────│                                         │
    │         │  更新結果     │                                         │
    └─────────┘               │                                         │
                              │                                         │
                              └────────────────┬────────────────────────┘
                                               │
                                               │
                              ┌────────────────┴────────────────────────┐
                              │                                         │
                              │           SQL Server                    │
                              │          (SUPPORTDB)                    │
                              │                                         │
                              └─────────────────────────────────────────┘
```

---

## 3. レベル1 DFD（主要プロセス）

```
┌─────────┐
│         │
│ ユーザー │
│         │
└────┬────┘
     │
     │ ID/PW
     ↓
┌─────────────────┐           ┌─────────────────┐
│  1.0            │  認証情報  │                 │
│  ログイン処理   │←──────────│  D1: 担当者     │
│                 │           │                 │
└────────┬────────┘           └─────────────────┘
         │
         │ セッション
         ↓
┌─────────────────┐           ┌─────────────────┐
│  2.0            │  報告書   │                 │
│  報告書検索     │←──────────│  D2: 作業報告   │
│                 │           │                 │
└────────┬────────┘           └────────┬────────┘
         │                             │
         │ 検索結果                     │
         ↓                             │
┌─────────────────┐                   │
│  3.0            │ 登録/更新データ   │
│  報告書登録/更新│──────────────────→│
│                 │                   │
└────────┬────────┘                   │
         │                             │
         │ 削除要求                     │
         ↓                             │
┌─────────────────┐                   │
│  4.0            │ 削除フラグ更新    │
│  報告書削除     │──────────────────→│
│                 │                   │
└─────────────────┘           ┌───────┴─────────┐
                              │                 │
                              │  D3: マスタ     │
┌─────────┐                   │  ・商品         │
│         │  マスタ更新       │  ・定型文       │
│ 管理者  │──────────────────→│  ・対応区分     │
│         │←──────────────────│  ・対応内容項目 │
└─────────┘  マスタデータ     │                 │
                              └─────────────────┘
```

---

## 4. レベル2 DFD（プロセス詳細）

### 4.1 ログイン処理（1.0）

```
┌─────────┐
│ ユーザー │
└────┬────┘
     │ ID/PW
     ↓
┌─────────────────┐
│  1.1            │
│  入力値検証     │
│                 │
└────────┬────────┘
         │ 検証済みID/PW
         ↓
┌─────────────────┐           ┌─────────────────┐
│  1.2            │  担当者   │                 │
│  認証処理       │←──────────│  SQL_作業担当   │
│                 │           │                 │
└────────┬────────┘           └─────────────────┘
         │
    ┌────┴────┐
    │         │
  成功      失敗
    │         │
    ↓         ↓
┌─────────┐ ┌─────────┐
│  1.3    │ │  1.4    │
│セッション│ │エラー   │
│開始     │ │表示     │
└────┬────┘ └─────────┘
     │
     ↓
┌─────────┐
│メイン画面│
└─────────┘
```

### 4.2 報告書検索（2.0）

```
┌─────────┐
│ ユーザー │
└────┬────┘
     │ 検索条件
     ↓
┌─────────────────┐
│  2.1            │
│  条件検証       │
│                 │
└────────┬────────┘
         │ 検証済み条件
         ↓
┌─────────────────┐
│  2.2            │
│  SQL構築        │
│                 │
└────────┬────────┘
         │ SQL
         ↓
┌─────────────────┐           ┌─────────────────┐
│  2.3            │  データ   │                 │
│  データ取得     │←──────────│  D_作業報告     │
│                 │           │                 │
└────────┬────────┘           └─────────────────┘
         │
         ↓
┌─────────────────┐           ┌─────────────────┐
│  2.4            │  名称    │                 │
│  マスタ結合     │←──────────│  各マスタ       │
│                 │           │                 │
└────────┬────────┘           └─────────────────┘
         │
         ↓
┌─────────────────┐
│  2.5            │
│  JSON変換       │
│                 │
└────────┬────────┘
         │ JSON
         ↓
┌─────────┐
│ 一覧表示 │
└─────────┘
```

### 4.3 報告書登録/更新（3.0）

```
┌─────────┐
│ ユーザー │
└────┬────┘
     │ 入力データ
     ↓
┌─────────────────┐
│  3.1            │
│  入力値検証     │
│  （クライアント）│
└────────┬────────┘
         │ 検証済みデータ
         ↓
┌─────────────────┐
│  3.2            │
│  入力値検証     │
│  （サーバー）   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   OK        NG
    │         │
    ↓         ↓
┌─────────┐ ┌─────────┐
│  3.3    │ │エラー   │
│モード判定│ │返却     │
└────┬────┘ └─────────┘
     │
┌────┴────┐
│         │
新規      更新
│         │
↓         ↓
┌─────────┐ ┌─────────┐
│  3.4    │ │  3.5    │
│SEQNO採番│ │更新処理 │
└────┬────┘ └────┬────┘
     │            │
     └────┬───────┘
          │
          ↓
┌─────────────────┐           ┌─────────────────┐
│  3.6            │  INSERT/  │                 │
│  DB書込み       │──────────→│  D_作業報告     │
│                 │  UPDATE   │                 │
└────────┬────────┘           └─────────────────┘
         │
         ↓
┌─────────┐
│ 成功応答 │
└─────────┘
```

### 4.4 報告書削除（4.0）

```
┌─────────┐
│ ユーザー │
└────┬────┘
     │ 削除要求（SEQNO）
     ↓
┌─────────────────┐
│  4.1            │
│  存在確認       │
│                 │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
  存在     存在しない
    │         │
    ↓         ↓
┌─────────┐ ┌─────────┐
│  4.2    │ │エラー   │
│権限確認 │ │返却     │
└────┬────┘ └─────────┘
     │
    ┌┴┐
    │ │
  OK NG
    │ │
    ↓ ↓
┌─────────┐ ┌─────────┐
│  4.3    │ │エラー   │
│論理削除 │ │返却     │
└────┬────┘ └─────────┘
     │
     ↓
┌─────────────────┐           ┌─────────────────┐
│  4.4            │削除日時   │                 │
│  削除日時更新   │──────────→│  D_作業報告     │
│                 │  UPDATE   │                 │
└────────┬────────┘           └─────────────────┘
         │
         ↓
┌─────────┐
│ 成功応答 │
└─────────┘
```

---

## 5. データストア定義

### 5.1 D1: 担当者（SQL_作業担当）

> **変更 (2025-12-04)**: DEV-SE02\SQL22 / SUPPORTDB内のローカルテーブルに変更

| 項目 | 説明 |
|------|------|
| 主キー | 担当者コード |
| 主要カラム | 担当者名、部門コード、パスワード、更新日 |
| 用途 | ログイン認証、担当者選択 |
| 外部キー | 部門コード → SQL_部門.部門コード |

### 5.2 D2: 作業報告（D_作業報告）

| 項目 | 説明 |
|------|------|
| 主キー | SEQNO |
| 主要カラム | 顧客コード、対応日時、報告内容、対応内容フラグ1-20 |
| 用途 | サポート報告書データ |

### 5.3 D3: マスタ

| テーブル | 主キー | 用途 |
|---------|--------|------|
| M_商品 | 商品コード | 商品選択 |
| M_定型文 | 部門コード、定型文コード | 定型文選択 |
| M_対応区分 | 対応区分コード | 区分選択 |
| M_対応内容項目 | 項目コード | チェックボックス表示 |

### 5.4 D4: 参照テーブル

> **変更 (2025-12-04)**: 外部リンクテーブルからSUPPORTDB内のローカルテーブルに変更

| テーブル | 主キー | 用途 | JOINキー |
|---------|--------|------|----------|
| SQL_顧客 | SEQNO | 顧客情報参照 | D_作業報告.顧客コード = SQL_顧客.SEQNO |
| SQL_作業担当 | 担当者コード | 担当者情報参照・認証 | D_作業報告.作業担当コード = SQL_作業担当.担当者コード |
| SQL_部門 | 部門コード | 部門情報参照 | D_作業報告.部門コード = SQL_部門.部門コード |

---

## 6. プロセス-データストア対応表

| プロセス | 読込 | 書込 |
|---------|------|------|
| 1.0 ログイン | SQL_作業担当 | - |
| 2.0 検索 | D_作業報告, 各マスタ | - |
| 3.0 登録/更新 | D_作業報告, 各マスタ | D_作業報告, SYS_SEQNO |
| 4.0 削除 | D_作業報告 | D_作業報告 |
| 5.0 マスタ保守 | 各マスタ, 各DELDATA | 各マスタ, 各DELDATA |

---

## 7. 外部エンティティ

| エンティティ | 説明 |
|-------------|------|
| ユーザー（担当者） | サポート報告書を入力・閲覧する担当者 |
| 管理者 | マスタ保守権限を持つ担当者 |
| SQL Server | データベースサーバー |

---

## 8. データフロー一覧

| フロー名 | 送信元 | 送信先 | データ内容 |
|---------|--------|--------|-----------|
| ログイン要求 | ユーザー | ログイン処理 | ID, パスワード |
| 認証情報 | 担当者テーブル | ログイン処理 | 担当者情報 |
| セッション | ログイン処理 | 各画面 | ログイン情報 |
| 検索条件 | ユーザー | 検索処理 | 検索パラメータ |
| 検索結果 | 検索処理 | ユーザー | 報告書一覧（JSON） |
| 入力データ | ユーザー | 登録/更新処理 | 報告書データ |
| 削除要求 | ユーザー | 削除処理 | SEQNO |
| マスタデータ | 管理者 | マスタ保守処理 | マスタ情報 |

---

**作成者**: Claude AI  
**レビュー**: Phase 03完了時  
**改訂履歴**:
- v1.0 (2025-11-25): 初版作成
- v1.1 (2025-12-04): SQL_顧客、SQL_作業担当、SQL_部門のデータストア定義をローカルテーブルとして追加
- v1.2 (2025-12-08): 参照テーブルのJOINキー情報を追加（SQL_顧客.SEQNOと結合することを明記）
