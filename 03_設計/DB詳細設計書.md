# サポート報告書WEBシステム DB詳細設計書

**作成日**: 2025-11-25  
**更新日**: 2025-12-08  
**バージョン**: 1.2  
**Phase**: 04

---

## 1. 概要

本資料は、サポート報告書WEBシステムで使用するデータベースの詳細設計を定義したものです。
既存のSQL ServerデータベースをWEB版でも継続使用するため、現行仕様の整理と必要な改修点を記載します。

---

## 2. データベース基本情報

| 項目 | 値 |
|------|-----|
| データベース名 | SUPPORTDB |
| サーバー | dev-se02\SQL22 |
| 接続方式 | PDO（SQL Server Native Client） |
| 文字コード | UTF-8 |
| 照合順序 | Japanese_CI_AS |
| 復旧モデル | SIMPLE |

### 2.1 接続文字列

```php
// inc.php での接続設定
$dsn = "sqlsrv:Server=dev-se02\\SQL22;Database=SUPPORTDB";
$options = array(
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::SQLSRV_ATTR_ENCODING => PDO::SQLSRV_ENCODING_UTF8,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
);
$pdo_conn = new PDO($dsn, $username, $password, $options);
```

---

## 3. テーブル詳細定義

### 3.1 D_作業報告（メインデータテーブル）

#### 3.1.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | D_作業報告 |
| 種別 | データテーブル |
| 用途 | サポート報告書のメインデータを格納 |
| 主キー | SEQNO, 入力マシン（複合主キー） |

#### 3.1.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | デフォルト | 説明 |
|----|---------|---------|-------|------|-----|-----------|------|
| 1 | SEQNO | bigint | 8 | NOT NULL | ○ | - | シーケンス番号 |
| 2 | 対応開始日時 | datetime | 8 | NOT NULL | - | - | 対応開始日時 |
| 3 | 対応終了日時 | datetime | 8 | NULL | - | NULL | 対応終了日時 |
| 4 | 顧客コード | bigint | 8 | NULL | - | NULL | 顧客マスタのコード |
| 5 | 顧客担当者名 | varchar | 50 | NULL | - | NULL | 顧客側の担当者名 |
| 6 | 部門コード | bigint | 8 | NULL | - | NULL | 対応部門のコード |
| 7 | 商品コード1 | bigint | 8 | NULL | - | NULL | 対象商品1 |
| 8 | 商品コード2 | bigint | 8 | NULL | - | NULL | 対象商品2 |
| 9 | 商品コード3 | bigint | 8 | NULL | - | NULL | 対象商品3 |
| 10 | 作業担当コード | bigint | 8 | NULL | - | NULL | 対応担当者コード |
| 11 | 対応区分コード | bigint | 8 | NULL | - | NULL | 対応区分コード |
| 12 | 結果コード | bigint | 8 | NULL | - | NULL | 対応結果コード |
| 13 | 引継担当コード | bigint | 8 | NULL | - | NULL | 引継先担当者コード |
| 14 | 報告内容 | varchar | MAX | NULL | - | NULL | 対応内容詳細 |
| 15 | お客様サイン | varchar | 50 | NULL | - | NULL | 顧客確認サイン |
| 16 | 確認日付 | datetime | 8 | NULL | - | NULL | 顧客確認日 |
| 17 | 作成日時 | datetime | 8 | NULL | - | GETDATE() | レコード作成日時 |
| 18 | 同期日時 | datetime | 8 | NULL | - | NULL | サーバー同期日時 |
| 19 | 更新日時 | datetime | 8 | NULL | - | NULL | レコード更新日時 |
| 20 | 削除日時 | datetime | 8 | NULL | - | NULL | 論理削除日時 |
| 21 | 入力マシン | varchar | 50 | NOT NULL | ○ | - | 入力元識別子 |
| 22 | 更新マシン | varchar | 50 | NULL | - | NULL | 更新元識別子 |
| 23 | ネットワークFLG | int | 4 | NULL | - | 0 | ネットワーク接続状態 |
| 24 | 対応内容項目名1 | varchar | 50 | NULL | - | NULL | 動的項目名1 |
| 25 | 対応内容項目名2 | varchar | 50 | NULL | - | NULL | 動的項目名2 |
| 26 | 対応内容項目名3 | varchar | 50 | NULL | - | NULL | 動的項目名3 |
| 27 | 対応内容項目名4 | varchar | 50 | NULL | - | NULL | 動的項目名4 |
| 28 | 対応内容項目名5 | varchar | 50 | NULL | - | NULL | 動的項目名5 |
| 29 | 対応内容項目名6 | varchar | 50 | NULL | - | NULL | 動的項目名6 |
| 30 | 対応内容項目名7 | varchar | 50 | NULL | - | NULL | 動的項目名7 |
| 31 | 対応内容項目名8 | varchar | 50 | NULL | - | NULL | 動的項目名8 |
| 32 | 対応内容項目名9 | varchar | 50 | NULL | - | NULL | 動的項目名9 |
| 33 | 対応内容項目名10 | varchar | 50 | NULL | - | NULL | 動的項目名10 |
| 34 | 対応内容項目名11 | varchar | 50 | NULL | - | NULL | 動的項目名11 |
| 35 | 対応内容項目名12 | varchar | 50 | NULL | - | NULL | 動的項目名12 |
| 36 | 対応内容項目名13 | varchar | 50 | NULL | - | NULL | 動的項目名13 |
| 37 | 対応内容項目名14 | varchar | 50 | NULL | - | NULL | 動的項目名14 |
| 38 | 対応内容項目名15 | varchar | 50 | NULL | - | NULL | 動的項目名15 |
| 39 | 対応内容項目名16 | varchar | 50 | NULL | - | NULL | 動的項目名16 |
| 40 | 対応内容項目名17 | varchar | 50 | NULL | - | NULL | 動的項目名17 |
| 41 | 対応内容項目名18 | varchar | 50 | NULL | - | NULL | 動的項目名18 |
| 42 | 対応内容項目名19 | varchar | 50 | NULL | - | NULL | 動的項目名19 |
| 43 | 対応内容項目名20 | varchar | 50 | NULL | - | NULL | 動的項目名20 |
| 44 | 対応内容フラグ1 | int | 4 | NULL | - | 0 | チェック状態1 |
| 45 | 対応内容フラグ2 | int | 4 | NULL | - | 0 | チェック状態2 |
| 46 | 対応内容フラグ3 | int | 4 | NULL | - | 0 | チェック状態3 |
| 47 | 対応内容フラグ4 | int | 4 | NULL | - | 0 | チェック状態4 |
| 48 | 対応内容フラグ5 | int | 4 | NULL | - | 0 | チェック状態5 |
| 49 | 対応内容フラグ6 | int | 4 | NULL | - | 0 | チェック状態6 |
| 50 | 対応内容フラグ7 | int | 4 | NULL | - | 0 | チェック状態7 |
| 51 | 対応内容フラグ8 | int | 4 | NULL | - | 0 | チェック状態8 |
| 52 | 対応内容フラグ9 | int | 4 | NULL | - | 0 | チェック状態9 |
| 53 | 対応内容フラグ10 | int | 4 | NULL | - | 0 | チェック状態10 |
| 54 | 対応内容フラグ11 | int | 4 | NULL | - | 0 | チェック状態11 |
| 55 | 対応内容フラグ12 | int | 4 | NULL | - | 0 | チェック状態12 |
| 56 | 対応内容フラグ13 | int | 4 | NULL | - | 0 | チェック状態13 |
| 57 | 対応内容フラグ14 | int | 4 | NULL | - | 0 | チェック状態14 |
| 58 | 対応内容フラグ15 | int | 4 | NULL | - | 0 | チェック状態15 |
| 59 | 対応内容フラグ16 | int | 4 | NULL | - | 0 | チェック状態16 |
| 60 | 対応内容フラグ17 | int | 4 | NULL | - | 0 | チェック状態17 |
| 61 | 対応内容フラグ18 | int | 4 | NULL | - | 0 | チェック状態18 |
| 62 | 対応内容フラグ19 | int | 4 | NULL | - | 0 | チェック状態19 |
| 63 | 対応内容フラグ20 | int | 4 | NULL | - | 0 | チェック状態20 |

#### 3.1.3 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK_D_作業報告 | SEQNO, 入力マシン | CLUSTERED | 主キー |
| IX_D_作業報告_SEQNO | SEQNO | NON-CLUSTERED | SEQNO単独検索用 |
| IX_D_作業報告_対応開始日時 | 対応開始日時 | NON-CLUSTERED | 日付検索用（推奨追加） |
| IX_D_作業報告_作業担当コード | 作業担当コード | NON-CLUSTERED | 担当者検索用（推奨追加） |
| IX_D_作業報告_顧客コード | 顧客コード | NON-CLUSTERED | 顧客検索用（推奨追加） |

#### 3.1.4 WEB化時の対応方針

| 項目 | 対応方針 |
|------|---------|
| 入力マシン | WEB版では固定値「WEB」を設定 |
| 更新マシン | WEB版では固定値「WEB」を設定 |
| ネットワークFLG | WEB版では常に1（オンライン）を設定 |
| 同期日時 | WEB版では使用しない（NULL） |

---

### 3.2 M_商品（商品マスタ）

#### 3.2.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | M_商品 |
| 種別 | マスタテーブル |
| 用途 | 取り扱い商品の情報を管理 |
| 主キー | 商品コード |

#### 3.2.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | デフォルト | 説明 |
|----|---------|---------|-------|------|-----|-----------|------|
| 1 | 商品コード | bigint | 8 | NOT NULL | ○ | - | 商品一意コード |
| 2 | 部門コード | bigint | 8 | NULL | - | NULL | 管理部門コード |
| 3 | 商品名 | nvarchar | 255 | NULL | - | NULL | 商品名称 |
| 4 | 使用区分 | bigint | 8 | NULL | - | 1 | 使用状態 |
| 5 | 更新日時 | datetime | 8 | NULL | - | GETDATE() | 最終更新日時 |
| 6 | 入力マシン | nvarchar | 255 | NULL | - | NULL | 入力元識別子 |

#### 3.2.3 使用区分の値定義

| 値 | 意味 |
|-----|------|
| 0 | 未使用（非表示） |
| 1 | 使用中（表示） |

#### 3.2.4 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK_M_商品 | 商品コード | CLUSTERED | 主キー |
| IX_M_商品_部門コード | 部門コード | NON-CLUSTERED | 部門絞り込み用 |

---

### 3.3 M_対応区分（対応区分マスタ）

#### 3.3.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | M_対応区分 |
| 種別 | マスタテーブル |
| 用途 | 問い合わせ種別を分類 |
| 主キー | 対応区分コード |

#### 3.3.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | デフォルト | 説明 |
|----|---------|---------|-------|------|-----|-----------|------|
| 1 | 対応区分コード | bigint | 8 | NOT NULL | ○ | - | 区分一意コード |
| 2 | 対応区分名 | nvarchar | 255 | NULL | - | NULL | 区分名称 |
| 3 | 更新日時 | datetime | 8 | NULL | - | GETDATE() | 最終更新日時 |
| 4 | 入力マシン | nvarchar | 255 | NULL | - | NULL | 入力元識別子 |

#### 3.3.3 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK_M_対応区分 | 対応区分コード | CLUSTERED | 主キー |

---

### 3.4 M_対応内容項目（対応内容項目マスタ）

#### 3.4.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | M_対応内容項目 |
| 種別 | マスタテーブル |
| 用途 | チェックボックス項目を動的に定義 |
| 主キー | 項目コード |

#### 3.4.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | デフォルト | 説明 |
|----|---------|---------|-------|------|-----|-----------|------|
| 1 | 項目コード | bigint | 8 | NOT NULL | ○ | - | 項目一意コード（1〜20） |
| 2 | 項目名 | nvarchar | 255 | NULL | - | NULL | 項目名称 |
| 3 | 更新日時 | datetime | 8 | NULL | - | GETDATE() | 最終更新日時 |
| 4 | 入力マシン | nvarchar | 255 | NULL | - | NULL | 入力元識別子 |

#### 3.4.3 制約事項

- 項目コードは1〜20の範囲のみ有効
- D_作業報告の対応内容フラグ1〜20と連動

#### 3.4.4 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK_M_対応内容項目 | 項目コード | CLUSTERED | 主キー |

---

### 3.5 M_定型文（定型文マスタ）

#### 3.5.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | M_定型文 |
| 種別 | マスタテーブル |
| 用途 | 報告内容のテンプレートを管理 |
| 主キー | 部門コード, 定型文コード（複合） |

#### 3.5.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | デフォルト | 説明 |
|----|---------|---------|-------|------|-----|-----------|------|
| 1 | 部門コード | bigint | 8 | NOT NULL | ○ | - | 部門コード |
| 2 | 定型文コード | bigint | 8 | NOT NULL | ○ | - | 定型文連番 |
| 3 | 定型文 | nvarchar | MAX | NULL | - | NULL | 定型文内容 |
| 4 | 作成日時 | datetime | 8 | NULL | - | GETDATE() | 作成日時 |
| 5 | 作成者コード | bigint | 8 | NULL | - | NULL | 作成者担当者コード |
| 6 | 更新日時 | datetime | 8 | NULL | - | NULL | 最終更新日時 |
| 7 | 更新者コード | bigint | 8 | NULL | - | NULL | 更新者担当者コード |

#### 3.5.3 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK_M_定型文 | 部門コード, 定型文コード | CLUSTERED | 主キー |

---

### 3.6 SYS_SEQNO（シーケンス番号管理）

#### 3.6.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | SYS_SEQNO |
| 種別 | システムテーブル |
| 用途 | D_作業報告のSEQNO採番 |
| 主キー | なし（単一行） |

#### 3.6.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | デフォルト | 説明 |
|----|---------|---------|-------|------|-----------|------|
| 1 | SEQNO | bigint | 8 | NULL | 0 | 現在のシーケンス番号 |
| 2 | COUNTVAL | bigint | 8 | NULL | 1 | 増分値 |

#### 3.6.3 採番ロジック

```sql
-- COUNTUP_SYS_SEQNO ストアドプロシージャ内
UPDATE SYS_SEQNO SET SEQNO = SEQNO + COUNTVAL;
SELECT SEQNO FROM SYS_SEQNO;
```

---

### 3.7 削除履歴テーブル（DELDATA_*）

#### 3.7.1 DELDATA_商品

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 商品コード | bigint | 8 | NULL | 商品コード |
| 2 | 部門コード | bigint | 8 | NULL | 部門コード |
| 3 | 商品名 | nvarchar | 255 | NULL | 商品名 |
| 4 | 使用区分 | bigint | 8 | NULL | 使用区分 |
| 5 | 更新日時 | datetime | 8 | NULL | 更新日時 |
| 6 | 入力マシン | nvarchar | 255 | NULL | 入力マシン |
| 7 | 削除日時 | datetime | 8 | NULL | 削除実行日時 |

#### 3.7.2 DELDATA_対応区分

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 対応区分コード | bigint | 8 | NULL | 区分コード |
| 2 | 対応区分名 | nvarchar | 255 | NULL | 区分名 |
| 3 | 更新日時 | datetime | 8 | NULL | 更新日時 |
| 4 | 入力マシン | nvarchar | 255 | NULL | 入力マシン |
| 5 | 削除日時 | datetime | 8 | NULL | 削除実行日時 |

#### 3.7.3 DELDATA_対応内容項目

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 項目コード | bigint | 8 | NULL | 項目コード |
| 2 | 項目名 | nvarchar | 255 | NULL | 項目名 |
| 3 | 更新日時 | datetime | 8 | NULL | 更新日時 |
| 4 | 入力マシン | nvarchar | 255 | NULL | 入力マシン |
| 5 | 削除日時 | datetime | 8 | NULL | 削除実行日時 |

#### 3.7.4 DELDATA_定型文

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 部門コード | bigint | 8 | NULL | 部門コード |
| 2 | 定型文コード | bigint | 8 | NULL | 定型文コード |
| 3 | 定型文 | nvarchar | MAX | NULL | 定型文内容 |
| 4 | 作成日時 | datetime | 8 | NULL | 作成日時 |
| 5 | 作成者コード | bigint | 8 | NULL | 作成者コード |
| 6 | 更新日時 | datetime | 8 | NULL | 更新日時 |
| 7 | 更新者コード | bigint | 8 | NULL | 更新者コード |
| 8 | 削除日時 | datetime | 8 | NULL | 削除実行日時 |

---

## 4. 参照テーブル（ローカルテーブル）

> **重要変更 (2025-12-04)**
> 旧システムでは外部サーバーからリンクテーブルとして参照していた SQL_顧客、SQL_作業担当、SQL_部門 は、
> 新システムでは DEV-SE02\SQL22 / SUPPORTDB 内にローカルテーブルとして構築し、直接参照する方式に変更されました。

### 4.1 SQL_顧客

#### 4.1.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | SQL_顧客 |
| 種別 | ローカルテーブル（SUPPORTDB内） |
| 用途 | 顧客情報の参照 |
| 主キー | SEQNO |
| データベース | DEV-SE02\SQL22 / SUPPORTDB |

#### 4.1.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | 説明 |
|----|---------|---------|-------|------|-----|------|
| 1 | SEQNO | int | 4 | NOT NULL | ○ | シーケンス番号（主キー） |
| 2 | PARENT_SEQ | int | 4 | NULL | - | 親シーケンス番号 |
| 3 | 顧客コード | int | 4 | NULL | - | 顧客コード（検索用） |
| 4 | 部門コード | int | 4 | NULL | - | 部門コード |
| 5 | 顧客名 | nvarchar | 50 | NULL | - | 顧客名 |
| 6 | 顧客名カナ | nvarchar | 50 | NULL | - | 顧客名カナ |
| 7 | 顧客略称 | nvarchar | 50 | NULL | - | 顧客略称 |
| 8 | 郵便番号 | nvarchar | 50 | NULL | - | 郵便番号 |
| 9 | 住所 | nvarchar | 50 | NULL | - | 住所 |
| 10 | 電話番号 | nvarchar | 50 | NULL | - | 電話番号 |
| 11 | FAX | nvarchar | 50 | NULL | - | FAX番号 |
| 12 | 更新日 | datetime | 8 | NULL | - | 更新日時 |

#### 4.1.3 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK_SQL_顧客 | SEQNO | CLUSTERED | 主キー |
| IX_SQL_顧客_顧客コード | 顧客コード | NON-CLUSTERED | 顧客コード検索用（推奨追加） |

#### 4.1.4 JOINの注意事項

> **重要 (2025-12-08追記)**: JOINキーの正しい結合方法

- **D_作業報告.顧客コード = SQL_顧客.SEQNO でJOINする**
- SQL_顧客.顧客コード は検索用のカラムであり、JOINには使用しない
- 同一顧客コードで複数レコード存在する可能性あり（PARENT_SEQで親子関係管理）

```sql
-- 正しいJOIN例
SELECT D.*, C.顧客名
FROM D_作業報告 D
LEFT JOIN SQL_顧客 C ON D.顧客コード = C.SEQNO
```

---

### 4.2 SQL_作業担当

#### 4.2.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | SQL_作業担当 |
| 種別 | ローカルテーブル（SUPPORTDB内） |
| 用途 | 担当者情報の参照、ログイン認証 |
| 主キー | 担当者コード |
| データベース | DEV-SE02\SQL22 / SUPPORTDB |
| 外部キー | 部門コード → SQL_部門.部門コード |

#### 4.2.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | 説明 |
|----|---------|---------|-------|------|-----|------|
| 1 | 担当者コード | bigint | 8 | NOT NULL | ○ | 担当者一意コード |
| 2 | 部門コード | bigint | 8 | NULL | - | 所属部門コード（FK） |
| 3 | 担当者名 | nvarchar | 255 | NULL | - | 担当者名 |
| 4 | パスワード | nvarchar | 255 | NULL | - | ログインパスワード |
| 5 | 更新日 | datetime | 8 | NULL | - | 更新日時 |

#### 4.2.3 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK__SQL_作業担当__* | 担当者コード | CLUSTERED | 主キー |

#### 4.2.4 外部キー制約

| 制約名 | 参照元カラム | 参照先テーブル | 参照先カラム |
|--------|-------------|---------------|-------------|
| FK_SQL_作業担当_部門 | 部門コード | SQL_部門 | 部門コード |

#### 4.2.5 WEB版認証時の注意事項

- 権限レベルカラムは存在しないため、WEB版では別途管理が必要
- 現行は全ユーザーを同等権限として扱い、将来的に権限管理を追加検討

---

### 4.3 SQL_部門

#### 4.3.1 テーブル情報

| 項目 | 値 |
|------|-----|
| テーブル名 | SQL_部門 |
| 種別 | ローカルテーブル（SUPPORTDB内） |
| 用途 | 部門情報の参照 |
| 主キー | 部門コード |
| データベース | DEV-SE02\SQL22 / SUPPORTDB |

#### 4.3.2 カラム定義

| No | カラム名 | データ型 | サイズ | NULL | PK | 説明 |
|----|---------|---------|-------|------|-----|------|
| 1 | 部門コード | bigint | 8 | NOT NULL | ○ | 部門一意コード |
| 2 | 部門名 | nvarchar | 255 | NULL | - | 部門名称 |
| 3 | 更新日 | datetime | 8 | NULL | - | 更新日時 |

#### 4.3.3 インデックス定義

| インデックス名 | カラム | 種別 | 説明 |
|--------------|--------|------|------|
| PK_SQL_部門 | 部門コード | CLUSTERED | 主キー |

---

## 5. テーブル関連図（詳細版）

```
                                    ┌──────────────────┐
                                    │    SQL_顧客      │
                                    │  ・SEQNO(PK)     │ ← D_作業報告.顧客コードとJOIN
                                    │  ・顧客コード     │ ← 検索用
                                    │  ・顧客名        │
                                    │  ・住所          │
                                    └────────┬─────────┘
                                             │ 1:N
                                             ↓
┌──────────────────┐                ┌──────────────────────────────────────┐
│  SQL_作業担当    │                │            D_作業報告                │
│ ・担当者コード(PK)│←─N:1────────→│  ・SEQNO(PK)                        │
│ ・担当者名       │                │  ・入力マシン(PK)                    │
│ ・部門コード(FK) │                │  ・対応開始日時                      │
│ ・パスワード     │                │  ・顧客コード(FK)                    │
│ ・権限レベル     │                │  ・作業担当コード(FK)                │
└────────┬─────────┘                │  ・商品コード1-3(FK)                 │
         │ N:1                      │  ・対応区分コード(FK)                │
         ↓                          │  ・報告内容                          │
┌──────────────────┐                │  ・対応内容フラグ1-20                │
│    SQL_部門      │                └───────────────┬──────────────────────┘
│  ・部門コード(PK)│                                │
│  ・部門名        │                    ┌───────────┼───────────┬───────────┐
└──────────────────┘                    │           │           │           │
                                        ↓           ↓           ↓           ↓
                               ┌─────────────┐ ┌─────────┐ ┌─────────────┐ ┌─────────┐
                               │   M_商品    │ │M_対応区分│ │M_対応内容項目│ │ M_定型文│
                               │ ・商品コード │ │ ・区分  │ │ ・項目コード │ │(部門別) │
                               │ ・商品名    │ │   コード │ │ ・項目名    │ │         │
                               │ ・部門コード │ │ ・区分名 │ │             │ │         │
                               └─────────────┘ └─────────┘ └─────────────┘ └─────────┘
                                        │           │           │           │
                                        ↓           ↓           ↓           ↓
                               ┌─────────────┐ ┌─────────┐ ┌─────────────┐ ┌─────────┐
                               │DELDATA_商品│ │DELDATA  │ │DELDATA     │ │DELDATA │
                               │            │ │_対応区分│ │_対応内容項目│ │_定型文 │
                               └─────────────┘ └─────────┘ └─────────────┘ └─────────┘

┌──────────────────┐
│   SYS_SEQNO      │ ← SEQNOの採番管理
│  ・SEQNO         │
│  ・COUNTVAL      │
└──────────────────┘
```

---

## 6. データ型マッピング（PHP⇔SQL Server）

| SQL Server型 | PHP型 | PDO定数 | 備考 |
|-------------|-------|---------|------|
| bigint | int/string | PDO::PARAM_INT | 大きな数値はstringで取得 |
| int | int | PDO::PARAM_INT | - |
| datetime | string | PDO::PARAM_STR | Y-m-d H:i:s形式 |
| varchar | string | PDO::PARAM_STR | - |
| nvarchar | string | PDO::PARAM_STR | UTF-8でエンコード |
| varchar(MAX) | string | PDO::PARAM_STR | 長大テキスト |

---

## 7. 推奨インデックス追加

### 7.1 D_作業報告用追加インデックス

```sql
-- 日付範囲検索の高速化
CREATE NONCLUSTERED INDEX [IX_D_作業報告_対応開始日時] 
ON [dbo].[D_作業報告] ([対応開始日時] DESC)
INCLUDE ([顧客コード], [作業担当コード], [対応区分コード]);

-- 担当者別検索の高速化
CREATE NONCLUSTERED INDEX [IX_D_作業報告_作業担当コード] 
ON [dbo].[D_作業報告] ([作業担当コード])
INCLUDE ([対応開始日時], [顧客コード]);

-- 顧客別検索の高速化
CREATE NONCLUSTERED INDEX [IX_D_作業報告_顧客コード] 
ON [dbo].[D_作業報告] ([顧客コード])
INCLUDE ([対応開始日時], [作業担当コード]);

-- 削除データ除外検索用
CREATE NONCLUSTERED INDEX [IX_D_作業報告_削除日時] 
ON [dbo].[D_作業報告] ([削除日時])
WHERE [削除日時] IS NULL;
```

### 7.2 M_商品用追加インデックス

```sql
-- 部門別・使用中のみ検索
CREATE NONCLUSTERED INDEX [IX_M_商品_部門_使用] 
ON [dbo].[M_商品] ([部門コード], [使用区分])
WHERE [使用区分] = 1;
```

---

## 8. トランザクション設計

### 8.1 報告書登録・更新時

```sql
BEGIN TRANSACTION
    -- 1. シーケンス番号採番（新規時のみ）
    EXEC COUNTUP_SYS_SEQNO;
    
    -- 2. データ登録/更新
    EXEC UPD_D_作業報告 @params...;
    
    -- 3. 正常完了時
    COMMIT TRANSACTION;
    
    -- 4. エラー時
    ROLLBACK TRANSACTION;
```

### 8.2 マスタ削除時

```sql
BEGIN TRANSACTION
    -- 1. 削除履歴へコピー
    INSERT INTO DELDATA_商品 SELECT *, GETDATE() FROM M_商品 WHERE 商品コード = @code;
    
    -- 2. マスタから削除
    DELETE FROM M_商品 WHERE 商品コード = @code;
    
    -- 3. 正常完了時
    COMMIT TRANSACTION;
```

---

## 9. バックアップ・リカバリ

### 9.1 バックアップ方針

| 種別 | 頻度 | 保持期間 | 実行時刻 |
|------|------|---------|---------|
| フルバックアップ | 日次 | 7日間 | 22:00 |
| 差分バックアップ | なし | - | - |
| トランザクションログ | なし | - | - |

### 9.2 バックアップSQL

```sql
-- フルバックアップ
BACKUP DATABASE [SUPPORTDB] 
TO DISK = 'D:\Backup\SUPPORTDB_FULL_YYYYMMDD.bak'
WITH FORMAT, COMPRESSION;
```

---

## 10. パフォーマンスチューニング

### 10.1 一覧表示のページング

```sql
-- OFFSET-FETCH方式（SQL Server 2012以降）
SELECT *
FROM D_作業報告
WHERE 削除日時 IS NULL
ORDER BY 対応開始日時 DESC
OFFSET @offset ROWS
FETCH NEXT @limit ROWS ONLY;
```

### 10.2 総件数取得の最適化

```sql
-- 別クエリで取得（インデックスのみで完結）
SELECT COUNT(*)
FROM D_作業報告
WHERE 削除日時 IS NULL;
```

---

**作成者**: Claude AI  
**レビュー**: Phase 04完了時  
**改訂履歴**:
- v1.0 (2025-11-25): 初版作成
- v1.1 (2025-12-04): SQL_顧客、SQL_作業担当、SQL_部門の定義を外部リンクテーブルからローカルテーブルに変更、カラム定義を実際のテーブル定義に準拠して更新
- v1.2 (2025-12-08): SQL_顧客とのJOINキーを修正（顧客コード→SEQNO）、テーブル関連図を更新
