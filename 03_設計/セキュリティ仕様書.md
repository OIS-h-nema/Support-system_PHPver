# サポート報告書WEBシステム セキュリティ仕様書

**作成日**: 2025-11-25  
**バージョン**: 1.0  
**Phase**: 04

---

## 1. 概要

本資料は、サポート報告書WEBシステムで実装するセキュリティ対策の仕様を定義したものです。
社内ネットワーク限定のシステムであるため、必要最小限のセキュリティ対策を実装します。

---

## 2. セキュリティ方針

### 2.1 基本方針

| 項目 | 方針 |
|------|------|
| 対象環境 | 社内ネットワーク限定 |
| セキュリティレベル | 中程度（社内利用のため外部攻撃リスク低） |
| 優先事項 | データ保護、不正操作防止 |

### 2.2 実装対策一覧

| 対策 | 実装 | 備考 |
|------|------|------|
| 認証 | ○ | ID/パスワード認証 |
| 認可 | ○ | 権限レベルによるアクセス制御 |
| XSS対策 | ○ | 出力エスケープ |
| SQLインジェクション対策 | ○ | プリペアドステートメント |
| セッション管理 | ○ | セッション固定攻撃対策含む |
| CSRF対策 | △ | 社内限定のため省略（将来実装可） |
| HTTPS | × | 社内ネットワークのため省略 |
| WAF | × | 社内ネットワークのため省略 |

---

## 3. 認証仕様

### 3.1 認証方式

| 項目 | 仕様 |
|------|------|
| 認証方式 | ID/パスワード認証 |
| ID形式 | 担当者コード（数値） |
| パスワード保存 | データベース（平文）※1 |
| セッション有効期限 | 9時間 |

※1 社内システムのため平文保存。将来的なセキュリティ強化時にハッシュ化を検討。

### 3.2 認証処理フロー

```
[ユーザー] → [login.php] → [SQL_作業担当テーブル照合]
                              │
                              ├── 成功 → セッション生成 → support_main.php
                              │
                              └── 失敗 → エラー表示 → login.php
```

### 3.3 認証コード実装

```php
<?php
/**
 * 認証処理
 */
function authenticate($user_id, $password) {
    global $pdo_conn;
    
    // 入力値バリデーション
    if (empty($user_id) || !is_numeric($user_id)) {
        return false;
    }
    if (empty($password)) {
        return false;
    }
    
    try {
        // 認証クエリ
        $sql = "SELECT 担当者コード, 担当者名, 部門コード, 権限レベル
                FROM SQL_作業担当
                WHERE 担当者コード = ? AND パスワード = ?";
        
        $stmt = $pdo_conn->prepare($sql);
        $stmt->execute(array((int)$user_id, $password));
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($user) {
            // セッション固定攻撃対策
            session_regenerate_id(true);
            
            // セッション設定
            $_SESSION['LOGIN'] = true;
            $_SESSION['USER_ID'] = (int)$user['担当者コード'];
            $_SESSION['USER_NAME'] = $user['担当者名'];
            $_SESSION['BUMON_CODE'] = (int)$user['部門コード'];
            $_SESSION['AUTH_LEVEL'] = (int)$user['権限レベル'];
            $_SESSION['LOGIN_TIME'] = date('Y-m-d H:i:s');
            
            // ログ記録
            logAuth('LOGIN', $user_id, true);
            
            return true;
        }
        
        // 認証失敗ログ
        logAuth('LOGIN', $user_id, false);
        
    } catch (PDOException $e) {
        error_log('Authentication error: ' . $e->getMessage());
    }
    
    return false;
}
```

---

## 4. 認可仕様

### 4.1 権限レベル

| レベル | 名称 | アクセス可能画面 |
|--------|------|----------------|
| 1 | 一般ユーザー | メイン画面、入力ダイアログ |
| 2 | 管理者 | 全画面（マスタ保守含む） |

### 4.2 アクセス制御マトリクス

| 画面/機能 | レベル1 | レベル2 |
|----------|---------|---------|
| ログイン | ○ | ○ |
| メイン画面（一覧表示） | ○ | ○ |
| 検索 | ○ | ○ |
| 報告書新規登録 | ○ | ○ |
| 報告書編集（自分） | ○ | ○ |
| 報告書編集（他者） | × | ○ |
| 報告書削除 | × | ○ |
| 商品マスタ保守 | × | ○ |
| 定型文マスタ保守 | × | ○ |
| 対応区分マスタ保守 | × | ○ |
| 対応内容項目マスタ保守 | × | ○ |

### 4.3 認可チェック実装

```php
<?php
/**
 * ログイン状態チェック
 */
function isLoggedIn() {
    return isset($_SESSION['LOGIN']) && $_SESSION['LOGIN'] === true;
}

/**
 * 管理者権限チェック
 */
function isAdmin() {
    return isLoggedIn() && isset($_SESSION['AUTH_LEVEL']) && $_SESSION['AUTH_LEVEL'] >= 2;
}

/**
 * 編集権限チェック
 * @param int $owner_id データ所有者の担当者コード
 */
function canEdit($owner_id) {
    // 管理者は全て編集可能
    if (isAdmin()) {
        return true;
    }
    // 一般ユーザーは自分のデータのみ
    return $_SESSION['USER_ID'] === (int)$owner_id;
}

/**
 * 削除権限チェック
 */
function canDelete() {
    return isAdmin();
}

/**
 * ページ用権限チェック
 */
function requireLogin() {
    if (!isLoggedIn()) {
        header('Location: login.php?timeout=1');
        exit;
    }
}

function requireAdmin() {
    requireLogin();
    if (!isAdmin()) {
        header('Location: support_main.php?error=permission');
        exit;
    }
}
```

---

## 5. XSS対策

### 5.1 対策方針

- 全ての出力時にHTMLエスケープを実施
- JavaScript内への出力は別途エスケープ

### 5.2 エスケープ関数

```php
<?php
/**
 * HTML出力用エスケープ（既存のchkSunitize関数）
 */
function chkSunitize($str) {
    if ($str === null) {
        return '';
    }
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}

/**
 * JavaScript出力用エスケープ
 */
function jsEscape($str) {
    if ($str === null) {
        return '';
    }
    return json_encode($str, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);
}

/**
 * 属性値出力用エスケープ
 */
function attrEscape($str) {
    if ($str === null) {
        return '';
    }
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}
```

### 5.3 使用例

```php
<!-- HTML出力 -->
<p><?php echo chkSunitize($data['報告内容']); ?></p>

<!-- 属性値出力 -->
<input type="text" value="<?php echo attrEscape($data['顧客名']); ?>">

<!-- JavaScript出力 -->
<script>
var userName = <?php echo jsEscape($_SESSION['USER_NAME']); ?>;
</script>

<!-- 改行をbrタグに変換して出力 -->
<p><?php echo nl2br(chkSunitize($data['報告内容'])); ?></p>
```

### 5.4 テンプレートでの注意点

```php
<!-- 悪い例（エスケープなし） -->
<?php echo $data['報告内容']; ?>

<!-- 良い例（エスケープあり） -->
<?php echo chkSunitize($data['報告内容']); ?>

<!-- 悪い例（属性値直接出力） -->
<input value="<?php echo $data['name']; ?>">

<!-- 良い例（属性値エスケープ） -->
<input value="<?php echo attrEscape($data['name']); ?>">
```

---

## 6. SQLインジェクション対策

### 6.1 対策方針

- 全てのSQLクエリでプリペアドステートメントを使用
- 動的SQLは最小限に抑制
- 入力値の型チェックを実施

### 6.2 安全なクエリ実装

```php
<?php
/**
 * 安全なSELECT（プリペアドステートメント使用）
 */
function getReportById($seqno) {
    global $pdo_conn;
    
    // 入力値の型チェック
    if (!is_numeric($seqno)) {
        return null;
    }
    
    $sql = "SELECT * FROM D_作業報告 WHERE SEQNO = ? AND 削除日時 IS NULL";
    $stmt = $pdo_conn->prepare($sql);
    $stmt->execute(array((int)$seqno));
    
    return $stmt->fetch(PDO::FETCH_ASSOC);
}

/**
 * 安全なINSERT（プリペアドステートメント使用）
 */
function insertReport($data) {
    global $pdo_conn;
    
    $sql = "INSERT INTO D_作業報告 
            (SEQNO, 対応開始日時, 顧客コード, 報告内容, 作業担当コード, 入力マシン)
            VALUES (?, ?, ?, ?, ?, ?)";
    
    $stmt = $pdo_conn->prepare($sql);
    $stmt->execute(array(
        (int)$data['seqno'],
        $data['taiou_start'],
        (int)$data['kokyaku_code'],
        $data['houkoku'],
        (int)$data['tantou_code'],
        'WEB'
    ));
    
    return $stmt->rowCount();
}

/**
 * ストアドプロシージャの安全な呼び出し
 */
function callSearchProcedure($params) {
    global $pdo_conn;
    
    $sql = "EXEC dbo.SEL_D_作業報告_検索 
            @対応開始日FROM = ?, 
            @対応開始日TO = ?,
            @作業担当コード = ?,
            @ページ番号 = ?,
            @ページサイズ = ?";
    
    $stmt = $pdo_conn->prepare($sql);
    $stmt->execute(array(
        $params['date_from'] ?: null,
        $params['date_to'] ?: null,
        $params['tantou_code'] ? (int)$params['tantou_code'] : null,
        (int)$params['page'],
        (int)$params['limit']
    ));
    
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}
```

### 6.3 禁止パターン

```php
<?php
// 悪い例：文字列結合でのSQL構築
$sql = "SELECT * FROM D_作業報告 WHERE SEQNO = " . $_GET['id'];  // 危険！

// 悪い例：ユーザー入力をそのまま使用
$sql = "SELECT * FROM D_作業報告 WHERE 報告内容 LIKE '%" . $_POST['keyword'] . "%'";  // 危険！

// 良い例：プリペアドステートメント使用
$sql = "SELECT * FROM D_作業報告 WHERE SEQNO = ?";
$stmt = $pdo_conn->prepare($sql);
$stmt->execute(array((int)$_GET['id']));

// 良い例：LIKE句もプリペアドステートメント
$sql = "SELECT * FROM D_作業報告 WHERE 報告内容 LIKE ?";
$stmt = $pdo_conn->prepare($sql);
$stmt->execute(array('%' . $_POST['keyword'] . '%'));
```

---

## 7. セッション管理セキュリティ

### 7.1 セッション設定

```php
<?php
// セッションセキュリティ設定
ini_set('session.cookie_httponly', 1);      // JavaScript無効化
ini_set('session.use_strict_mode', 1);      // 不正ID拒否
ini_set('session.use_only_cookies', 1);     // Cookie限定
ini_set('session.cookie_samesite', 'Lax');  // SameSite設定

// セッション開始前に設定
session_set_cookie_params([
    'lifetime' => 0,                         // ブラウザ閉じるまで
    'path' => '/',
    'domain' => '',
    'secure' => false,                       // HTTP（社内）
    'httponly' => true,
    'samesite' => 'Lax'
]);
```

### 7.2 セッション固定攻撃対策

```php
<?php
// ログイン成功時にセッションIDを再生成
function regenerateSession() {
    // 古いセッションIDを破棄して新しいIDを生成
    session_regenerate_id(true);
}

// 使用例
if (authenticate($user_id, $password)) {
    regenerateSession();  // 重要！
    // セッション変数設定
}
```

### 7.3 セッションハイジャック対策

```php
<?php
/**
 * セッション検証（将来の強化用）
 * 現在は社内限定のため実装を省略
 */
function validateSession() {
    // IPアドレス検証（オプション）
    // if ($_SESSION['USER_IP'] !== $_SERVER['REMOTE_ADDR']) {
    //     return false;
    // }
    
    // User-Agent検証（オプション）
    // if ($_SESSION['USER_AGENT'] !== $_SERVER['HTTP_USER_AGENT']) {
    //     return false;
    // }
    
    return true;
}
```

---

## 8. 入力検証

### 8.1 バリデーション実装

```php
<?php
/**
 * 入力値サニタイズ
 */
function sanitizeInput($value, $type = 'string') {
    if ($value === null) {
        return null;
    }
    
    switch ($type) {
        case 'int':
            return filter_var($value, FILTER_VALIDATE_INT) !== false ? (int)$value : null;
        
        case 'float':
            return filter_var($value, FILTER_VALIDATE_FLOAT) !== false ? (float)$value : null;
        
        case 'email':
            return filter_var($value, FILTER_VALIDATE_EMAIL) ?: null;
        
        case 'date':
            $date = DateTime::createFromFormat('Y-m-d', $value);
            return ($date && $date->format('Y-m-d') === $value) ? $value : null;
        
        case 'datetime':
            $date = DateTime::createFromFormat('Y-m-d H:i:s', $value);
            return ($date && $date->format('Y-m-d H:i:s') === $value) ? $value : null;
        
        case 'string':
        default:
            // 制御文字を除去
            $value = preg_replace('/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/', '', $value);
            return trim($value);
    }
}

/**
 * 必須チェック
 */
function validateRequired($value, $field_name) {
    if ($value === null || trim($value) === '') {
        return "{$field_name}は必須項目です。";
    }
    return null;
}

/**
 * 最大文字数チェック
 */
function validateMaxLength($value, $max, $field_name) {
    if ($value !== null && mb_strlen($value, 'UTF-8') > $max) {
        return "{$field_name}は{$max}文字以内で入力してください。";
    }
    return null;
}

/**
 * 数値範囲チェック
 */
function validateRange($value, $min, $max, $field_name) {
    if ($value !== null && ($value < $min || $value > $max)) {
        return "{$field_name}は{$min}〜{$max}の範囲で入力してください。";
    }
    return null;
}
```

### 8.2 使用例

```php
<?php
// 入力値の取得とサニタイズ
$seqno = sanitizeInput($_POST['seqno'], 'int');
$taiou_date = sanitizeInput($_POST['taiou_date'], 'date');
$kokyaku_code = sanitizeInput($_POST['kokyaku_code'], 'int');
$houkoku = sanitizeInput($_POST['houkoku'], 'string');

// バリデーション
$errors = array();

if ($error = validateRequired($taiou_date, '対応日')) {
    $errors[] = $error;
}
if ($error = validateRequired($kokyaku_code, '顧客')) {
    $errors[] = $error;
}
if ($error = validateRequired($houkoku, '報告内容')) {
    $errors[] = $error;
}
if ($error = validateMaxLength($houkoku, 10000, '報告内容')) {
    $errors[] = $error;
}

if (count($errors) > 0) {
    // エラー処理
}
```

---

## 9. 出力エンコーディング

### 9.1 HTTPヘッダー設定

```php
<?php
// 文字コード設定
header('Content-Type: text/html; charset=utf-8');

// キャッシュ制御
header('Cache-Control: no-store, no-cache, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

// X-Content-Type-Options
header('X-Content-Type-Options: nosniff');

// X-Frame-Options（クリックジャッキング対策）
header('X-Frame-Options: SAMEORIGIN');

// X-XSS-Protection
header('X-XSS-Protection: 1; mode=block');
```

### 9.2 JSON出力

```php
<?php
// JSON出力時
header('Content-Type: application/json; charset=utf-8');

// 安全なJSONエンコード
echo json_encode($data, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP | JSON_UNESCAPED_UNICODE);
```

---

## 10. ファイルアップロードセキュリティ（将来用）

### 10.1 対策方針

現バージョンではファイルアップロード機能は未実装。
将来実装時の対策方針を記載。

### 10.2 実装ガイドライン

```php
<?php
/**
 * 安全なファイルアップロード（将来実装用）
 */
function secureFileUpload($file, $allowed_types, $max_size) {
    $errors = array();
    
    // ファイルエラーチェック
    if ($file['error'] !== UPLOAD_ERR_OK) {
        return array('error' => 'ファイルのアップロードに失敗しました。');
    }
    
    // サイズチェック
    if ($file['size'] > $max_size) {
        return array('error' => 'ファイルサイズが大きすぎます。');
    }
    
    // MIME型チェック
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mime = finfo_file($finfo, $file['tmp_name']);
    finfo_close($finfo);
    
    if (!in_array($mime, $allowed_types)) {
        return array('error' => '許可されていないファイル形式です。');
    }
    
    // 安全なファイル名生成
    $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
    $safe_name = bin2hex(random_bytes(16)) . '.' . $ext;
    
    // 保存先（Webルート外）
    $upload_dir = '/var/uploads/';
    $dest = $upload_dir . $safe_name;
    
    if (!move_uploaded_file($file['tmp_name'], $dest)) {
        return array('error' => 'ファイルの保存に失敗しました。');
    }
    
    return array('success' => true, 'filename' => $safe_name);
}
```

---

## 11. エラーメッセージのセキュリティ

### 11.1 方針

- システムエラーの詳細は画面に表示しない
- 詳細情報はログに記録
- ユーザーには一般的なメッセージを表示

### 11.2 実装

```php
<?php
// 本番環境でのエラー表示設定
ini_set('display_errors', 'Off');
ini_set('log_errors', 'On');
ini_set('error_log', 'logs/php_error.log');

// データベースエラーの処理
try {
    // DB処理
} catch (PDOException $e) {
    // 詳細はログに記録
    error_log('DB Error: ' . $e->getMessage());
    
    // ユーザーには一般的なメッセージ
    throw new AppError('DB_001', 'データベースエラーが発生しました。');
}
```

---

## 12. セキュリティチェックリスト

### 12.1 開発時チェック

| 項目 | 確認 |
|------|------|
| 全ての出力でHTMLエスケープを使用しているか | □ |
| SQLはプリペアドステートメントを使用しているか | □ |
| 入力値のバリデーションを実施しているか | □ |
| セッションIDを適切に再生成しているか | □ |
| 権限チェックを実装しているか | □ |
| エラーメッセージに機密情報が含まれていないか | □ |

### 12.2 デプロイ時チェック

| 項目 | 確認 |
|------|------|
| display_errorsがOffになっているか | □ |
| エラーログが適切に設定されているか | □ |
| 不要なファイルが公開されていないか | □ |
| ディレクトリリスティングが無効になっているか | □ |
| セッション設定が適切か | □ |

---

## 13. 将来の強化案

### 13.1 外部公開時の追加対策

| 対策 | 説明 |
|------|------|
| HTTPS化 | SSL/TLS通信の導入 |
| CSRFトークン | フォーム送信時のトークン検証 |
| パスワードハッシュ化 | bcryptでのパスワード保存 |
| レートリミット | ログイン試行回数制限 |
| IPホワイトリスト | 接続元IP制限 |
| WAF導入 | Webアプリケーションファイアウォール |

---

**作成者**: Claude AI  
**レビュー**: Phase 04完了時  
**改訂履歴**:
- v1.0 (2025-11-25): 初版作成
