# マスタ保守画面設計書

**作成日**: 2025-11-25  
**バージョン**: 1.0  
**Phase**: 03  
**画面ID**: master  
**関連ファイル**: master_product.php, master_template.php, master_category.php, master_content.php

---

## 1. 概要

### 1.1 画面の目的
各種マスタデータの登録・編集・削除を行う管理画面。

### 1.2 マスタ画面一覧

| No | マスタ名 | 画面ID | ファイル名 | 対象テーブル |
|----|---------|--------|-----------|-------------|
| 1 | 商品マスタ | master_shohin | master_shohin.php | M_商品 |
| 2 | 定型文マスタ | master_teikei | master_teikei.php | M_定型文 |
| 3 | 対応区分マスタ | master_kubun | master_kubun.php | M_対応区分 |
| 4 | 対応内容項目マスタ | master_content | master_content.php | M_対応内容項目 |

### 1.3 アクセス条件
- ログイン済みであれば利用可（AUTH_LEVELによる表示/非表示は行っていない）
- メイン画面からiframeモーダルとして起動し、各マスタ画面の「閉じる」ボタンでモーダルを終了（親モーダルの右上「×」は廃止）

---

## 2. 共通レイアウト設計

### 2.1 PC版共通レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ヘッダーエリア                                                          │
│ マスタ設定 - [マスタ名]                              [閉じる]          │
├─────────────────────────────────────────────────────────────────────────┤
│ 入力エリア                                                              │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  [項目1]  [____▼]  [項目2]  [____________]  ...  [保存]             │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│ 一覧エリア（埋め込みテーブル）                                          │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  項目1  │  項目2  │  項目3  │  更新日時  │  操作                    │ │
│ ├─────────────────────────────────────────────────────────────────────┤ │
│ │  xxx    │  yyy    │  zzz    │ 2025/11/25 │ [修正] [削除]            │ │
│ │  xxx    │  yyy    │  zzz    │ 2025/11/24 │ [修正] [削除]            │ │
│ │  ...                                                                 │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

- 一覧はテーブルの `thead` と `tbody` を同一テーブル内に配置した埋め込みテーブル構造。リスト部のスクロール時もヘッダーが `position: sticky` で固定される。

### 2.2 操作フロー（共通）

```
START
  │
  ├───[新規登録]───────────────────┐
  │   入力欄に新規入力             │
  │   ↓                          │
  │   [保存]ボタン押下             │
  │   ↓                          │
  │   バリデーション               │
  │   ↓（OK）                    │
  │   DB登録                      │
  │   ↓                          │
  │   一覧再表示                   │
  │                               │
  ├───[修正]─────────────────────┐│
  │   一覧から行を選択            ││
  │   ↓                         ││
  │   [修正]ボタン押下            ││
  │   ↓                         ││
  │   入力欄にデータセット        ││
  │   ↓                         ││
  │   内容修正                    ││
  │   ↓                         ││
  │   [保存]ボタン押下            ││
  │   ↓                         ││
  │   バリデーション              ││
  │   ↓（OK）                   ││
  │   DB更新                     ││
  │   ↓                         ││
  │   一覧再表示                  ││
  │                              ││
  └───[削除]────────────────────┘│
      一覧から行を選択            │
      ↓                          │
      [削除]ボタン押下            │
      ↓                          │
      削除確認ダイアログ          │
      ↓（OK）                    │
      DB論理削除                  │
      ↓                          │
      一覧再表示                  │
                                  │
  ←────────────────────────────────┘
  │
 END
```

---

## 3. 商品マスタ画面（master_shohin）

### 3.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│ マスタ設定 - 商品                                        [閉じる]      │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  部門:     [LPG支援部    ▼]                                        │ │
│ │  商品コード: [____]（自動採番・編集不可）                             │ │
│ │  商品名:   [____________________________]                           │ │
│ │  使用区分: [使用する    ▼]                                         │ │
│ │                                                [クリア] [保存]      │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────────────┤
│ フィルタ: 部門 [すべて▼]  使用区分 [すべて▼]                           │
├─────────────────────────────────────────────────────────────────────────┤
│ │ 部門    │コード│ 商品名           │使用区分│ 更新日時  │ 操作   │ │
│ ├─────────────────────────────────────────────────────────────────────┤ │
│ │LPG支援部│ 1   │ SILPS            │使用する│2025/11/25│[修正][削除]│
│ │LPG支援部│ 2   │ ちゃんぷる～EJ   │使用する│2025/11/24│[修正][削除]│
│ │開発部   │ 3   │ マイヘルスEJ     │使用する│2025/11/23│[修正][削除]│
│ │...                                                                  │ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 入力項目

| No | 項目名 | 項目ID | 種類 | 必須 | 説明 |
|----|-------|--------|------|------|------|
| 1 | 部門 | master-bumon | セレクト | ○ | 管理部門を選択。編集モードでは変更不可。 |
| 2 | 商品コード | master-code | テキスト（readonly） | 自動 | 部門ごとに自動採番され、画面上では常に読み取り専用。 |
| 3 | 商品名 | master-name | テキスト | ○ | 商品名称（255文字以内） |
| 4 | 使用区分 | master-use | セレクト | ○ | 使用する/使用しない（1/0） |

### 3.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 部門 | 必須チェック | 部門を選択してください。 |
| 2 | 商品名 | 必須チェック | 商品名を入力してください。 |
| 3 | 商品名 | 最大桁数 | 商品名は255文字以内で入力してください。 |
| 4 | 使用区分 | 必須チェック | 使用区分を選択してください。 |

### 3.4 主な処理

- `master_ajax.php` の `action=list/get/save/delete` を通じてAjaxで処理。
- 新規登録: 部門コード別に `MAX(商品コード)+1` を採番して INSERT。
- 更新: 商品名・使用区分を UPDATE（部門コード+商品コードで特定）。
- 削除: 削除確認後、`DELDATA_商品` へ退避してから `M_商品` を削除（トランザクション）。

---

## 4. 定型文マスタ画面（master_template）

### 4.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│ マスタ設定 - 定型文                                      [閉じる]      │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  部門:       [LPG支援部    ▼]                                      │ │
│ │  定型文コード: [____]（新規時は自動採番）                            │ │
│ │  定型文:                                                            │ │
│ │  ┌─────────────────────────────────────────────────────────────┐   │ │
│ │  │                                                             │   │ │
│ │  │  （定型文入力エリア：10行）                                  │   │ │
│ │  │                                                             │   │ │
│ │  │                                                             │   │ │
│ │  └─────────────────────────────────────────────────────────────┘   │ │
│ │                                                [クリア] [保存]      │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│ フィルタ: 部門 [すべて▼]                                               │
├─────────────────────────────────────────────────────────────────────────┤
│ │ 部門    │コード│ 定型文（先頭80文字）              │ 更新日時  │ 操作│ │
│ ├─────────────────────────────────────────────────────────────────────┤ │
│ │LPG支援部│ 1   │お客様へお問い合わせいたしま...   │2025/11/25│[修正][削除]│
│ │LPG支援部│ 2   │データ更新が完了いたしました...   │2025/11/24│[修正][削除]│
│ │...                                                                  │ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 入力項目

| No | 項目名 | 項目ID | 種類 | 必須 | 説明 |
|----|-------|--------|------|------|------|
| 1 | 部門 | template-bumon | セレクト | ○ | 管理部門 |
| 2 | 定型文コード | template-code | 数値 | △ | 新規時は部門内で自動採番 |
| 3 | 定型文 | template-text | テキストエリア | ○ | 定型文内容（MAX） |

### 4.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 部門 | 必須チェック | 部門を選択してください。 |
| 2 | 定型文 | 必須チェック | 定型文を入力してください。 |

### 4.4 使用ストアドプロシージャ

| SP名 | 用途 |
|------|------|
| SEL_M_定型文 | 一覧取得（部門フィルタ対応） |
| UPD_M_定型文 | 登録・更新 |
| DEL_定型文 | 削除（DELDATA_定型文へ移動） |

### 4.5 特記事項

- 定型文コードは部門ごとに採番（部門コード + 定型文コードで主キー）
- 一覧では定型文の先頭80文字を表示
- 修正時は全文をテキストエリアに展開

---

## 5. 対応区分マスタ画面（master_category）

### 5.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│ マスタ設定 - 対応区分                                    [閉じる]      │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  対応区分コード: [____]（新規時は自動採番）                          │ │
│ │  対応区分名:     [____________________________]                     │ │
│ │                                                [クリア] [保存]      │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│ │対応区分コード│ 対応区分名                 │ 更新日時  │ 操作       │ │
│ ├─────────────────────────────────────────────────────────────────────┤ │
│ │ 1           │ 問い合わせ                 │2025/11/25│[修正][削除] │ │
│ │ 2           │ 要望                       │2025/11/24│[修正][削除] │ │
│ │ 3           │ 障害報告                   │2025/11/23│[修正][削除] │ │
│ │...                                                                  │ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 入力項目

| No | 項目名 | 項目ID | 種類 | 必須 | 説明 |
|----|-------|--------|------|------|------|
| 1 | 対応区分コード | category-code | 数値 | △ | 新規時は自動採番 |
| 2 | 対応区分名 | category-name | テキスト | ○ | 対応区分名称（255文字以内） |

### 5.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 対応区分名 | 必須チェック | 対応区分名を入力してください。 |
| 2 | 対応区分名 | 最大桁数 | 対応区分名は255文字以内で入力してください。 |

### 5.4 使用ストアドプロシージャ

| SP名 | 用途 |
|------|------|
| SEL_M_対応区分 | 一覧取得 |
| UPD_M_対応区分 | 登録・更新 |
| DEL_対応区分 | 削除（DELDATA_対応区分へ移動） |

---

## 6. 対応内容項目マスタ画面（master_content）

### 6.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│ マスタ設定 - 対応内容項目                                [閉じる]      │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  項目コード:   [____]（1〜20の範囲で指定）                           │ │
│ │  項目名:       [____________________________]                       │ │
│ │                                                [クリア] [保存]      │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│ │項目コード│ 項目名                       │ 更新日時  │ 操作         │ │
│ ├─────────────────────────────────────────────────────────────────────┤ │
│ │ 1       │ 操作説明                     │2025/11/25│[修正][削除]   │ │
│ │ 2       │ データ更新                   │2025/11/24│[修正][削除]   │ │
│ │ 3       │ データ調査                   │2025/11/23│[修正][削除]   │ │
│ │ 4       │ 打合せ                       │2025/11/22│[修正][削除]   │ │
│ │...                                                                  │ │
├─────────────────────────────────────────────────────────────────────────┤
│ ※ 項目コードは1〜20の範囲で指定してください。                           │
│   入力ダイアログのチェックボックスの並び順はコード順になります。          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 入力項目

| No | 項目名 | 項目ID | 種類 | 必須 | 説明 |
|----|-------|--------|------|------|------|
| 1 | 項目コード | content-code | 数値 | ○ | 1〜20の範囲（主キー） |
| 2 | 項目名 | content-name | テキスト | ○ | 項目名称（255文字以内） |

### 6.3 バリデーション

| No | 項目 | チェック内容 | エラーメッセージ |
|----|------|-------------|-----------------|
| 1 | 項目コード | 必須チェック | 項目コードを入力してください。 |
| 2 | 項目コード | 範囲チェック | 項目コードは1〜20の範囲で入力してください。 |
| 3 | 項目コード | 重複チェック | この項目コードは既に使用されています。 |
| 4 | 項目名 | 必須チェック | 項目名を入力してください。 |
| 5 | 項目名 | 最大桁数 | 項目名は255文字以内で入力してください。 |

### 6.4 使用ストアドプロシージャ

| SP名 | 用途 |
|------|------|
| SEL_M_対応内容項目 | 一覧取得 |
| UPD_M_対応内容項目 | 登録・更新 |
| DEL_対応内容項目 | 削除（DELDATA_対応内容項目へ移動） |

### 6.5 特記事項

- 項目コードは1〜20に限定（D_作業報告の対応内容フラグ1〜20に対応）
- 新規登録時は空いているコードを選択
- 削除すると入力ダイアログのチェックボックスから消える

---

## 7. 共通処理仕様

### 7.1 Ajax通信

#### 7.1.1 一覧取得

**リクエスト**:

| パラメータ名 | 型 | 説明 |
|-------------|-----|------|
| action | string | 'list' |
| master_type | string | 'product'/'template'/'category'/'content' |
| filter_bumon | int | 部門フィルタ（商品・定型文のみ） |
| filter_use | int | 使用区分フィルタ（商品のみ） |

**レスポンス**:

```json
{
    "status": "success",
    "data": [
        { "code": 1, "name": "xxx", "update_date": "2025/11/25" },
        // ...
    ]
}
```

#### 7.1.2 保存

**リクエスト**:

| パラメータ名 | 型 | 説明 |
|-------------|-----|------|
| action | string | 'save' |
| master_type | string | マスタ種別 |
| mode | string | 'new' or 'edit' |
| code | int | コード（編集時） |
| （各項目） | - | マスタ種別による |

**レスポンス**:

```json
{
    "status": "success",
    "message": "保存しました。"
}
```

#### 7.1.3 削除

**リクエスト**:

| パラメータ名 | 型 | 説明 |
|-------------|-----|------|
| action | string | 'delete' |
| master_type | string | マスタ種別 |
| code | int | 削除対象コード |

**レスポンス**:

```json
{
    "status": "success",
    "message": "削除しました。"
}
```

### 7.2 削除処理

- 論理削除ではなく、DELDATA_*テーブルへ移動
- 移動先テーブルに削除日時カラムを追加
- 復元機能は将来検討

### 7.3 エラーハンドリング

入力エリアの上部にエラーボックスを表示

```
┌─────────────────────────────────────────────────┐
│ 【エラー】商品名を入力してください。             │
└─────────────────────────────────────────────────┘
```

---

## 8. 画面遷移

### 8.1 呼び出し元

| 遷移元 | ボタン |
|--------|--------|
| メイン画面 | 商品ボタン → 商品マスタ |
| メイン画面 | 対応区分ボタン → 対応区分マスタ |
| メイン画面 | 対応内容ボタン → 対応内容項目マスタ |
| メイン画面 | 定型文ボタン → 定型文マスタ |

### 8.2 表示方法

- モーダルダイアログまたは新規タブ
- モーダルの場合：幅600px〜800px、最大高さ90vh
- 新規タブの場合：独立したページとして表示

### 8.3 閉じる動作

| トリガー | 動作 |
|---------|------|
| ヘッダーの閉じるボタン | 画面を閉じる（全マスタ共通で1箇所） |
| Escキー | 画面を閉じる（モーダル時） |

---

## 9. JavaScript処理

### 9.1 修正ボタン押下時

```javascript
$('.btn-edit').on('click', function() {
    var $row = $(this).closest('tr');
    var data = {
        code: $row.data('code'),
        name: $row.data('name'),
        // ... その他のデータ
    };
    
    // 入力欄にデータをセット
    setFormData(data);
    
    // モードを編集に変更
    currentMode = 'edit';
    currentCode = data.code;
    
    // コード欄を編集不可に
    $('#master-code').prop('readonly', true);
    
    // 入力欄にスクロール
    scrollToForm();
});
```

### 9.2 削除ボタン押下時

```javascript
$('.btn-delete').on('click', function() {
    var code = $(this).closest('tr').data('code');
    var name = $(this).closest('tr').data('name');
    
    if (!confirm('"' + name + '" を削除してもよろしいですか？')) {
        return;
    }
    
    $.ajax({
        type: 'POST',
        url: 'master_ajax.php',
        data: {
            action: 'delete',
            master_type: masterType,
            code: code
        },
        dataType: 'json',
        success: function(response) {
            if (response.status === 'success') {
                showMessage(response.message);
                loadList();
            } else {
                showError(response.message);
            }
        }
    });
});
```

### 9.3 保存処理

```javascript
$('#btn-save').on('click', function() {
    // バリデーション
    if (!validateForm()) {
        return;
    }
    
    var formData = collectFormData();
    formData.action = 'save';
    formData.master_type = masterType;
    formData.mode = currentMode;
    if (currentMode === 'edit') {
        formData.code = currentCode;
    }
    
    $.ajax({
        type: 'POST',
        url: 'master_ajax.php',
        data: formData,
        dataType: 'json',
        success: function(response) {
            if (response.status === 'success') {
                showMessage(response.message);
                clearForm();
                loadList();
            } else {
                showErrors(response.errors);
            }
        }
    });
});
```

---

## 10. CSS設計

### 10.1 マスタ画面共通スタイル

```css
.master-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.master-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}

.master-header h1 {
    font-size: 20px;
    margin: 0;
    color: #333;
}

.input-area {
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 20px;
}

.input-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.input-row label {
    width: 120px;
    font-weight: bold;
}

.input-row .input-field {
    flex: 1;
}

.filter-area {
    margin-bottom: 10px;
    padding: 10px;
    background-color: #f5f5f5;
}

.list-area {
    margin-bottom: 20px;
}

.master-table {
    width: 100%;
    border-collapse: collapse;
}

.master-table th,
.master-table td {
    border: 1px solid #ddd;
    padding: 8px 10px;
    text-align: left;
}

.master-table th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.master-table tbody tr:hover {
    background-color: #f9f9f9;
}

.btn-edit {
    background-color: #007bff;
    color: #fff;
    border: none;
    padding: 4px 10px;
    border-radius: 3px;
    cursor: pointer;
    margin-right: 5px;
}

.btn-delete {
    background-color: #dc3545;
    color: #fff;
    border: none;
    padding: 4px 10px;
    border-radius: 3px;
    cursor: pointer;
}

.footer-area {
    text-align: right;
    padding-top: 10px;
    border-top: 1px solid #ddd;
}
```

---

## 11. 権限制御

### 11.1 アクセス制御

```php
// 画面アクセス時のチェック
if ($_SESSION['AUTH_LEVEL'] < 2) {
    // 管理者権限がない場合はアクセス拒否
    header('Location: support_main.php');
    exit;
}
```

### 11.2 メニュー表示制御

```php
// メイン画面でのボタン表示制御
<?php if ($_SESSION['AUTH_LEVEL'] >= 2): ?>
<button id="btn-master-product">商品</button>
<button id="btn-master-category">対応区分</button>
<button id="btn-master-content">対応内容</button>
<button id="btn-master-template">定型文</button>
<?php endif; ?>
```

---

## 12. 備考

### 12.1 既存システムとの違い

| 項目 | Accessシステム | WEBシステム |
|------|--------------|------------|
| 表示形式 | 別フォーム | モーダル or 新規タブ |
| 更新方法 | 即時更新 | 保存ボタン押下時 |
| 削除方法 | 物理削除 | DELDATA_*へ移動 |

### 12.2 テスト観点

- 新規登録：全必須項目入力、保存成功
- 修正：既存データ選択、変更保存
- 削除：確認ダイアログ、削除成功
- 権限：一般ユーザーのアクセス拒否
- バリデーション：各エラーパターン
- フィルタ：部門フィルタ、使用区分フィルタ

### 12.3 将来の拡張

- 削除データの復元機能
- インポート/エクスポート機能
- 一括編集機能

---

**作成者**: Claude AI  
**レビュー**: Phase 03完了時  
**改訂履歴**:
- v1.0 (2025-11-25): 初版作成
