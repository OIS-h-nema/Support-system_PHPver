# support_main.phpを基準とした他画面への修正レポート

## 実施日
2025-12-10

## 修正概要
support_main.phpとその関連処理ファイルを基準として、他の画面（ログイン画面、マスタ画面等）に同様の処理やコーディングロジック・フローの修正を適用しました。

## 修正対象ファイル

### 1. login.php
**修正内容:**
- jQuery参照を `js/jquery-1.11.3.min.js` から `js/jquery.js` に変更
- common.jsの参照を追加

```php
// Before
<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>

// After
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/common.js"></script>
```

### 2. master_shohin.php（商品マスタ設定画面）
**修正内容:**
- jQuery参照を統一
- 部門リスト取得SQLでエイリアスを使用（文字化け対策）
- PHPでのデータ参照を英語エイリアス名に変更

```php
// Before
$stmt = $pdo_conn->query("SELECT 部門コード, 部門名 FROM SQL_部門 ORDER BY 部門コード");
// After
$stmt = $pdo_conn->query("SELECT 部門コード AS code, 部門名 AS name FROM SQL_部門 ORDER BY 部門コード");

// Before
echo h($b['部門コード']);
// After
echo h($b['code']);
```

### 3. master_kubun.php（対応区分マスタ設定画面）
**修正内容:**
- jQuery参照を統一

### 4. master_content.php（対応内容項目マスタ設定画面）
**修正内容:**
- jQuery参照を統一

### 5. master_teikei.php（定型文マスタ設定画面）
**修正内容:**
- jQuery参照を統一
- 部門リスト取得SQLでエイリアスを使用（文字化け対策）
- PHPでのデータ参照を英語エイリアス名に変更

### 6. master_ajax.php（マスタ設定用Ajax処理）
**修正内容:**
- 全クエリでエイリアス（英語名）を使用して文字化け対策
- データアクセス時のキー名を英語エイリアスに統一

**主な変更点:**
- 商品マスタ: `部門コード AS bumon_code`, `商品名 AS shohin_name` 等
- 定型文マスタ: `定型文コード AS teikei_code`, `定型文 AS teikei_text` 等
- 対応区分マスタ: `対応区分コード AS kubun_code`, `対応区分名 AS kubun_name` 等
- 対応内容項目マスタ: `項目コード AS koumoku_code`, `項目名 AS koumoku_name` 等

### 7. support_ajax02.php（サポート報告書入力ダイアログAjax処理）
**修正内容:**
- 定型文取得処理でエイリアスを使用
- `getBumonCode()` を `getCurrentBumonCode()` に修正（auth.phpの既存関数を使用）

```php
// Before
$bumon_code = getBumonCode();
// After
$bumon_code = getCurrentBumonCode();
```

### 8. js/support_dialog.js（入力ダイアログ用JavaScript）
**修正内容:**
- 定型文表示時のタイトル生成方法を修正（`teikei_name`が廃止されたため）
- プレビュー表示を30文字から80文字に拡張

```javascript
// Before
var title = t.teikei_name || '';
// After
var title = '定型文 ' + (t.teikei_code || (i + 1));
```

## 修正方針

### 1. jQuery参照の統一
全画面で `js/jquery.js` を参照するように統一。これは既に検証環境で動作確認済みのjQueryファイルを使用するためです。

### 2. エイリアス（英語名）の使用
PDOでSQL Serverから日本語カラム名を含むデータを取得する際、文字化けが発生する問題があるため、SELECT句でエイリアス（英語名）を指定し、PHPでの参照を英語名で行うように統一しました。

**パターン:**
```sql
SELECT 日本語カラム名 AS english_alias FROM テーブル
```

### 3. コーディングスタイルの統一
- ヘッダーコメントの形式
- requireの順序
- エラーハンドリング方法
- JSONレスポンスの形式

## テスト推奨項目

1. **ログイン画面**
   - ログイン処理が正常に動作すること
   - バリデーションエラーが正しく表示されること

2. **商品マスタ画面**
   - 一覧表示が正常に動作すること（部門名、商品名が文字化けしないこと）
   - 新規登録、編集、削除が正常に動作すること
   - 部門フィルタが正常に動作すること

3. **対応区分マスタ画面**
   - 一覧表示が正常に動作すること
   - 新規登録、編集、削除が正常に動作すること

4. **対応内容項目マスタ画面**
   - 一覧表示が正常に動作すること
   - 新規登録、編集、削除が正常に動作すること

5. **定型文マスタ画面**
   - 一覧表示が正常に動作すること（部門名、定型文内容が文字化けしないこと）
   - 新規登録、編集、削除が正常に動作すること
   - 部門フィルタが正常に動作すること

6. **入力ダイアログ（定型文選択）**
   - 定型文選択ダイアログが開くこと
   - 定型文リストが正しく表示されること
   - 定型文選択後、報告内容に挿入されること

## 検証環境へのデプロイ

以下のコマンドで検証環境にデプロイできます：
```
D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\04_製造\deploy_to_test.bat
```

## 次のステップ

1. 検証環境にデプロイ
2. 上記テスト項目の実施
3. 問題があれば修正
4. ユーザー受け入れテストの実施
