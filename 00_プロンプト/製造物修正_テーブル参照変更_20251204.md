# 製造物修正プロンプト - テーブル参照方式変更対応

**作成日**: 2025-12-04
**目的**: SQL_顧客/SQL_作業担当/SQL_部門のローカルテーブル化に伴う製造物修正

---

## プロンプト開始

```
#達成目標
現在Accessで動いてるシステムのWEB版をリリースする

#システム概要
自社の社員向けに、日々の顧客からの問い合わせや、それに対する対応を入力し、記録・分析を行うもの

#旧システム仕様
DB：SQL Server
DB接続：PDO
データ操作：ストアドプロシージャ（一部VBA）
フロント：MS Access

#新システム仕様
DB：SQL Server（継続）
DB接続：PDO（PHP）
データ操作：ストアドプロシージャ（継続）/（一部PHP）
フロント：PHP/HTML/CSS/jQuery

#プロジェクトの実行の制約
* なるべく人間の作業をなくし、ClaudeAIに分析、設計、製造、検証、修正と調整、環境構築の全ての工程を実施させる。
* 進行に応じていくつかのフェーズに分け、フェーズごとに新規でチャットを立ち上げる。また出力するファイルについてはフェーズごとにディレクトリを生成し、そこに出力する。
* フェーズ移行/チャット終了ごとに、次のチャットの最初に実行するプロンプトを生成する。また、チャットが容量オーバーになる前に次にチャット立ち上げを促すようにする。プロンプトの生成には作業ディレクトリの中に専用のディレクトリを作成し、そこに出力する。なお、プロンプトにはチャットを跨いでもプロジェクトの規約や工程を常に把握できるようにする。
* 成果物のファイルの出力は作業ディレクトリのみとし、チャットでは出力結果の報告のみに留める
* チャット内のトークンの節約を意識し、長尺タスクは分割して処理を実行するようにプロンプトに組み込む
* チャット内のトークンの節約を意識し、大容量のファイルの書き込みは分割して処理を実行するようにプロンプトを組み込む
* 大容量ファイルを読み込む場合は１度に処理しようとせず、分割して処理を実行するようにプロンプトに組み込む
* ファイルのコピーを行う場合、Filesystemのコピー機能を使うか、ファイルコピーを行うプログラムを生成し、それを実行してコピーを実行する（コピー元のファイルの内容を新規ファイルを作って書き込むというコピーは禁止）

# 作業ディレクトリ
D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\

# 検証ディレクトリ
\\LPG-NEMA\C\inetpub\wwwroot\support-system\

# 本番ディレクトリ
\\DEV-SE\C\inetpub\wwwroot\support-system\

---

# 今回のタスク：設計変更に伴う製造物修正

## 変更概要

旧システムで外部サーバーからリンクテーブルとして参照していた以下のテーブルを、新システムでは DEV-SE02\SQL22 / SUPPORTDB 内にローカルテーブルとして構築し、直接参照する方式に変更しました。

| テーブル名 | 変更内容 |
|-----------|---------|
| SQL_顧客 | 外部リンク → SUPPORTDB内ローカルテーブル |
| SQL_作業担当 | 外部リンク → SUPPORTDB内ローカルテーブル |
| SQL_部門 | 外部リンク → SUPPORTDB内ローカルテーブル |

## テーブル定義（新規構築済み）

### SQL_顧客
| カラム名 | データ型 |
|---------|---------|
| SEQNO | int (PK) |
| PARENT_SEQ | int |
| 顧客コード | int |
| 部門コード | int |
| 顧客名 | nvarchar(50) |
| 顧客名カナ | nvarchar(50) |
| 顧客略称 | nvarchar(50) |
| 郵便番号 | nvarchar(50) |
| 住所 | nvarchar(50) |
| 電話番号 | nvarchar(50) |
| FAX | nvarchar(50) |
| 更新日 | datetime |

### SQL_作業担当
| カラム名 | データ型 |
|---------|---------|
| 担当者コード | bigint (PK) |
| 部門コード | bigint (FK → SQL_部門) |
| 担当者名 | nvarchar(255) |
| パスワード | nvarchar(255) |
| 更新日 | datetime |

**重要**: 権限レベルカラムは存在しない

### SQL_部門
| カラム名 | データ型 |
|---------|---------|
| 部門コード | bigint (PK) |
| 部門名 | nvarchar(255) |
| 更新日 | datetime |

---

## 修正対象ファイル

検証ディレクトリ（\\LPG-NEMA\C\inetpub\wwwroot\support-system\）内の以下のファイルを確認し、必要な修正を行ってください。

### 1. 認証関連

**修正内容**:
- SQL_作業担当テーブルからの取得カラムを変更
- 「作業担当名」→「担当者名」
- 権限レベルカラムは存在しないため、AUTH_LEVELは固定値（2）を設定
- 削除日時カラムは存在しないため、削除条件を除外
- 日本語カラム名は英語エイリアスで取得（文字化け対策）

**修正例**:
```php
// 変更前
$sql = "SELECT 担当者コード, 作業担当名, 部門コード, 権限レベル 
        FROM SQL_作業担当 
        WHERE 担当者コード = ? AND パスワード = ? AND 削除日時 IS NULL";

// 変更後
$sql = "SELECT 
            担当者コード AS tantou_code,
            担当者名 AS tantou_name,
            部門コード AS bumon_code
        FROM SQL_作業担当 
        WHERE 担当者コード = ? AND パスワード = ?";

// セッション変数設定
$_SESSION['USER_CODE'] = $row['tantou_code'];
$_SESSION['USER_NAME'] = $row['tantou_name'];
$_SESSION['BUMON_CODE'] = $row['bumon_code'];
$_SESSION['AUTH_LEVEL'] = 2;  // 固定値: 全ユーザー管理者権限
```

### 2. 担当者一覧取得API

**確認ファイル**: api/get_tantousha.php など

**修正内容**:
- カラム名「作業担当名」→「担当者名」
- 英語エイリアスでの取得を推奨

### 3. 顧客一覧取得API

**確認ファイル**: api/get_customers.php など

**修正内容**:
- カラムのデータ型がint/nvarchar(50)に変更されていることを確認
- 必要に応じて英語エイリアスを使用

### 4. 部門一覧取得API

**確認ファイル**: api/get_bumon.php など

**修正内容**:
- 英語エイリアスでの取得を推奨

---

## 作業手順

1. **現状確認**
   - 検証ディレクトリ内のPHPファイル構成を確認
   - SQL_作業担当、SQL_顧客、SQL_部門を参照しているファイルを特定

2. **修正実施**
   - 各ファイルを読み込み、該当箇所を修正
   - 日本語カラム名は英語エイリアスで取得するよう変更
   - 権限レベル関連は固定値に変更

3. **修正ファイルのデプロイ**
   - 修正したファイルを検証ディレクトリに配置

4. **動作確認**
   - 認証機能が正常に動作することを確認
   - 各API（担当者、顧客、部門）が正常に動作することを確認

---

## 設計書参照先

改修済みの設計書は以下にあります：
- D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\03_設計\DB詳細設計書.md
- D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\03_設計\機能設計書\auth.md
- D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\03_設計\設計変更履歴_20251204.md

## テーブル定義参照先

テーブル作成SQLは以下にあります：
- D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\ナレッジ\CRETab_SQL_顧客.sql
- D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\ナレッジ\CRETab_SQL_作業担当.sql
- D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\ナレッジ\CRETab_SQL_部門.sql

---

まず、検証ディレクトリの構成を確認し、修正対象ファイルを特定してください。
その後、各ファイルを順次修正していってください。
```

---

## プロンプト終了

**使用方法**: 上記のプロンプト（```で囲まれた部分）を新規チャットにコピー＆ペーストして実行してください。
