# Phase 08 製造（マスタ設定・Excel出力）開始プロンプト

**作成日**: 2025-11-25  
**前Phase**: Phase 07（製造 - 入力ダイアログ）  
**次Phase**: Phase 09（検証・調整）

---

## プロジェクト概要

### 達成目標
現在Accessで動いてるシステムのWEB版をリリースする

### システム概要
自社の社員向けに、日々の顧客からの問い合わせや、それに対する対応を入力し、記録・分析を行うもの

### 技術スタック
- **DB**: SQL Server 2022（継続）
- **DB接続**: PDO（PHP）
- **データ操作**: ストアドプロシージャ（継続）/（一部PHP）
- **フロント**: PHP 7.4+ / HTML5 / CSS3 / jQuery 1.11.3

---

## 作業ディレクトリ

- **作業ディレクトリ**: `D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\`
- **検証ディレクトリ**: `\\LPG-NEMA\C\inetpub\wwwroot\support-system\`
- **本番ディレクトリ**: `\\DEV-SE\C\inetpub\wwwroot\support-system\`

---

## Phase 07 完了成果物

### 04_製造/
1. `support_dialog.php` - 入力ダイアログHTML
   - モーダルダイアログ形式
   - 入力フォーム（顧客、対応日時、商品、対応内容、報告内容等）
   - 新規・編集モード対応
   - バリデーション
   - 顧客検索サブモーダル
   - 定型文選択サブモーダル

2. `support_ajax02.php` - 入力ダイアログ用Ajax処理
   - 登録処理（action=insert）
   - 更新処理（action=update）
   - 削除処理（action=delete）
   - 顧客検索（action=search_customer, search_customer_list）
   - 定型文取得（action=get_templates）

3. `js/support_dialog.js` - 入力ダイアログ用JavaScript
   - InputDialog オブジェクト（ダイアログ開閉、保存、削除）
   - KokyakuSearchDialog オブジェクト（顧客検索）
   - TemplateDialog オブジェクト（定型文選択）

4. `css/dialog.css` - ダイアログ用CSS
   - モーダルオーバーレイ
   - 入力フォームスタイル
   - レスポンシブ対応

5. `support_main.php` - メイン画面（修正）
   - 入力ダイアログのinclude
   - ダイアログ呼び出し関数の実装
   - グローバル変数追加（currentUserId, isAdminUser）

---

## Phase 08 作業内容

### 目的
マスタ設定画面とExcel出力機能を実装する。

### 成果物

#### 1. マスタ設定画面
```
04_製造/
├── master_shohin.php       # 商品マスタ設定画面
├── master_kubun.php        # 対応区分マスタ設定画面
├── master_content.php      # 対応内容項目マスタ設定画面
├── master_teikei.php       # 定型文マスタ設定画面
├── master_ajax.php         # マスタ設定用Ajax処理
├── js/
│   └── master.js           # マスタ設定用JavaScript
├── css/
│   └── master.css          # マスタ設定用CSS
```

#### 2. Excel出力機能
```
04_製造/
├── export_excel.php        # Excel出力処理
├── templates/
│   └── excel_template.xlsx # Excel出力テンプレート（必要に応じて）
```

### 実装項目

#### マスタ設定共通機能
- 一覧表示（ページング対応）
- 新規登録
- 編集
- 削除（論理削除）
- 管理者権限制御

#### 商品マスタ（master_shohin.php）
- 商品コード（自動採番または手動入力）
- 商品名
- 表示順
- 有効フラグ

#### 対応区分マスタ（master_kubun.php）
- 対応区分コード
- 対応区分名
- 表示順
- 有効フラグ

#### 対応内容項目マスタ（master_content.php）
- 項目コード
- 項目名
- 表示順
- 有効フラグ

#### 定型文マスタ（master_teikei.php）
- 定型文コード
- 定型文名
- 定型文内容
- 表示順
- 有効フラグ

#### Excel出力機能（export_excel.php）
- 検索条件に基づく一覧出力
- ヘッダー行設定
- 日付フォーマット
- 文字コード対応（Shift-JIS変換）
- ファイル名（年月日時分秒）

### 格納先
- `D:\#M\PG_DATA\OIS社内システム\PG_DATA\サポート報告書WEB\04_製造\`

---

## 必須参照ドキュメント

### 規約書
1. `01_規約/開発規約書.md` - 開発の基本方針
2. `01_規約/コーディング規約書.md` - コーディングルール

### 設計書
1. `03_設計/画面設計書/master_settings.md` - マスタ設定画面設計

### Phase 07成果物（参照用）
1. `04_製造/support_main.php` - メイン画面（ナビゲーション参照）
2. `04_製造/support_ajax02.php` - Ajax処理パターン参照
3. `04_製造/support_dialog.php` - モーダルダイアログパターン
4. `04_製造/includes/` - 基盤ファイル
5. `04_製造/js/common.js` - 共通JavaScript
6. `04_製造/js/support_dialog.js` - ダイアログJS参照

---

## 作業進行の制約

1. **大容量ファイルの分割処理**
   - ファイル読み込みは必要に応じて分割
   - ファイル書き込みも大きい場合は分割

2. **成果物出力**
   - 作業ディレクトリのみにファイル出力
   - チャットでは出力結果の報告のみ

3. **トークン節約**
   - 長尺タスクは分割処理
   - 不要な出力を控える

4. **チャット容量管理**
   - 容量オーバーになる前に次チャット立ち上げを促す
   - プロンプトファイルを生成して継続性を確保

---

## データベース情報

### M_商品テーブル

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|------|------|
| 商品コード | int | ○ | 主キー |
| 商品名 | nvarchar(50) | ○ | 商品名 |
| 表示順 | int | - | ソート用 |
| 登録日時 | datetime | ○ | 登録日時 |
| 更新日時 | datetime | - | 更新日時 |
| 削除日時 | datetime | - | 論理削除日時 |

### M_対応区分テーブル

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|------|------|
| 対応区分コード | int | ○ | 主キー |
| 対応区分名 | nvarchar(50) | ○ | 区分名 |
| 表示順 | int | - | ソート用 |
| 登録日時 | datetime | ○ | 登録日時 |
| 更新日時 | datetime | - | 更新日時 |
| 削除日時 | datetime | - | 論理削除日時 |

### M_対応内容項目テーブル

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|------|------|
| 項目コード | int | ○ | 主キー（1～20） |
| 項目名 | nvarchar(50) | ○ | 項目名 |
| 表示順 | int | - | ソート用 |
| 登録日時 | datetime | ○ | 登録日時 |
| 更新日時 | datetime | - | 更新日時 |
| 削除日時 | datetime | - | 論理削除日時 |

### M_定型文テーブル

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|------|------|
| 定型文コード | int | ○ | 主キー |
| 定型文名 | nvarchar(100) | ○ | 定型文タイトル |
| 定型文内容 | nvarchar(max) | ○ | 定型文本文 |
| 表示順 | int | - | ソート用 |
| 登録日時 | datetime | ○ | 登録日時 |
| 更新日時 | datetime | - | 更新日時 |
| 削除日時 | datetime | - | 論理削除日時 |

---

## Excel出力仕様

### 出力項目

| No | 項目名 | データ元 | 備考 |
|----|-------|---------|------|
| 1 | No | - | 連番 |
| 2 | 対応日 | 対応開始日時 | YYYY/MM/DD形式 |
| 3 | 開始時刻 | 対応開始日時 | HH:MM形式 |
| 4 | 終了時刻 | 対応終了日時 | HH:MM形式 |
| 5 | 顧客名 | SQL_顧客.顧客名 | - |
| 6 | 顧客担当者 | 顧客担当者名 | - |
| 7 | 商品 | 商品名1,2,3 | カンマ区切り |
| 8 | 作業担当 | SQL_作業担当.担当者名 | - |
| 9 | 対応区分 | M_対応区分.対応区分名 | - |
| 10 | 対応内容 | 対応内容フラグ | チェック項目 |
| 11 | 報告内容 | 報告内容 | 全文 |
| 12 | 引継担当 | SQL_作業担当.担当者名 | - |

### 出力形式
- ファイル形式: CSV（Excel互換）
- 文字コード: Shift-JIS（Excelで開きやすいように）
- 改行コード: CRLF
- ファイル名: `サポート報告書一覧_YYYYMMDD_HHMMSS.csv`

---

## 作業開始指示

1. 上記の必須参照ドキュメントを読み込む
2. マスタ設定画面設計書（master_settings.md）を確認
3. 商品マスタ設定画面を作成
4. 対応区分マスタ設定画面を作成
5. 対応内容項目マスタ設定画面を作成
6. 定型文マスタ設定画面を作成
7. master_ajax.phpを作成（CRUD処理）
8. Excel出力機能を作成
9. header.php、support_main.phpのナビゲーション確認・修正
10. 動作確認項目を整理
11. Phase 09用プロンプトを生成

---

## 確認事項

Phase 08開始時に以下を確認してください：

- [ ] 04_製造/support_main.php を読み込んだ
- [ ] 04_製造/support_ajax02.php を読み込んだ
- [ ] 04_製造/support_dialog.php を読み込んだ
- [ ] 04_製造/includes/ 各ファイルを参照した
- [ ] 04_製造/js/common.js を読み込んだ
- [ ] 04_製造/templates/header.php を読み込んだ（ナビゲーション確認）
- [ ] 03_設計/画面設計書/master_settings.md を参照した（存在確認）

上記確認後、作業を開始してください。

---

## 品質チェックリスト

Phase 08完了時に以下を確認：

### マスタ設定画面
- [ ] 商品マスタの一覧表示が正常か
- [ ] 商品マスタの新規登録が動作するか
- [ ] 商品マスタの編集が動作するか
- [ ] 商品マスタの削除が動作するか
- [ ] 対応区分マスタが正常に動作するか
- [ ] 対応内容項目マスタが正常に動作するか
- [ ] 定型文マスタが正常に動作するか
- [ ] 管理者のみアクセス可能か（権限制御）
- [ ] バリデーションエラーが適切に表示されるか

### Excel出力
- [ ] Excel出力が正常にダウンロードできるか
- [ ] 検索条件が反映されているか
- [ ] 文字化けがないか
- [ ] 日付フォーマットが正しいか
- [ ] 全項目が出力されているか

---

## 権限制御

| 機能 | 一般ユーザー | 管理者 |
|------|------------|--------|
| マスタ設定メニュー表示 | × | ○ |
| マスタ設定画面アクセス | × | ○ |
| マスタ新規登録 | × | ○ |
| マスタ編集 | × | ○ |
| マスタ削除 | × | ○ |
| Excel出力 | ○ | ○ |

---

## 実装優先度

1. **最優先**: Excel出力機能（業務で頻繁に使用）
2. **高**: 定型文マスタ（入力ダイアログで使用）
3. **中**: 商品マスタ、対応区分マスタ
4. **低**: 対応内容項目マスタ（変更頻度が低い）

---

**作成者**: Claude AI  
**Phase 07完了日**: 2025-11-25
