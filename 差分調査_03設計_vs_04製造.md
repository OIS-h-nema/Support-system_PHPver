# 03_設計と04_製造のメイン画面入力ダイアログ（新規保存）差分

## 見つかった相違点
- **保存後のクローズ処理の扱い**
  - 設計書では保存成功時に `closeInputDialog()` を呼び、モーダル非表示とフォームリセットをまとめて行う想定。クローズ時は変更有無を確認し、`resetForm()` で初期化する流れが明記されている。【F:03_設計/画面設計書/input_dialog.md†L741-L765】
  - 製造実装では保存成功時に `formChanged` をfalseに戻しつつオーバーレイクラスを外すのみで、設計で想定していた `close()`/リセット処理を経由せずに終了している（フォーム値が画面上に残る動作）。【F:04_製造/js/support_dialog.js†L370-L405】

- **新規／更新判定の位置付け**
  - 設計書ではサーバー側でバリデーション後に「新規/更新判定」を行い、SEQNO採番も含めてサーバー側で分岐するフローが示されている。【F:03_設計/画面設計書/input_dialog.md†L333-L406】
  - 製造実装ではクライアントが `action` に `insert`/`update` を明示して送信し、サーバー側はそのアクション値に従って処理を固定的に分けている。設計で想定された自動判定フローとは役割分担が異なる。【F:04_製造/js/support_dialog.js†L373-L405】【F:04_製造/support_ajax02.php†L27-L56】

- **サーバー保存手段**
  - 設計書では `UPD_D_作業報告` ストアドプロシージャを呼び出して登録・更新する前提となっている。【F:03_設計/画面設計書/input_dialog.md†L390-L404】
  - 製造実装では `COUNTUP_SYS_SEQNO` で採番した後、PHP側で直接 `INSERT INTO D_作業報告 ...` を実行しており、ストアドプロシージャを利用していない。更新処理も同様にSQL直書きとなっているため、実装手段が設計と異なる。【F:04_製造/support_ajax02.php†L62-L192】

- **採番ロジックのフォールバック**
  - 設計書には SEQNO 採番失敗時のフォールバック（MAX+1）やネットワークフラグ固定値などの記載はなく、標準フローのみ記述されている。【F:03_設計/画面設計書/input_dialog.md†L384-L404】
  - 製造実装では `COUNTUP_SYS_SEQNO` が失敗した場合に `MAX(SEQNO)+1` で補完する処理や、`ネットワークFLG=1` を固定セットする実装が追加されており、設計外の挙動が存在する。【F:04_製造/support_ajax02.php†L75-L179】

## まとめ
新規保存に関して、設計では「保存成功後の共通クローズ処理」「サーバー側での新規／更新自動判定とストアド実行」を軸にしているのに対し、製造物はクライアントでアクションを固定し、PHPで直接SQLを発行する実装へ変更されている。また、保存成功時にフォームリセットを行わないなど、画面側の挙動にも設計との差異が見られる。

### 設計書・実装のすり合わせ方針
- **保存後のクローズ処理**: 実際の04_製造は保存成功後にモーダルを閉じず、オーバーレイ解除と `formChanged=false` のみを行う。設計書側はこの動線に合わせて「保存成功後はダイアログを閉じずに一覧再描画」と記載し、明示的なクローズ操作（×ボタン／キャンセル）時に `resetForm()` を通すことを残す。
- **保存処理本体**: バリデーション後のフローは設計書に寄せ、サーバー側で新規／更新判定を実施し `UPD_D_作業報告` を呼ぶ形に統一する。クライアント送信時の `action=insert/update` 固定は廃し、単一エンドポイントに必要情報のみ渡してサーバーで判定する方針とすることで差分を解消する。

## ナレッジ（SUPPORT_PG.accdb.AsText.20251118_1329）の動作確認
- サポート報告入力ダイアログの保存ボタン（`cmdOckOX`）は必須項目の検証後に `V_00001XJT000fe` を呼び出し、保存後に一覧再描画とフォーム初期化（各フィールドのクリアやチェック状態リセット）を実施している。設計で想定していた「保存後に閉じてリセット」の流れに近いが、実装は閉じずに即時再入力できる状態へ戻す挙動となっている。【F:ナレッジ/SUPPORT_PG.accdb.AsText.20251118_1329/サポート報告_入力ダイアログ.form†L3809-L3859】
- 保存処理本体の `V_00001XJT000fe` では、オンライン時に `UPD_D_作業報告` ストアドプロシージャを呼び出し、`@OUTPUTSEQNO` で戻り値を受け取って成功／失敗を判定する。クライアント側で `action` を切り替える製造実装ではなく、サーバー側のプロシージャに一任する設計方針に近い構造となっている。【F:ナレッジ/SUPPORT_PG.accdb.AsText.20251118_1329/サポート報告_入力ダイアログ.form†L4176-L4418】

**判断**: ナレッジのAccess版は、保存処理をサーバー側ストアドプロシージャで完結させ、保存後に画面状態をリセットする点で03_設計の仕様に近い。一方でモーダルを閉じずに再入力させるUI挙動など、細部では現行製造物とも異なる独自仕様となっている。
