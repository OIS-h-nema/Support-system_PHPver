# 機能要件定義書

**作成日**: 2025-11-20  
**バージョン**: 1.0  
**Phase**: 02

---

## 1. システム概要

### 1.1 システム名
サポート報告書WEB管理システム

### 1.2 目的
自社社員向けに、顧客からの日々の問い合わせとその対応内容を記録・管理・分析するシステム

### 1.3 システム化の目的
- MS AccessからWEBシステムへ移行
- ネットワーク経由での複数ユーザー同時利用
- モバイルデバイスからのアクセス対応
- データの一元管理と共有の促進

---

## 2. システム機能一覧

### 2.1 機能分類

| 大分類 | 中分類 | 小分類 | 説明 | 優先度 |
|--------|--------|--------|------|-------|
| **認証** | ログイン | ログイン | ユーザー認証とセッション開始 | A |
| | | ログアウト | セッション終了 | A |
| | | セッション管理 | タイムアウト管理（9時間） | A |
| **サポート報告** | 一覧表示 | 全件表示 | サポート報告一覧の表示 | A |
| | | 検索 | 条件を指定して検索 | A |
| | | ソート | カラムごとのソート | B |
| | | ページング | 大量データの分割表示 | B |
| | 登録 | 新規登録 | サポート報告の新規作成 | A |
| | | 顧客検索 | 顧客情報の検索と選択 | A |
| | | 定型文挿入 | 定型文の選択と挿入 | B |
| | | 下書き保存 | 一時保存機能 | C |
| | 更新 | データ更新 | 既存データの編集 | A |
| | | 履歴管理 | 更新履歴の記録 | C |
| | 削除 | 論理削除 | データの論理削除 | A |
| | | 削除取消 | 削除の取り消し | C |
| | 出力 | Excel出力 | 検索結果のExcel出力 | B |
| | | 印刷 | 個別レポート印刷 | C |
| | | PDF出力 | PDF形式での出力 | C |
| **マスタ管理** | 商品マスタ | 一覧表示 | 商品一覧の表示 | B |
| | | 登録 | 商品の新規登録 | B |
| | | 更新 | 商品情報の更新 | B |
| | | 削除 | 商品の削除 | B |
| | 対応区分マスタ | 一覧表示 | 対応区分一覧の表示 | C |
| | | 登録 | 対応区分の新規登録 | C |
| | | 更新 | 対応区分の更新 | C |
| | | 削除 | 対応区分の削除 | C |
| | 対応内容項目マスタ | 一覧表示 | 対応内容項目一覧の表示 | C |
| | | 登録 | 項目の新規登録 | C |
| | | 更新 | 項目の更新 | C |
| | | 削除 | 項目の削除 | C |
| | 定型文マスタ | 一覧表示 | 定型文一覧の表示 | B |
| | | 登録 | 定型文の新規登録 | B |
| | | 更新 | 定型文の更新 | B |
| | | 削除 | 定型文の削除 | B |
| **集計・分析** | 統計表示 | 担当者別集計 | 担当者ごとの対応件数 | C |
| | | 対応区分別集計 | 区分ごとの集計 | C |
| | | 月別集計 | 月ごとの推移 | C |
| | | ダッシュボード | 統計情報のグラフ表示 | C |

**優先度**:
- **A**: Phase 09-11で必須実装
- **B**: Phase 12で実装
- **C**: 将来拡張機能

---

## 3. 機能詳細仕様

### 3.1 認証機能

#### 3.1.1 F001: ログイン機能

**機能概要**:
ユーザー認証を行い、システムへのアクセスを許可する

**入力**:
- ユーザーコード（作業担当者コード）
- パスワード

**処理**:
1. 入力値のバリデーション
2. SQL_作業担当テーブルで認証
3. 認証成功時、セッションに担当者情報を格納
4. メイン画面へリダイレクト

**出力**:
- 認証成功: メイン画面表示
- 認証失敗: エラーメッセージ表示

**エラー処理**:
- ユーザーコードまたはパスワードが空: 「入力してください」
- 認証失敗: 「ユーザーコードまたはパスワードが正しくありません」

**非機能要件**:
- パスワードはハッシュ化して保存（将来対応）
- ログイン試行回数の制限（将来対応）

---

#### 3.1.2 F002: ログアウト機能

**機能概要**:
セッションを破棄してログイン画面に戻る

**処理**:
1. セッション情報を破棄
2. ログイン画面へリダイレクト

---

#### 3.1.3 F003: セッション管理機能

**機能概要**:
ログイン状態を維持し、タイムアウトを管理

**セッション情報**:
- ユーザーコード
- 担当者名
- 部門コード
- 権限レベル（将来対応）
- 最終アクセス時刻

**タイムアウト**:
- 9時間（32400秒）
- タイムアウト時はログイン画面へ強制遷移

---

### 3.2 サポート報告管理機能

#### 3.2.1 F101: サポート報告一覧表示機能

**機能概要**:
登録されているサポート報告を一覧表示

**表示項目**:
- SEQNO（非表示、内部利用）
- 作業担当者名
- 商品名
- 対応開始日時
- 対応内容項目（チェック済み項目）
- 顧客名
- 報告内容（先頭100文字）
- 操作ボタン（詳細/修正）

**初期表示**:
- 全件取得（最新50件）
- 対応開始日時の降順

**ページング**:
- 1ページ50件
- ページ番号表示と前後移動

**ソート**:
- カラムクリックで昇順/降順切り替え
- 対応開始日時、作業担当、顧客名でソート可能

---

#### 3.2.2 F102: サポート報告検索機能

**機能概要**:
条件を指定してサポート報告を検索

**検索条件**:

| 項目名 | 種類 | 検索方法 |
|--------|------|---------|
| 対応日（開始） | 日付範囲 | BETWEEN |
| 対応日（終了） | 日付範囲 | BETWEEN |
| 作業担当 | コンボボックス | 完全一致 |
| 顧客名 | テキスト | 部分一致（LIKE %keyword%） |
| 商品 | コンボボックス | 完全一致 |
| 対応区分 | コンボボックス | 完全一致 |
| 対応内容項目 | チェックボックス | OR検索（いずれか該当） |
| キーワード | テキスト | 報告内容の部分一致 |

**検索処理**:
1. 検索条件を収集
2. Ajax通信でサーバーへ送信
3. 検索結果を受信してDOM更新

**検索結果**:
- 該当件数表示
- 検索条件に一致するデータを一覧表示

---

#### 3.2.3 F103: サポート報告新規登録機能

**機能概要**:
新しいサポート報告を登録

**入力画面**:
入力ダイアログをモーダル表示

**入力項目**:

| 項目名 | 必須 | 初期値 | バリデーション |
|--------|------|--------|--------------|
| 顧客コード | ○ | - | 数値、顧客マスタに存在 |
| 部門 | ○ | ログインユーザーの部門 | - |
| 顧客担当者名 | | - | 50文字以内 |
| 対応開始日時 | ○ | 現在日時 | 日時形式 |
| 対応終了日時 | | 対応開始日時 | 開始日時以降 |
| 商品1 | | - | 商品マスタに存在 |
| 商品2 | | - | 商品マスタに存在 |
| 商品3 | | - | 商品マスタに存在 |
| 作業担当 | ○ | ログインユーザー | - |
| 対応区分 | | - | 対応区分マスタに存在 |
| 対応内容項目 | | - | 最大20項目 |
| 報告内容 | ○ | - | 必須 |
| 引継担当 | | - | 担当者マスタに存在 |

**処理フロー**:
1. 入力値のバリデーション
2. SEQNO自動採番（COUNTUP_SYS_SEQNO）
3. UPD_D_作業報告ストアドプロシージャ実行
4. 成功時、一覧画面を更新して閉じる

---

#### 3.2.4 F104: サポート報告更新機能

**機能概要**:
既存のサポート報告を編集

**処理**:
1. SEQNOを指定してデータ取得
2. 入力ダイアログに表示
3. 編集後、バリデーション
4. UPD_D_作業報告ストアドプロシージャ実行
5. 成功時、一覧画面を更新

**権限制御**:
- 一般ユーザー: 自分が登録したデータのみ編集可
- 管理者: すべてのデータ編集可

---

#### 3.2.5 F105: サポート報告削除機能

**機能概要**:
サポート報告を論理削除

**処理**:
1. 削除確認ダイアログ表示
2. OKの場合、DEL_D_作業報告ストアドプロシージャ実行
3. 削除日時に現在日時を設定
4. 一覧から非表示

**権限制御**:
- 一般ユーザー: 自分が登録したデータのみ削除可
- 管理者: すべてのデータ削除可

---

#### 3.2.6 F106: 顧客検索機能

**機能概要**:
顧客情報を検索して選択

**検索条件**:
- 顧客コード
- 顧客名（部分一致）
- 部門

**処理**:
1. 検索ダイアログ表示
2. SQL_顧客テーブルから検索
3. 検索結果を一覧表示
4. 選択した顧客情報を入力ダイアログに反映

---

#### 3.2.7 F107: 定型文選択機能

**機能概要**:
定型文を選択して報告内容に挿入

**処理**:
1. 定型文選択ダイアログ表示
2. ログインユーザーの部門でフィルタリング
3. M_定型文から取得して表示
4. 選択した定型文を報告内容欄に挿入

**挿入方法**:
- カーソル位置に挿入
- または既存テキストの末尾に追加

---

#### 3.2.8 F108: Excel出力機能

**機能概要**:
現在の検索結果をExcelファイルとしてダウンロード

**出力項目**:
- SEQNO
- 対応開始日時
- 対応終了日時
- 顧客名
- 顧客担当者名
- 部門名
- 商品名1〜3
- 作業担当者名
- 対応区分名
- 対応内容項目（チェック済み項目）
- 報告内容
- 引継担当者名

**ファイル名**:
`サポート報告書_YYYYMMDD_HHMMSS.xlsx`

**処理**:
1. 現在の検索条件を取得
2. サーバー側でExcelファイル生成
3. ダウンロード開始

---

### 3.3 マスタ管理機能

#### 3.3.1 F201: 商品マスタ管理

##### F201-1: 商品マスタ一覧表示

**表示項目**:
- 部門名
- 商品コード
- 商品名
- 使用区分
- 更新日時
- 操作ボタン（修正/削除）

##### F201-2: 商品マスタ登録

**入力項目**:
- 部門コード（必須）
- 商品コード（自動採番または手動入力）
- 商品名（必須、255文字以内）
- 使用区分（使用する/使用しない）

**処理**:
UPD_M_商品ストアドプロシージャ実行

##### F201-3: 商品マスタ更新

一覧から選択した商品の情報を修正

##### F201-4: 商品マスタ削除

**処理**:
1. 削除確認
2. DEL_商品ストアドプロシージャ実行
3. DELDATA_商品へ移動

**権限制御**:
管理者のみアクセス可能

---

#### 3.3.2 F202: 対応区分マスタ管理

商品マスタと同様の構成

**入力項目**:
- 対応区分コード
- 対応区分名

---

#### 3.3.3 F203: 対応内容項目マスタ管理

商品マスタと同様の構成

**入力項目**:
- 項目コード（1〜20）
- 項目名

**特記事項**:
- 項目コードは1〜20に限定
- 削除時は入力ダイアログのチェックボックス表示に影響

---

#### 3.3.4 F204: 定型文マスタ管理

##### F204-1: 定型文マスタ一覧表示

**表示項目**:
- 部門名
- 定型文コード
- 定型文（先頭80文字）
- 作成日時
- 更新日時
- 操作ボタン（修正/削除）

##### F204-2: 定型文マスタ登録

**入力項目**:
- 部門コード（必須）
- 定型文コード（自動採番）
- 定型文（必須、MAX文字）

**処理**:
UPD_M_定型文ストアドプロシージャ実行

##### F204-3: 定型文マスタ更新

一覧から選択した定型文を修正

##### F204-4: 定型文マスタ削除

**処理**:
1. 削除確認
2. DEL_定型文ストアドプロシージャ実行
3. DELDATA_定型文へ移動

**権限制御**:
管理者のみアクセス可能

---

### 3.4 集計・分析機能（将来拡張）

#### 3.4.1 F301: 担当者別集計

**集計項目**:
- 担当者名
- 対応件数
- 平均対応時間
- 対応区分別内訳

#### 3.4.2 F302: 対応区分別集計

**集計項目**:
- 対応区分名
- 件数
- 割合

#### 3.4.3 F303: 月別集計

**集計項目**:
- 年月
- 件数
- 前月比

#### 3.4.4 F304: ダッシュボード

**表示内容**:
- 今日の対応件数
- 今月の対応件数
- 担当者別ランキング
- 対応区分円グラフ
- 月別推移グラフ

---

## 4. データ連携要件

### 4.1 外部データベース連携

#### 4.1.1 顧客マスタ連携

**連携元**: 基幹システムの顧客マスタ（SQL_顧客）

**連携方法**: PDO接続で直接参照

**取得項目**:
- 顧客コード
- 顧客名
- 住所
- 電話番号
- 担当部門

---

#### 4.1.2 担当者マスタ連携

**連携元**: 人事システムの社員マスタ（SQL_作業担当）

**連携方法**: PDO接続で直接参照

**取得項目**:
- 担当者コード
- 氏名
- 所属部門
- 役職
- メールアドレス

---

#### 4.1.3 部門マスタ連携

**連携元**: 組織マスタ（SQL_部門）

**連携方法**: PDO接続で直接参照

**取得項目**:
- 部門コード
- 部門名
- 上位部門コード

---

## 5. セキュリティ要件

### 5.1 認証・認可

#### 5.1.1 認証

- ユーザーコード+パスワードによる認証
- セッション管理（9時間タイムアウト）
- HTTPS通信（将来対応）

#### 5.1.2 認可

**権限レベル**:
- **一般ユーザー**: 
  - 自分のデータのみ編集・削除可能
  - マスタ設定画面へのアクセス不可
- **管理者**:
  - すべてのデータ編集・削除可能
  - マスタ設定画面へのアクセス可能

---

### 5.2 データ保護

#### 5.2.1 SQLインジェクション対策

- PDOのプリペアドステートメント使用
- ストアドプロシージャ経由でのデータアクセス

#### 5.2.2 XSS対策

- 出力時のHTMLエスケープ処理
- htmlspecialchars()関数の使用

#### 5.2.3 CSRF対策

- トークン生成と検証（将来対応）

---

## 6. パフォーマンス要件

### 6.1 応答時間

| 処理 | 目標応答時間 |
|------|-------------|
| 画面表示 | 2秒以内 |
| 検索処理 | 3秒以内 |
| 登録・更新 | 2秒以内 |
| Excel出力 | 10秒以内（1000件） |

### 6.2 同時アクセス数

- 最大50ユーザーの同時アクセスに対応

### 6.3 データ量

- D_作業報告: 100万件まで対応
- 検索結果: 最大10,000件表示

---

## 7. ユーザビリティ要件

### 7.1 操作性

- 直感的なUI
- マウス操作のみで完結
- キーボードショートカット対応（将来対応）

### 7.2 レスポンシブ対応

- PC: 1024px以上
- タブレット: 768px〜1023px
- スマートフォン: 767px以下

### 7.3 ブラウザ対応

- Google Chrome（最新版）
- Microsoft Edge（最新版）
- Firefox（最新版）
- Safari（最新版）

---

## 8. 運用要件

### 8.1 バックアップ

- 日次バックアップ（深夜バッチ）
- バックアップ世代管理（7世代）

### 8.2 ログ管理

- アクセスログ
- エラーログ
- 操作ログ（将来対応）

### 8.3 監視

- サーバー稼働監視
- データベース監視
- エラー通知

---

## 9. Phase別実装計画

### Phase 09-10: DB接続まで
- F001: ログイン機能
- F002: ログアウト機能
- F003: セッション管理機能
- F101: サポート報告一覧表示機能（簡易版）

### Phase 11: メイン画面簡易版
- F101: サポート報告一覧表示機能（完全版）
- F102: サポート報告検索機能
- F103: サポート報告新規登録機能
- F104: サポート報告更新機能
- F105: サポート報告削除機能

### Phase 12: マスタ管理
- F106: 顧客検索機能
- F107: 定型文選択機能
- F108: Excel出力機能
- F201〜F204: マスタ管理機能

### Phase 13以降: 拡張機能
- F301〜F304: 集計・分析機能
- その他の拡張機能

---

## 10. 機能要件の検証

### 10.1 受入テスト項目

各機能について以下を検証：
- 正常系動作
- 異常系動作
- バリデーション
- 権限制御
- パフォーマンス

### 10.2 テストケース

別途「テスト仕様書」にて詳細を定義（Phase 06で作成予定）

---

**完了日**: 2025-11-20  
**レビュー**: Phase 02完了時に最終確認
**承認**: Phase 03開始前に承認必要
