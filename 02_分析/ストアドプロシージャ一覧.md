# ストアドプロシージャ一覧

**作成日**: 2025-11-20  
**バージョン**: 1.0  
**Phase**: 02

---

## 1. ストアドプロシージャ概要

SUPPORTDB データベースには合計18個のストアドプロシージャが定義されています。
これらはデータの登録・更新・削除・取得を行う基本的なCRUD操作を提供します。

---

## 2. ストアドプロシージャ一覧

| No | SP名 | 分類 | 対象テーブル | 説明 |
|----|------|------|-------------|------|
| 1 | COUNTUP_SYS_SEQNO | システム | SYS_SEQNO | シーケンス番号をカウントアップ |
| 2 | CRE_DB_BACKUP | システム | - | データベースのバックアップ作成 |
| 3 | UPD_D_作業報告 | 更新 | D_作業報告 | 作業報告の登録・更新 |
| 4 | DEL_D_作業報告 | 削除 | D_作業報告 | 作業報告の論理削除 |
| 5 | SEL_D_作業報告_同期 | 取得 | D_作業報告 | 同期用データの取得 |
| 6 | GET_D_作業報告_最終更新 | 取得 | D_作業報告 | 担当者の最終更新日時取得 |
| 7 | UPD_M_商品 | 更新 | M_商品 | 商品マスタの登録・更新 |
| 8 | SEL_M_商品 | 取得 | M_商品 | 商品マスタの範囲検索 |
| 9 | DEL_商品 | 削除 | M_商品 | 商品マスタの削除 |
| 10 | UPD_M_対応区分 | 更新 | M_対応区分 | 対応区分マスタの登録・更新 |
| 11 | SEL_M_対応区分 | 取得 | M_対応区分 | 対応区分マスタの範囲検索 |
| 12 | DEL_対応区分 | 削除 | M_対応区分 | 対応区分マスタの削除 |
| 13 | UPD_M_対応内容項目 | 更新 | M_対応内容項目 | 対応内容項目マスタの登録・更新 |
| 14 | SEL_M_対応内容項目 | 取得 | M_対応内容項目 | 対応内容項目マスタの範囲検索 |
| 15 | DEL_対応内容項目 | 削除 | M_対応内容項目 | 対応内容項目マスタの削除 |
| 16 | UPD_M_定型文 | 更新 | M_定型文 | 定型文マスタの登録・更新 |
| 17 | SEL_M_定型文 | 取得 | M_定型文 | 定型文マスタの範囲検索 |
| 18 | DEL_定型文 | 削除 | M_定型文 | 定型文マスタの削除 |
| 19 | UPD_SYS_管理 | 更新 | SYS_管理 | システム管理情報の更新 |
| 20 | GET_TBL | 取得 | - | 任意のテーブルを全取得（汎用） |

---

## 3. ストアドプロシージャ詳細

### 3.1 システム関連

#### 3.1.1 COUNTUP_SYS_SEQNO

**用途**: D_作業報告のSEQNOを採番するためのカウントアップ処理

**パラメータ**: なし

**処理内容**:
```sql
UPDATE SYS_SEQNO
SET SEQNO = SEQNO + COUNTVAL
```

**特記事項**:
- UPD_D_作業報告から呼び出される
- トランザクション内で実行されるため、同時実行時も安全

**WEB化時の対応**:
- そのまま継続使用

---

#### 3.1.2 CRE_DB_BACKUP

**用途**: データベースの完全バックアップを作成

**パラメータ**:
- `@BackupPath` (NVARCHAR(500)): バックアップファイルの保存先パス

**処理内容**:
動的SQLを使用してBACKUPコマンドを実行

**特記事項**:
- 管理者権限が必要
- ファイルパスのバリデーションが必要

**WEB化時の対応**:
- WEB画面からは呼び出さない（運用管理用）
- サーバー側のバッチ処理で定期実行を推奨

---

#### 3.1.3 UPD_SYS_管理

**用途**: システム管理情報を動的に更新

**パラメータ**:
- `@入力マシン` (VARCHAR(50)): マシン名
- `@フィールド名` (VARCHAR(50)): 更新するフィールド名
- `@値` (VARCHAR(50)): 設定する値

**処理内容**:
動的SQLでフィールドを指定して更新

**WEB化時の対応**:
- Access時代の同期管理用
- WEBでは使用しない（セッション管理に置き換え）

---

#### 3.1.4 GET_TBL

**用途**: 任意のテーブルの全データを取得（デバッグ・管理用）

**パラメータ**:
- `@テーブル名` (VARCHAR(50)): 取得するテーブル名

**処理内容**:
```sql
SELECT * FROM [テーブル名]
```

**セキュリティ注意**:
- SQLインジェクションのリスクあり
- 本番環境では使用不可

**WEB化時の対応**:
- 使用しない（必要に応じて専用のSELECT SPを作成）

---

### 3.2 D_作業報告関連

#### 3.2.1 UPD_D_作業報告

**用途**: 作業報告の新規登録・更新を行う

**パラメータ（入力）**:
- `@SEQNO` (BIGINT): シーケンス番号
- `@対応開始日時` (DATETIME): 対応開始日時
- `@対応終了日時` (DATETIME): 対応終了日時
- `@顧客コード` (BIGINT): 顧客コード
- `@顧客担当者名` (NVARCHAR(255)): 顧客担当者名
- `@部門コード` (BIGINT): 部門コード
- `@商品コード1` (BIGINT): 商品コード1
- `@商品コード2` (BIGINT): 商品コード2
- `@商品コード3` (BIGINT): 商品コード3
- `@作業担当コード` (BIGINT): 作業担当コード
- `@対応区分コード` (BIGINT): 対応区分コード
- `@結果コード` (BIGINT): 結果コード
- `@引継担当コード` (BIGINT): 引継担当コード
- `@報告内容` (NVARCHAR(MAX)): 報告内容
- `@お客様サイン` (NVARCHAR(255)): お客様サイン
- `@確認日付` (DATETIME): 確認日付
- `@作成日時` (DATETIME): 作成日時
- `@同期日時` (DATETIME): 同期日時
- `@更新日時` (DATETIME): 更新日時
- `@削除日時` (DATETIME): 削除日時
- `@入力マシン` (NVARCHAR(255)): 入力マシン
- `@更新マシン` (NVARCHAR(255)): 更新マシン
- `@ネットワークFLG` (BIT): ネットワークフラグ
- `@対応内容項目名1〜20` (NVARCHAR(255)): 対応内容項目名1〜20
- `@対応内容フラグ1〜20` (BIGINT): 対応内容フラグ1〜20

**パラメータ（出力）**:
- `@OUTPUTSEQNO` (INT OUTPUT): 登録・更新されたSEQNO

**処理ロジック**:
1. SEQNO + 入力マシンでレコード存在チェック
2. 存在する場合 → UPDATE処理
3. 存在しない場合:
   - COUNTUP_SYS_SEQNOで新しいSEQNOを採番
   - INSERT処理

**特記事項**:
- UPSERT（存在すれば更新、なければ挿入）のロジック
- 主キーが複合キー（SEQNO + 入力マシン）のため、マシンごとに異なるデータを保持可能
- Access時代のローカル/サーバー同期の名残

**WEB化時の対応**:
- 入力マシンの扱いを見直し
- WEBではセッションIDやユーザーIDで代替を検討
- トランザクション処理を追加

---

#### 3.2.2 DEL_D_作業報告

**用途**: 作業報告を論理削除

**パラメータ（入力）**:
- `@SEQNO` (BIGINT): 削除対象のシーケンス番号
- `@削除日時` (DATETIME): 削除日時
- `@更新マシン` (NVARCHAR(255)): 更新マシン名

**パラメータ（出力）**:
- `@OUTPUTSEQNO` (INT OUTPUT): 削除されたSEQNO（成功時）

**処理ロジック**:
```sql
UPDATE D_作業報告
SET 削除日時 = @削除日時, 更新マシン = @更新マシン
WHERE SEQNO = @SEQNO
```

**特記事項**:
- 物理削除ではなく論理削除
- 削除日時がNULLでないレコードは削除済みとして扱う

**WEB化時の対応**:
- そのまま継続使用
- 削除権限のチェックを追加

---

#### 3.2.3 SEL_D_作業報告_同期

**用途**: Access側との同期用に更新されたデータを取得

**パラメータ**:
- `@最終更新日付` (DATETIME): 前回同期日時

**処理ロジック**:
```sql
SELECT * FROM D_作業報告
WHERE 作成日時 > @最終更新日付 
   OR 更新日時 > @最終更新日付 
   OR 削除日時 > @最終更新日付
```

**WEB化時の対応**:
- 使用しない（Access特有の同期処理）

---

#### 3.2.4 GET_D_作業報告_最終更新

**用途**: 指定した担当者の最終更新日時を取得

**パラメータ（入力）**:
- `@作業担当者コード` (INT): 担当者コード

**パラメータ（出力）**:
- `@MaxDate` (DATETIME OUTPUT): 最終更新日時

**処理ロジック**:
```sql
SELECT MAX(GREATEST(作成日時, 更新日時, 削除日時))
FROM D_作業報告
WHERE 作業担当コード = @作業担当者コード
```

**WEB化時の対応**:
- 担当者別の最終活動日時として使用可能
- ダッシュボード表示などに活用

---

### 3.3 マスタ管理（商品）

#### 3.3.1 UPD_M_商品

**用途**: 商品マスタの登録・更新

**パラメータ（入力）**:
- `@商品コード` (INT): 商品コード
- `@部門コード` (INT): 部門コード
- `@商品名` (NVARCHAR(50)): 商品名
- `@使用区分` (INT): 使用区分
- `@更新日時` (DATETIME): 更新日時
- `@入力マシン` (NVARCHAR(20)): 入力マシン

**パラメータ（出力）**:
- `@SQL処理` (NVARCHAR(10) OUTPUT): 'UPD' or 'INS'
- `@SQL処理件数` (INT OUTPUT): 処理件数

**処理ロジック**:
1. 商品コードで存在チェック
2. 存在する → UPDATE（@SQL処理='UPD'）
3. 存在しない → INSERT（@SQL処理='INS'）

**WEB化時の対応**:
- そのまま継続使用
- 入力マシンをユーザーIDに変更

---

#### 3.3.2 SEL_M_商品

**用途**: 商品マスタの範囲検索

**パラメータ**:
- `@商品コード開始` (INT): 開始商品コード
- `@商品コード終了` (INT): 終了商品コード

**処理ロジック**:
```sql
SELECT * FROM M_商品
WHERE 商品コード BETWEEN @商品コード開始 AND @商品コード終了
```

**WEB化時の対応**:
- 全件取得用に0〜999999などの範囲を指定
- または別途全件取得SPを作成

---

#### 3.3.3 DEL_商品

**用途**: 商品マスタの削除（削除履歴に移動）

**パラメータ（入力）**:
- `@商品コード` (INT): 削除する商品コード

**パラメータ（出力）**:
- `@SQL処理件数` (INT OUTPUT): 削除件数

**処理ロジック**:
1. M_商品からDELDATA_商品へINSERT（削除日時付き）
2. M_商品からDELETE

**特記事項**:
- 物理削除だが、削除履歴は保持される

**WEB化時の対応**:
- そのまま継続使用
- 削除前に使用中かどうかのチェックを追加

---

### 3.4 マスタ管理（対応区分）

#### 3.4.1 UPD_M_対応区分

**用途**: 対応区分マスタの登録・更新

**パラメータ**: UPD_M_商品と同様のパターン

**WEB化時の対応**: 継続使用

---

#### 3.4.2 SEL_M_対応区分

**用途**: 対応区分マスタの範囲検索

**WEB化時の対応**: 継続使用

---

#### 3.4.3 DEL_対応区分

**用途**: 対応区分マスタの削除

**WEB化時の対応**: 継続使用

---

### 3.5 マスタ管理（対応内容項目）

#### 3.5.1 UPD_M_対応内容項目

**用途**: 対応内容項目マスタの登録・更新

**特記事項**:
- この項目が作業報告の動的チェックボックスに使用される
- 項目コードが1〜20の範囲に制限される

**WEB化時の対応**: 継続使用

---

#### 3.5.2 SEL_M_対応内容項目

**用途**: 対応内容項目マスタの範囲検索

**WEB化時の対応**: 継続使用

---

#### 3.5.3 DEL_対応内容項目

**用途**: 対応内容項目マスタの削除

**WEB化時の対応**: 継続使用（削除時は注意）

---

### 3.6 マスタ管理（定型文）

#### 3.6.1 UPD_M_定型文

**用途**: 定型文マスタの登録・更新

**パラメータ（入力）**:
- `@部門コード` (INT): 部門コード
- `@定型文コード` (INT): 定型文コード
- `@定型文` (NVARCHAR(50)): 定型文内容
- `@作成日時` (DATETIME): 作成日時
- `@作成者コード` (INT): 作成者コード
- `@更新日時` (DATETIME): 更新日時
- `@更新者コード` (INT): 更新者コード

**パラメータ（出力）**:
- `@SQL処理` (NVARCHAR(10) OUTPUT): 'UPD' or 'INS'
- `@SQL処理件数` (INT OUTPUT): 処理件数

**特記事項**:
- 複合主キー（部門コード + 定型文コード）
- 部門ごとに定型文を管理

**WEB化時の対応**: 継続使用

---

#### 3.6.2 SEL_M_定型文

**用途**: 定型文マスタの範囲検索

**パラメータ**:
- `@部門コード開始` (INT)
- `@部門コード終了` (INT)
- `@定型文コード開始` (INT)
- `@定型文コード終了` (INT)

**WEB化時の対応**: 継続使用（ログインユーザーの部門で絞り込み）

---

#### 3.6.3 DEL_定型文

**用途**: 定型文マスタの削除

**パラメータ**:
- `@部門コード` (INT)
- `@定型文コード` (INT)

**WEB化時の対応**: 継続使用

---

## 4. WEB化時の追加が必要なストアドプロシージャ

### 4.1 検索・一覧表示用

```sql
-- 作業報告の検索
CREATE PROCEDURE SEL_D_作業報告_検索
    @対応開始日FROM DATETIME = NULL,
    @対応開始日TO DATETIME = NULL,
    @顧客コード BIGINT = NULL,
    @部門コード BIGINT = NULL,
    @作業担当コード BIGINT = NULL,
    @対応区分コード BIGINT = NULL,
    @キーワード NVARCHAR(255) = NULL,
    @ページ番号 INT = 1,
    @ページサイズ INT = 50
AS
-- 複雑な検索条件とページング処理
```

### 4.2 集計・統計用

```sql
-- 担当者別集計
CREATE PROCEDURE AGG_作業報告_担当者別

-- 対応区分別集計
CREATE PROCEDURE AGG_作業報告_対応区分別

-- 月別集計
CREATE PROCEDURE AGG_作業報告_月別
```

### 4.3 マスタ全件取得用

```sql
-- 商品マスタ全件
CREATE PROCEDURE SEL_M_商品_ALL

-- コンボボックス用（使用中のみ）
CREATE PROCEDURE SEL_M_商品_コンボ
```

---

## 5. エラーハンドリングとトランザクション

### 5.1 現状の問題点
- エラーハンドリングが未実装
- トランザクション制御が不十分

### 5.2 WEB化時の改善
すべてのストアドプロシージャに以下を追加：

```sql
BEGIN TRY
    BEGIN TRANSACTION
    
    -- 処理本体
    
    COMMIT TRANSACTION
    RETURN 0  -- 成功
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION
    
    -- エラー情報を返す
    SELECT 
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_MESSAGE() AS ErrorMessage
    
    RETURN -1  -- エラー
END CATCH
```

---

## 6. パフォーマンス最適化

### 6.1 インデックスの活用
- WHERE句で使用されるカラムにインデックスを追加
- 検索条件の多い D_作業報告 には複合インデックスを検討

### 6.2 ページング処理
```sql
-- SQL Server 2012以降
SELECT * 
FROM D_作業報告
ORDER BY SEQNO DESC
OFFSET (@ページ番号 - 1) * @ページサイズ ROWS
FETCH NEXT @ページサイズ ROWS ONLY
```

---

## 7. セキュリティ考慮事項

### 7.1 権限設定
- WEBアプリケーション用のDBユーザーを作成
- ストアドプロシージャのみ実行可能（テーブル直接アクセス不可）

### 7.2 SQLインジェクション対策
- パラメータ化クエリの使用（PDOのプレースホルダー）
- GET_TBLのような動的SQLは使用禁止

---

## 8. 実装優先度

### 優先度A（Phase 09で実装必須）
- UPD_D_作業報告
- DEL_D_作業報告
- SEL_M_商品
- SEL_M_対応区分
- SEL_M_対応内容項目
- SEL_M_定型文
- COUNTUP_SYS_SEQNO

### 優先度B（Phase 10-11で追加）
- 検索用ストアドプロシージャ
- 一覧表示用ストアドプロシージャ

### 優先度C（将来拡張）
- 集計・統計用ストアドプロシージャ
- レポート用ストアドプロシージャ

---

**完了日**: 2025-11-20  
**レビュー**: Phase 02完了時に最終確認
