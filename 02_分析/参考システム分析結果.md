# 参考システム分析結果

**作成日**: 2025-11-20  
**Phase**: 01  
**分析対象**: 既存WEBシステム（ois-web）および共通関数（func）

---

## 1. 共通関数の分析

### 1.1 inc.php（初期設定・DB接続）

#### 主な機能
- **セッション管理**: セッション名'silps'、タイムアウト9時間（32400秒）
- **文字コード**: UTF-8強制出力
- **DB接続**: PDO（SQL Server）
- **キャッシュ制御**: private, no-store, must-revalidate（9時間）
- **タイムゾーン**: Asia/Tokyo

#### DB接続設定
```php
$serverName = 'LPG-NEMA\SQL22';
$uid = 'sa';
$dbName = 'nema_SILPSSQL';
$pwd = 'OIS8973113fmv';
$dsn = 'sqlsrv:server=' . $serverName . ';Database=' . $dbName;
```

#### 開発環境対応機能
- 動的なドメイン/パス設定（ローカルIPアドレス自動取得）
- セッションに最初のアクセスURLを記録
- ローカルLAN IPアドレスの自動判定（192.168.*, 10.*, 172.16-31.*を優先）

#### インクルードファイル
```php
require_once("../../func/myConvert.php");
require_once("../../func/myFunction.php");
```

---

### 1.2 myFunction.php（共通関数ライブラリ）

#### 画像処理関数
- `myResizeImage()`: 画像リサイズ（JPEG/GIF/PNG対応、透過対応）
- `myImageRotate()`: 画像回転
- `myRotateImage()`: EXIF情報による画像向き自動補正
- `image_flop()`: 画像の左右反転
- `image_flip()`: 画像の上下反転

#### 文字列処理関数
- `chkSunitize()`: HTMLエスケープ処理（htmlspecialchars）
- `br_convert()`: 改行を`<br />`タグに変換
- `nr_convert()`: `<br />`タグを改行コードに変換
- `kana_convert()`: カナ検索用の拗音変換（ァ→ア、ィ→イなど）
- `mb_str_pad()`: マルチバイト対応文字列パディング（固定長化）
- `str_format()`: 指定文字数で文字列整形（超過時は切り出し）

#### 数値処理関数
- `myRoundDown()`: 0に近づく切り捨て
- `myRoundUp()`: 最大方向へ切り上げ
- `myRound()`: 四捨五入
- `myConsumptionTax()`: 消費税計算（外税/内税、端数処理対応）

#### 日付処理関数
- `to_wareki()`: 西暦→和暦変換
  - 元号: 令和、平成、昭和、大正、明治（明治6年以降対応）
  - フォーマット指定可能（K:元号、k:略称、X:和暦年など）

#### VBA互換関数
- `Nz()`: VBAのNz関数をトレース（null値をデフォルト値に置換）
- `Ez()`: 空文字をデフォルト値に置換

#### その他
- `getCoordinates()`: Google Maps APIで住所から経度緯度取得

---

## 2. 既存WEBシステムの構造分析

### 2.1 ファイル命名規則

#### メイン画面
- `[機能]_main.php`: メイン画面
- 例: `ken_main.php`, `syu_main.php`, `haiso_main.php`

#### サブ機能
- `[機能]_[サブ機能].php`
- 例: `ken_main_ins.php`（登録）、`ken_main_upd.php`（更新）、`ken_main_list.php`（一覧）

#### 検索画面
- `[機能]_kensaku[番号].php`
- 例: `ken_kensaku01.php`〜`ken_kensaku09.php`

#### 詳細・明細画面
- `[機能]_ac[番号].php`
- `[機能]_ac[番号]-[枝番].php`
- 例: `main_ac01.php`, `hoan_ac11-1.php`

#### XML/データ出力
- `[機能]_xml[番号].php`
- 例: `ken_xml01.php`, `syu_xml03.php`

### 2.2 CSSファイル構造

システムは3種類のCSSファイルを使用（レスポンシブ対応）：
- `pc.css`: PC用スタイル
- `tablet.css`: タブレット用スタイル
- `sp.css`: スマートフォン用スタイル

機能別の専用CSS：
- `pc_kensin.css`: 検診機能専用
- `pc_hoan.css`: 保安機能専用

### 2.3 ディレクトリ構造

```
C:\inetpub\wwwroot\ois-web\
├── php ファイル群（ルート直下）
├── images/              # 画像ファイル
├── js/                  # JavaScriptファイル
└── .git/                # Gitリポジトリ
```

**特徴**:
- PHPファイルはルート直下に配置
- サブディレクトリは最小限（images, js のみ）
- シンプルなフラット構造

### 2.4 主要機能モジュール

#### 検診管理（ken_*）
- メイン画面: `ken_main.php`
- 検索: `ken_kensaku01.php`〜`ken_kensaku09.php`（9種類の検索条件）
- 登録: `ken_main_ins.php`
- 更新: `ken_main_upd.php`
- 一覧: `ken_main_list.php`
- 料金: `ken_price0.php`〜`ken_price3h.php`
- XML出力: `ken_xml01.php`, `ken_xml02.php`, `ken_xml99.php`

#### 集金管理（syu_*）
- メイン画面: `syu_main.php`
- 一覧: `syu_list.php`
- 登録: `syu_main_ins.php`
- 更新: `syu_main_upd.php`

#### 配送管理（haiso_*）
- メイン画面: `haiso_main.php`
- 履歴: `haiso_rireki.php`
- 容器チェック: `haiso_youki_chk.php`

#### 保安管理（hoan_*）
- メイン画面: `hoan.php`
- 詳細画面: `hoan_ac01.php`〜`hoan_ac51.php`
- 点検: `hoan_tenken.php`, `hoan_tenken01.php`
- 履歴: `hoan_tenken_history.php`
- アップロード: `hoan_upload.php`

#### 集計機能（syukei_*）
- メイン画面: `syukei_main.php`
- 担当者別: `syukei_tantou.php`
- 一覧: `syukei_tantou_list.php`（全体/検診/集金別）

---

## 3. 技術スタック（既存システム）

### 3.1 サーバーサイド
- **言語**: PHP 7.4
- **DB**: SQL Server
- **DB接続**: PDO（sqlsrv）
- **セッション**: PHP標準セッション（9時間タイムアウト）

### 3.2 フロントエンド
- **HTML**: XHTML 1.0 Transitional相当
- **CSS**: レスポンシブ対応（PC/Tablet/SP用に分離）
- **JavaScript**: jQuery使用（バージョン未確認）
- **画像**: images/ディレクトリに配置

### 3.3 開発環境
- **WEBサーバー**: IIS
- **バージョン管理**: Git
- **文字コード**: UTF-8

---

## 4. サポート報告書システムへの適用方針

### 4.1 踏襲すべき設計
1. **セッション管理**: 9時間タイムアウト
2. **DB接続**: PDO（SQL Server）、inc.phpのパターンを踏襲
3. **共通関数**: myFunction.phpの関数を活用
4. **ファイル命名規則**: `[機能]_[種類].php`の規則を継承
5. **レスポンシブ対応**: PC/Tablet/SP用のCSS分離
6. **文字コード**: UTF-8統一
7. **VBA互換関数**: Nz(), Ez()の活用（Accessからの移行を考慮）

### 4.2 改善・拡張すべき点
1. **ディレクトリ構造**: PHPファイルをサブディレクトリに整理
   - 現行: フラット構造
   - 新規: php/, includes/, css/, js/, images/に分離
2. **セキュリティ**: CSRF対策、XSS対策の強化
3. **エラーハンドリング**: 統一的なエラー処理機構
4. **ログ機能**: 操作ログ・エラーログの記録
5. **コメント**: PHPDoc形式のコメント追加

### 4.3 新システムで使用する共通関数

#### 必須関数
- `chkSunitize()`: HTMLエスケープ
- `br_convert()`, `nr_convert()`: 改行変換
- `Nz()`, `Ez()`: null/空文字処理（VBA互換）
- `to_wareki()`: 和暦変換（日本の帳票で必要）

#### 検討関数
- `myRound()`, `myRoundDown()`, `myRoundUp()`: 数値丸め処理
- `str_format()`: 固定長文字列整形（帳票出力時に便利）

---

## 5. 次フェーズ（Phase 02）への引き継ぎ事項

### 5.1 確認済み項目
- 既存システムの基本構造
- 共通関数ライブラリの内容
- ファイル命名規則
- DB接続方法

### 5.2 Phase 02で実施すべき項目
1. 現行Accessシステムの詳細分析
   - テーブル構造
   - ストアドプロシージャ一覧
   - 画面遷移フロー
   - 入力項目・検証ルール
2. 画面設計書の作成
3. 機能設計書の作成

---

**分析完了日**: 2025-11-20
