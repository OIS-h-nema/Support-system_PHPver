# テーブル定義書

**作成日**: 2025-11-20  
**更新日**: 2025-12-08  
**バージョン**: 1.1  
**Phase**: 02

---

## 1. データベース概要

### 1.1 データベース情報
- **データベース名**: SUPPORTDB
- **サーバー**: dev-se02\SQL22
- **互換性レベル**: SQL Server 2022 (160)
- **照合順序**: DATABASE_DEFAULT
- **復旧モデル**: SIMPLE

---

## 2. テーブル一覧

| No | テーブル名 | 種類 | 説明 | 主キー |
|----|-----------|------|------|--------|
| 1 | D_作業報告 | データ | サポート報告のメインデータ | SEQNO, 入力マシン |
| 2 | M_商品 | マスタ | 商品マスタ | 商品コード |
| 3 | M_対応区分 | マスタ | 対応区分マスタ | 対応区分コード |
| 4 | M_対応内容項目 | マスタ | 対応内容項目マスタ | 項目コード |
| 5 | M_定型文 | マスタ | 定型文マスタ | 部門コード, 定型文コード |
| 6 | DELDATA_商品 | 削除履歴 | 商品マスタの削除データ | - |
| 7 | DELDATA_対応区分 | 削除履歴 | 対応区分マスタの削除データ | - |
| 8 | DELDATA_対応内容項目 | 削除履歴 | 対応内容項目マスタの削除データ | - |
| 9 | DELDATA_定型文 | 削除履歴 | 定型文マスタの削除データ | - |
| 10 | SYS_SEQNO | システム | シーケンス番号管理 | - |
| 11 | SYS_管理 | システム | システム管理情報 | - |

---

## 3. テーブル詳細定義

### 3.1 D_作業報告（メインデータテーブル）

**用途**: 顧客からの問い合わせと対応内容を記録するメインテーブル

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | SEQNO | bigint | 8 | NOT NULL | シーケンス番号（主キー1） |
| 2 | 対応開始日時 | datetime | 8 | NOT NULL | 対応を開始した日時 |
| 3 | 対応終了日時 | datetime | 8 | NULL | 対応を終了した日時 |
| 4 | 顧客コード | bigint | 8 | NULL | 顧客マスタのコード（※SQL_顧客.seqと結合） |
| 5 | 顧客担当者名 | varchar | 50 | NULL | 顧客側の担当者名 |
| 6 | 部門コード | bigint | 8 | NULL | 対応した部門のコード（※SQL_部門.部門コードと結合） |
| 7 | 商品コード1 | bigint | 8 | NULL | 対象商品1 |
| 8 | 商品コード2 | bigint | 8 | NULL | 対象商品2 |
| 9 | 商品コード3 | bigint | 8 | NULL | 対象商品3 |
| 10 | 作業担当コード | bigint | 8 | NULL | 対応した担当者のコード（※SQL_作業担当.担当コードと結合） |
| 11 | 対応区分コード | bigint | 8 | NULL | 対応区分（問い合わせ種別） |
| 12 | 結果コード | bigint | 8 | NULL | 対応結果のコード |
| 13 | 引継担当コード | bigint | 8 | NULL | 引き継ぎ先の担当者コード（※SQL_作業担当.担当コードと結合） |
| 14 | 報告内容 | varchar | MAX | NULL | 対応内容の詳細テキスト |
| 15 | お客様サイン | varchar | 50 | NULL | お客様の確認サイン |
| 16 | 確認日付 | datetime | 8 | NULL | お客様確認日 |
| 17 | 作成日時 | datetime | 8 | NULL | レコード作成日時 |
| 18 | 同期日時 | datetime | 8 | NULL | サーバーとの同期日時 |
| 19 | 更新日時 | datetime | 8 | NULL | レコード更新日時 |
| 20 | 削除日時 | datetime | 8 | NULL | 論理削除日時 |
| 21 | 入力マシン | varchar | 50 | NOT NULL | 入力元マシン名（主キー2） |
| 22 | 更新マシン | varchar | 50 | NULL | 更新元マシン名 |
| 23 | ネットワークFLG | int | 4 | NULL | ネットワーク接続フラグ |
| 24-43 | 対応内容項目名1〜20 | varchar | 50 | NULL | 動的な対応内容項目名 |
| 44-63 | 対応内容フラグ1〜20 | int | 4 | NULL | 対応内容のチェック状態 |

**主キー**: SEQNO + 入力マシン

**インデックス**:
- PrimaryKey: SEQNO, 入力マシン (CLUSTERED)
- SEQNO: SEQNO (NON-CLUSTERED)

**特記事項**:
- 対応内容項目名とフラグは20個まで動的に設定可能（マスタで定義）
- 削除は論理削除（削除日時にタイムスタンプを設定）
- Access側のローカルデータとサーバー側データを同期する仕組み（ネットワークFLG）

---

### 3.2 M_商品（商品マスタ）

**用途**: 取り扱い商品の情報を管理

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 商品コード | bigint | 8 | NOT NULL | 商品の一意コード（主キー） |
| 2 | 部門コード | bigint | 8 | NULL | 管理部門のコード |
| 3 | 商品名 | nvarchar | 255 | NULL | 商品名称 |
| 4 | 使用区分 | bigint | 8 | NULL | 使用状態（0:未使用、1:使用中） |
| 5 | 更新日時 | datetime | 8 | NULL | 最終更新日時 |
| 6 | 入力マシン | nvarchar | 255 | NULL | 入力元マシン名 |

**主キー**: 商品コード

**インデックス**:
- PRIMARY KEY: 商品コード (CLUSTERED)
- IX_商品コード: 商品コード (NON-CLUSTERED)

---

### 3.3 M_対応区分（対応区分マスタ）

**用途**: 問い合わせの種類を分類

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 対応区分コード | bigint | 8 | NOT NULL | 対応区分の一意コード（主キー） |
| 2 | 対応区分名 | nvarchar | 255 | NULL | 対応区分名称 |
| 3 | 更新日時 | datetime | 8 | NULL | 最終更新日時 |
| 4 | 入力マシン | nvarchar | 255 | NULL | 入力元マシン名 |

**主キー**: 対応区分コード

**インデックス**:
- PRIMARY KEY: 対応区分コード (CLUSTERED)
- IX_対応区分コード: 対応区分コード (NON-CLUSTERED)

---

### 3.4 M_対応内容項目（対応内容項目マスタ）

**用途**: 対応内容のチェック項目を管理（最大20項目を動的に定義）

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 項目コード | bigint | 8 | NOT NULL | 項目の一意コード（主キー） |
| 2 | 項目名 | nvarchar | 255 | NULL | 項目名称 |
| 3 | 更新日時 | datetime | 8 | NULL | 最終更新日時 |
| 4 | 入力マシン | nvarchar | 255 | NULL | 入力元マシン名 |

**主キー**: 項目コード

**インデックス**:
- PRIMARY KEY: 項目コード (CLUSTERED)
- IX_項目コード: 項目コード (NON-CLUSTERED)

**特記事項**:
- この項目がD_作業報告の「対応内容項目名1〜20」として表示される
- チェックボックスのON/OFFが「対応内容フラグ1〜20」に記録される

---

### 3.5 M_定型文（定型文マスタ）

**用途**: よく使用する報告内容のテンプレートを管理

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 部門コード | bigint | 8 | NOT NULL | 部門コード（主キー1） |
| 2 | 定型文コード | bigint | 8 | NOT NULL | 定型文の連番（主キー2） |
| 3 | 定型文 | nvarchar | MAX | NULL | 定型文の内容 |
| 4 | 作成日時 | datetime | 8 | NULL | 作成日時 |
| 5 | 作成者コード | bigint | 8 | NULL | 作成者の担当者コード |
| 6 | 更新日時 | datetime | 8 | NULL | 最終更新日時 |
| 7 | 更新者コード | bigint | 8 | NULL | 更新者の担当者コード |

**主キー**: 部門コード + 定型文コード

**インデックス**:
- PRIMARY KEY: 部門コード, 定型文コード (CLUSTERED)
- IX_部門コード_定型文コード: 部門コード, 定型文コード (NON-CLUSTERED)

**特記事項**:
- 部門ごとに定型文を管理
- 報告内容入力時に選択して挿入可能

---

### 3.6 削除履歴テーブル（DELDATA_*）

以下の4テーブルが削除履歴として存在：

#### 3.6.1 DELDATA_商品
元のM_商品の構造 + 削除日時カラム

#### 3.6.2 DELDATA_対応区分
元のM_対応区分の構造 + 削除日時カラム

#### 3.6.3 DELDATA_対応内容項目
元のM_対応内容項目の構造 + 削除日時カラム

#### 3.6.4 DELDATA_定型文
元のM_定型文の構造 + 削除日時カラム

**用途**: マスタ削除時にデータを移動して履歴保持

---

### 3.7 SYS_SEQNO（シーケンス番号管理）

**用途**: D_作業報告のSEQNOを採番

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | SEQNO | bigint | 8 | NULL | 現在のシーケンス番号 |
| 2 | COUNTVAL | bigint | 8 | NULL | 増分値（通常1） |

**特記事項**:
- COUNTUP_SYS_SEQNO ストアドプロシージャで採番
- トランザクション内で安全に採番される仕組み

---

### 3.8 SYS_管理（システム管理情報）

**用途**: マシンごとのシステム管理情報を保持

| No | カラム名 | データ型 | サイズ | NULL | 説明 |
|----|---------|---------|-------|------|------|
| 1 | 入力マシン | nvarchar | 50 | NULL | マシン名 |
| 2 | ver | nvarchar | 50 | NULL | バージョン情報 |
| 3 | 最終オンライン起動日時 | nvarchar | 50 | NULL | 最終起動日時 |
| 4 | 作業担当者コード | nvarchar | 50 | NULL | ログイン中の担当者コード |
| 5 | 最終アップデート日時 | nvarchar | 50 | NULL | アプリ更新日時 |
| 6 | 最終データ更新日時 | nvarchar | 50 | NULL | データ更新日時 |
| 7 | 最終同期日時 | nvarchar | 50 | NULL | サーバー同期日時 |

**特記事項**:
- Accessアプリの同期管理用
- WEB化後は用途を見直す必要あり

---

## 4. 外部システム連携用テーブル（Access側のみ）

以下はAccess側でリンクテーブルとして使用されているもので、SQL Serverの他データベースを参照：

### 4.1 SQL_顧客
- **参照先**: CEWEBサーバー CeCrmデータベース
- **用途**: 顧客情報の参照
- **主キー**: seq（bigint）
- **D_作業報告との結合**: D_作業報告.顧客コード = SQL_顧客.seq
- **主要カラム**:
  - seq: 顧客シーケンス番号（主キー）
  - 顧客名: 顧客名称
  - その他顧客属性情報

### 4.2 SQL_作業担当
- **参照先**: CEWEBサーバー 社員マスタデータベース
- **用途**: 担当者情報の参照
- **主キー**: 担当コード（bigint）
- **D_作業報告との結合**: 
  - D_作業報告.作業担当コード = SQL_作業担当.担当コード
  - D_作業報告.引継担当コード = SQL_作業担当.担当コード
- **主要カラム**:
  - 担当コード: 担当者コード（主キー）
  - 担当者名: 担当者名称
  - 部門コード: 所属部門

### 4.3 SQL_部門
- **参照先**: CEWEBサーバー 部門マスタデータベース
- **用途**: 部門情報の参照
- **主キー**: 部門コード（bigint）
- **D_作業報告との結合**: D_作業報告.部門コード = SQL_部門.部門コード
- **主要カラム**:
  - 部門コード: 部門コード（主キー）
  - 部門名: 部門名称

**特記事項**:
- これらは別システム（CEWEB）のマスタを参照
- WEB化時は既存の参考システムと同様にPDO接続で参照
- 外部キー制約はDB側には設定されていないが、アプリケーション側で整合性を保証

---

## 5. データ型と文字コードの注意点

### 5.1 文字列型
- **varchar**: ASCII文字列（英数字のみ）
- **nvarchar**: Unicode文字列（日本語含む）

### 5.2 日時型
- **datetime**: 1753-01-01 〜 9999-12-31、精度は3.33ミリ秒

### 5.3 整数型
- **bigint**: 8バイト整数（-2^63 〜 2^63-1）
- **int**: 4バイト整数（-2^31 〜 2^31-1）

---

## 6. テーブル関連図

```
外部マスタ（CEWEBサーバー）                  内部テーブル（SUPPORTDB）
================================            ================================

[SQL_顧客]                                  [D_作業報告]
  seq ─────────────────────────────────────→ 顧客コード
  顧客名                                      顧客担当者名
                                              対応開始日時
[SQL_作業担当]                                対応終了日時
  担当コード ──────────────────────────────→ 作業担当コード
  担当コード ──────────────────────────────→ 引継担当コード
  担当者名                                    報告内容
  部門コード                                  商品コード1 ──→ [M_商品].商品コード
                                              商品コード2 ──→ [M_商品].商品コード
[SQL_部門]                                    商品コード3 ──→ [M_商品].商品コード
  部門コード ──────────────────────────────→ 部門コード
  部門名                                      対応区分コード ──→ [M_対応区分].対応区分コード
                                              ...

[SYS_SEQNO] ─────────────────────────────→ SEQNO（採番）

[M_定型文]
  部門コード ──────────────────────────────→ SQL_部門.部門コード（参照用）
  定型文コード
  定型文

削除時:
[M_商品] ──────> [DELDATA_商品]
[M_対応区分] ──> [DELDATA_対応区分]
[M_対応内容項目] ──> [DELDATA_対応内容項目]
[M_定型文] ────> [DELDATA_定型文]
```

---

## 6.1 テーブル間リレーション定義（キー対応表）

| 親テーブル | 親カラム | 子テーブル | 子カラム | 関係 | 備考 |
|-----------|---------|-----------|---------|------|------|
| SQL_顧客 | seq | D_作業報告 | 顧客コード | 1:N | 外部DB参照 |
| SQL_作業担当 | 担当コード | D_作業報告 | 作業担当コード | 1:N | 外部DB参照 |
| SQL_作業担当 | 担当コード | D_作業報告 | 引継担当コード | 1:N | 外部DB参照 |
| SQL_部門 | 部門コード | D_作業報告 | 部門コード | 1:N | 外部DB参照 |
| M_商品 | 商品コード | D_作業報告 | 商品コード1 | 1:N | 内部マスタ |
| M_商品 | 商品コード | D_作業報告 | 商品コード2 | 1:N | 内部マスタ |
| M_商品 | 商品コード | D_作業報告 | 商品コード3 | 1:N | 内部マスタ |
| M_対応区分 | 対応区分コード | D_作業報告 | 対応区分コード | 1:N | 内部マスタ |
| SQL_部門 | 部門コード | M_定型文 | 部門コード | 1:N | 外部DB参照 |

**重要**: D_作業報告.顧客コードは「SQL_顧客.顧客コード」ではなく「**SQL_顧客.seq**」と結合する点に注意

---

## 7. WEB化時の対応方針

### 7.1 継続使用するテーブル
- D_作業報告
- M_商品
- M_対応区分
- M_対応内容項目
- M_定型文
- DELDATA_* （削除履歴）
- SYS_SEQNO

### 7.2 見直しが必要なテーブル
- **SYS_管理**: マシン管理が不要になるため、用途を再検討
  - セッション管理に置き換え
  - サーバー側でログイン情報を管理

### 7.3 外部参照テーブル
- SQL_顧客、SQL_作業担当、SQL_部門は参考システムと同様の接続方法で参照

---

## 8. データ整合性

### 8.1 主キー制約
すべてのマスタテーブルに主キー制約が設定済み

### 8.2 外部キー制約
現状、外部キー制約は設定されていない
→ アプリケーション側で整合性を保証

### 8.3 インデックス
主要な検索条件となるカラムにインデックスが設定済み

---

## 9. データ容量の見積もり

### 9.1 想定レコード数（年間）
- **D_作業報告**: 約10,000〜50,000件/年
- **M_商品**: 100件程度
- **M_対応区分**: 20件程度
- **M_対応内容項目**: 20件（固定）
- **M_定型文**: 部門×10件程度

### 9.2 容量計算
- 現在のデータベースサイズ: 約72MB（初期サイズ）
- 年間増加見込み: 約10〜20MB

---

**完了日**: 2025-11-20  
**レビュー**: Phase 02完了時に最終確認
