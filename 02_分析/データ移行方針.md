# データ移行方針

**作成日**: 2025-11-20  
**バージョン**: 1.0  
**Phase**: 02

---

## 1. 移行概要

### 1.1 移行の目的
MS Access版サポート報告書システムからWEB版への移行に伴い、既存データを新システムへ移行する。

### 1.2 移行方針
- **データベースは継続使用**: SQL Server SUPPORTDBをそのまま利用
- **ストアドプロシージャは継続使用**: 既存SPをそのまま活用
- **Accessローカルデータの統合**: 各PCに分散したAccessローカルデータをサーバーへ統合
- **Access同期機能の廃止**: WEB化により同期処理は不要

---

## 2. 移行対象データ

### 2.1 データベース

| テーブル名 | 移行方法 | 備考 |
|-----------|---------|------|
| D_作業報告 | そのまま継続 | サーバー側は移行不要 |
| M_商品 | そのまま継続 | - |
| M_対応区分 | そのまま継続 | - |
| M_対応内容項目 | そのまま継続 | - |
| M_定型文 | そのまま継続 | - |
| DELDATA_* | そのまま継続 | 削除履歴も保持 |
| SYS_SEQNO | そのまま継続 | - |
| SYS_管理 | 見直し | WEB化に伴い用途変更 |

---

### 2.2 Accessローカルデータ

#### 2.2.1 ローカルテーブル

Accessには以下のローカルテーブルが存在：

| テーブル名 | 内容 | 移行方法 |
|-----------|------|---------|
| LW_作業報告 | ローカル作業データ | サーバーへ統合 |
| FW_サポート報告_入力ダイアログ | 入力フォーム作業用 | 不要（WEBで再現） |
| $LOG | ローカルログ | 不要 |
| $ENVIRON | 環境設定 | 不要 |
| $DataPath | データパス設定 | 不要 |
| @修正履歴 | システム修正履歴 | 保管のみ |

#### 2.2.2 統合手順

```
1. 各PCのAccessファイルから LW_作業報告 を抽出
   ↓
2. サーバーの D_作業報告 と比較
   ↓
3. サーバーにないデータを D_作業報告 へINSERT
   ↓
4. 重複チェック（SEQNO + 入力マシン）
   ↓
5. 統合完了
```

---

## 3. データクレンジング

### 3.1 クレンジング対象

#### 3.1.1 D_作業報告

| 項目 | 問題 | 対応 |
|------|------|------|
| 削除日時がNULLでないレコード | 論理削除済み | 一覧表示から除外（データは保持） |
| 対応終了日時 < 対応開始日時 | データ不整合 | 手動修正または対応終了日時をNULLに |
| 顧客コードが存在しない | リンク切れ | 顧客コードをNULLに、または手動修正 |
| 報告内容が空 | 必須項目欠落 | 「（報告内容なし）」で補完 |

#### 3.1.2 マスタテーブル

| 項目 | 問題 | 対応 |
|------|------|------|
| 使用区分=0（未使用）のマスタ | 使用していない | コンボボックスから除外 |
| 重複データ | データ重複 | 手動で統合 |

---

### 3.2 クレンジング手順

#### ステップ1: データ整合性チェック

```sql
-- 削除済みデータの確認
SELECT COUNT(*) FROM D_作業報告 WHERE 削除日時 IS NOT NULL;

-- 対応日時の不整合チェック
SELECT SEQNO, 対応開始日時, 対応終了日時
FROM D_作業報告
WHERE 対応終了日時 < 対応開始日時;

-- 顧客コードのリンク切れチェック
SELECT D.SEQNO, D.顧客コード
FROM D_作業報告 D
LEFT JOIN SQL_顧客 K ON D.顧客コード = K.顧客コード
WHERE D.顧客コード IS NOT NULL AND K.顧客コード IS NULL;

-- 報告内容が空のレコード
SELECT COUNT(*) FROM D_作業報告 WHERE 報告内容 IS NULL OR 報告内容 = '';
```

#### ステップ2: データ修正

```sql
-- 報告内容が空のレコードを補完
UPDATE D_作業報告
SET 報告内容 = '（報告内容なし）'
WHERE 報告内容 IS NULL OR 報告内容 = '';

-- 対応終了日時の不整合を修正（対応終了をNULLに）
UPDATE D_作業報告
SET 対応終了日時 = NULL
WHERE 対応終了日時 < 対応開始日時;
```

#### ステップ3: 検証

```sql
-- 修正後の確認
SELECT 
    COUNT(*) AS 総件数,
    SUM(CASE WHEN 削除日時 IS NULL THEN 1 ELSE 0 END) AS 有効件数,
    SUM(CASE WHEN 削除日時 IS NOT NULL THEN 1 ELSE 0 END) AS 削除済件数
FROM D_作業報告;
```

---

## 4. Accessローカルデータの統合

### 4.1 統合対象PCの洗い出し

#### 手順:
1. SYS_管理テーブルを確認
```sql
SELECT 入力マシン, 最終同期日時 
FROM SYS_管理
ORDER BY 最終同期日時 DESC;
```

2. 各PCのAccessファイルを収集

---

### 4.2 ローカルデータ抽出スクリプト

#### Access VBAスクリプト:

```vba
Sub ExportLocalData()
    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim strSQL As String
    Dim strOutputFile As String
    
    Set db = CurrentDb()
    
    ' ローカルテーブルのデータを抽出
    strSQL = "SELECT * FROM LW_作業報告 WHERE 同期日時 IS NULL"
    Set rs = db.OpenRecordset(strSQL)
    
    ' CSV出力
    strOutputFile = "C:\Temp\LocalData_" & Environ("COMPUTERNAME") & ".csv"
    ' CSVファイルへの書き込み処理...
    
    rs.Close
    Set rs = Nothing
    Set db = Nothing
End Sub
```

---

### 4.3 サーバーへの統合スクリプト

#### PHPスクリプト（data_import.php）:

```php
<?php
// CSVファイルを読み込み
$csvFiles = glob('C:\Temp\LocalData_*.csv');

foreach ($csvFiles as $csvFile) {
    $handle = fopen($csvFile, 'r');
    
    // ヘッダー行をスキップ
    fgetcsv($handle);
    
    while (($data = fgetcsv($handle)) !== FALSE) {
        // データをサーバーへINSERT
        // 重複チェック: SEQNO + 入力マシン
        $stmt = $pdo->prepare("
            SELECT COUNT(*) FROM D_作業報告 
            WHERE SEQNO = ? AND 入力マシン = ?
        ");
        $stmt->execute([$data[0], $data[20]]);
        
        if ($stmt->fetchColumn() == 0) {
            // 存在しない場合のみINSERT
            // UPD_D_作業報告ストアドプロシージャを呼び出し
        }
    }
    
    fclose($handle);
}
```

---

## 5. システム管理テーブルの再設計

### 5.1 SYS_管理テーブルの用途変更

#### 旧用途:
- マシンごとの同期管理
- バージョン管理
- ログイン情報（マシン単位）

#### 新用途:
- セッション管理情報
- システム設定情報

#### 再設計案:

**新テーブル: SYS_セッション管理**

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| セッションID | VARCHAR(255) | セッションID |
| ユーザーコード | INT | ログイン中のユーザー |
| ログイン日時 | DATETIME | ログイン日時 |
| 最終アクセス日時 | DATETIME | 最終アクセス日時 |
| IPアドレス | VARCHAR(50) | アクセス元IPアドレス |

**新テーブル: SYS_設定**

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| 設定キー | VARCHAR(50) | 設定項目名 |
| 設定値 | VARCHAR(255) | 設定値 |
| 説明 | VARCHAR(255) | 設定の説明 |
| 更新日時 | DATETIME | 最終更新日時 |

---

## 6. 移行スケジュール

### 6.1 移行フェーズ

| Phase | 作業内容 | 期間 | 担当 |
|-------|---------|------|------|
| 準備 | データクレンジング計画策定 | 1日 | Phase 02 |
| 検証 | テストデータでの移行テスト | 2日 | Phase 05 |
| 本番移行 | 本番データのクレンジングと統合 | 1日 | Phase 08 |
| 確認 | 移行データの検証 | 1日 | Phase 08 |

---

### 6.2 移行タイムライン

```
Phase 02: 移行方針策定 ←★現在
    ↓
Phase 05: テストデータ作成、移行テスト
    ↓
Phase 08: 本番移行準備
    ↓
Phase 08: 本番データクレンジング
    ↓
Phase 08: Accessローカルデータ統合
    ↓
Phase 08: 移行データ検証
    ↓
Phase 09: WEBシステム稼働開始
```

---

## 7. リスクと対策

### 7.1 リスク一覧

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| ローカルデータの重複 | 中 | 高 | 重複チェックスクリプトの実装 |
| データ不整合 | 高 | 中 | クレンジング処理の実施 |
| PC障害によるローカルデータ喪失 | 中 | 低 | 事前バックアップの実施 |
| 移行作業の遅延 | 中 | 中 | 余裕を持ったスケジュール |
| 統合後のデータ量増加 | 低 | 高 | サーバー容量の確認 |

---

### 7.2 ロールバック計画

万が一、移行に失敗した場合の対応：

#### ステップ1: データベースの復元
```sql
-- 移行前のバックアップから復元
RESTORE DATABASE SUPPORTDB 
FROM DISK = 'D:\Backup\SUPPORTDB_移行前.bak'
WITH REPLACE;
```

#### ステップ2: Accessシステムの継続利用
- 移行失敗時は既存Accessシステムを継続使用
- 問題を解決後、再度移行を実施

---

## 8. 移行後の運用

### 8.1 Accessファイルの扱い

- **移行完了後**: Accessファイルは参照専用として保管
- **保管場所**: ファイルサーバーのアーカイブフォルダ
- **保管期間**: 1年間（問題なければ削除）

---

### 8.2 データ整合性チェック

移行後、定期的に以下をチェック：

```sql
-- 週次チェック（移行後1ヶ月間）
-- データ件数の確認
SELECT COUNT(*) FROM D_作業報告 WHERE 削除日時 IS NULL;

-- 最新データの確認
SELECT TOP 10 * FROM D_作業報告 
ORDER BY 更新日時 DESC;

-- 顧客コードのリンク切れチェック
SELECT COUNT(*)
FROM D_作業報告 D
LEFT JOIN SQL_顧客 K ON D.顧客コード = K.顧客コード
WHERE D.顧客コード IS NOT NULL 
  AND K.顧客コード IS NULL
  AND D.削除日時 IS NULL;
```

---

## 9. 移行チェックリスト

### 9.1 移行前チェック

- [ ] データベースの完全バックアップ取得
- [ ] 全PCのAccessファイル収集完了
- [ ] クレンジングスクリプト準備完了
- [ ] 統合スクリプト準備完了
- [ ] テスト環境での移行テスト完了
- [ ] ロールバック手順の確認

---

### 9.2 移行作業チェック

- [ ] データクレンジング実施
- [ ] クレンジング結果の確認
- [ ] ローカルデータ抽出完了
- [ ] サーバーへの統合完了
- [ ] 重複データの確認
- [ ] データ件数の確認
- [ ] 整合性チェック完了

---

### 9.3 移行後チェック

- [ ] WEBシステムからのデータ参照確認
- [ ] 新規データ登録テスト
- [ ] データ更新テスト
- [ ] データ削除テスト
- [ ] 検索機能のテスト
- [ ] ユーザーへの操作説明完了
- [ ] 旧Accessファイルのアーカイブ完了

---

## 10. 移行手順書

### 10.1 本番移行手順（Phase 08で実施）

#### 事前準備（移行前日）
1. ユーザーへの周知（移行日時、システム停止時間）
2. データベースのバックアップ取得
3. 全PCのAccessファイルの最新同期実施

#### 移行当日（休日または業務時間外）

**00:00 - 移行開始**
1. データベースの完全バックアップ取得
2. データクレンジング実施（1時間）
3. ローカルデータの抽出（2時間）
4. サーバーへの統合（2時間）
5. 整合性チェック（1時間）
6. WEBシステムからの接続テスト（1時間）

**07:00 - 移行完了確認**
7. テストユーザーでの動作確認
8. 管理者による最終確認

**08:00 - システム公開**
9. ユーザーへの利用開始通知

---

## 11. 移行完了条件

以下の条件をすべて満たした時点で移行完了とする：

1. ✅ データクレンジングが完了し、不整合データがゼロ
2. ✅ すべてのローカルデータがサーバーに統合済み
3. ✅ 重複データがゼロ
4. ✅ データ件数が移行前と一致（削除済みを除く）
5. ✅ WEBシステムからのデータ参照が正常
6. ✅ 新規登録・更新・削除が正常動作
7. ✅ 検索機能が正常動作
8. ✅ ユーザーによる動作確認完了

---

**完了日**: 2025-11-20  
**レビュー**: Phase 02完了時に最終確認  
**実施予定**: Phase 08（移行実施フェーズ）
