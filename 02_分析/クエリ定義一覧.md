# クエリ定義一覧

## 文書情報
- **作成日**: 2025-11-20
- **Phase**: Phase 02 - 要件分析
- **目的**: 既存AccessシステムのクエリSQL定義を整理し、WEB化時の実装方針を策定する

---

## 目次
1. [クエリ分類](#1-クエリ分類)
2. [コンボボックス用クエリ (CQ_*)](#2-コンボボックス用クエリ-cq_)
3. [フォーム用クエリ (FQ_*)](#3-フォーム用クエリ-fq_)
4. [データ用クエリ (DQ_*)](#4-データ用クエリ-dq_)
5. [レポート用クエリ (RQ_*)](#5-レポート用クエリ-rq_)
6. [その他クエリ](#6-その他クエリ)
7. [WEB化実装方針](#7-web化実装方針)

---

## 1. クエリ分類

### 1.1 ファイル命名規則

| プレフィクス | 用途 | 件数 |
|------------|------|------|
| CQ_ | Combo Query - コンボボックス用クエリ | 7 |
| FQ_ | Form Query - フォーム表示用クエリ | 6 |
| DQ_ | Data Query - データ取得用クエリ | 1 |
| RQ_ | Report Query - レポート用クエリ | 1 |
| LQ_ | List Query - 一覧表示用クエリ | 1 |
| EXQ_ | Export Query - エクスポート用クエリ | 1 |

### 1.2 クエリ一覧（全17件）

| No | クエリ名 | 種別 | 用途 |
|----|---------|------|------|
| 1 | CQ_商品 | CQ | 商品コンボボックス |
| 2 | CQ_定型文ダイアログ_定型文コード | CQ | 定型文選択用 |
| 3 | CQ_対応区分 | CQ | 対応区分コンボボックス |
| 4 | CQ_担当者 | CQ | 担当者コンボボックス（全件） |
| 5 | CQ_担当者_入力 | CQ | 担当者コンボボックス（入力用） |
| 6 | CQ_担当者_検索 | CQ | 担当者コンボボックス（検索用） |
| 7 | CQ_部門 | CQ | 部門コンボボックス |
| 8 | FQ_NEWS | FQ | お知らせ表示 |
| 9 | FQ_サポート報告_一覧表_明細 | FQ | メイン画面一覧 |
| 10 | FQ_保守_商品_明細 | FQ | 商品マスタ保守画面 |
| 11 | FQ_保守_定型文_明細 | FQ | 定型文マスタ保守画面 |
| 12 | FQ_保守_対応内容項目_明細 | FQ | 対応内容項目マスタ保守画面 |
| 13 | FQ_保守_対応区分_明細 | FQ | 対応区分マスタ保守画面 |
| 14 | DQ_対応内容一覧 | DQ | 対応内容一覧取得 |
| 15 | LQ_商品 | LQ | 商品一覧 |
| 16 | RQ_サポート報告書 | RQ | サポート報告書印刷用 |
| 17 | EXQ_サポート報告_一覧表_明細 | EXQ | 一覧データエクスポート用 |

---

## 2. コンボボックス用クエリ (CQ_*)

### 2.1 CQ_商品

**用途**: 商品選択コンボボックス  
**対象テーブル**: M_商品

**SQL概要**:
```sql
SELECT 
    商品コード,
    商品名,
    分類コード,
    使用区分
FROM M_商品
WHERE 使用区分 = 1
ORDER BY 商品コード
```

**取得項目**:
- 商品コード (主キー)
- 商品名
- 分類コード
- 使用区分

**WEB化実装方針**:
- SELECT文をPHPで実装
- Ajaxで商品一覧を取得し、jQueryでセレクトボックスを生成
- 選択時に商品コードを取得

---

### 2.2 CQ_定型文ダイアログ_定型文コード

**用途**: 定型文選択ダイアログ  
**対象テーブル**: M_定型文

**SQL概要**:
```sql
SELECT 
    定型文コード,
    定型文名,
    定型文本文
FROM M_定型文
WHERE 使用区分 = 1
ORDER BY 定型文コード
```

**取得項目**:
- 定型文コード (主キー)
- 定型文名
- 定型文本文

**WEB化実装方針**:
- SELECT文をPHPで実装
- モーダルダイアログで定型文一覧を表示
- 選択時に定型文本文をテキストエリアに挿入

---

### 2.3 CQ_対応区分

**用途**: 対応区分選択コンボボックス  
**対象テーブル**: M_対応区分

**SQL概要**:
```sql
SELECT 
    対応区分コード,
    対応区分名
FROM M_対応区分
WHERE 使用区分 = 1
ORDER BY 対応区分コード
```

**取得項目**:
- 対応区分コード (主キー)
- 対応区分名

**WEB化実装方針**:
- SELECT文をPHPで実装
- セレクトボックスで表示

---

### 2.4 CQ_担当者

**用途**: 担当者選択コンボボックス（全件）  
**対象テーブル**: SQL_作業担当

**SQL概要**:
```sql
SELECT 
    担当者コード,
    担当者名
FROM SQL_作業担当
ORDER BY 担当者コード
```

**取得項目**:
- 担当者コード (主キー)
- 担当者名

**WEB化実装方針**:
- SQL Serverから直接取得（ローカルテーブル不要）
- セレクトボックスで表示

---

### 2.5 CQ_担当者_入力

**用途**: 入力フォームの担当者選択  
**対象テーブル**: SQL_作業担当

**SQL概要**:
```sql
SELECT 
    担当者コード,
    担当者名
FROM SQL_作業担当
WHERE 部門コード = [指定部門]
ORDER BY 担当者コード
```

**取得項目**:
- 担当者コード
- 担当者名

**フィルタ条件**:
- 部門コードで絞り込み

**WEB化実装方針**:
- 部門選択時にAjaxで担当者一覧を動的に取得
- セレクトボックスを再生成

---

### 2.6 CQ_担当者_検索

**用途**: 検索条件の担当者選択  
**対象テーブル**: SQL_作業担当

**SQL概要**:
```sql
SELECT 
    担当者コード,
    担当者名
FROM SQL_作業担当
ORDER BY 担当者コード
```

**取得項目**:
- 担当者コード
- 担当者名

**WEB化実装方針**:
- CQ_担当者と同様
- 検索用なので全件表示

---

### 2.7 CQ_部門

**用途**: 部門選択コンボボックス  
**対象テーブル**: SQL_部門

**SQL概要**:
```sql
SELECT 
    部門コード,
    部門名
FROM SQL_部門
ORDER BY 部門コード
```

**取得項目**:
- 部門コード (主キー)
- 部門名

**WEB化実装方針**:
- SQL Serverから直接取得（ローカルテーブル不要）
- セレクトボックスで表示

---

## 3. フォーム用クエリ (FQ_*)

### 3.1 FQ_サポート報告_一覧表_明細

**用途**: メイン画面の一覧表示  
**対象テーブル**: D_作業報告、SQL_顧客、SQL_作業担当、M_商品(×3)、M_対応区分

**SQL概要**:
```sql
SELECT 
    D.SEQNO,
    ST.担当者名,
    FORMAT(D.対応開始日時, 'yyyy/mm/dd hh:nn') + '～' + FORMAT(D.対応終了日時, 'Short Time') AS 対応日時,
    C.顧客名,
    -- 商品名（最大3件を結合）
    IIF(D.商品コード01 > 0, M1.商品名, '') + 
    IIF(D.商品コード02 > 0, ', ' + M2.商品名, '') + 
    IIF(D.商品コード03 > 0, ', ' + M3.商品名, '') AS 商品名,
    D.報告内容,
    D.備考欄,
    D.顧客コード,
    D.商品コード01,
    D.商品コード02,
    D.分類コード,
    D.作業担当コード,
    D.登録担当コード,
    D.対応区分コード,
    K.対応区分名,
    -- 対応内容（チェックボックス20項目を結合）
    REPLACE(LTRIM(
        IIF(D.対応内容01 = True, D.対応内容文言01, '') + 
        IIF(D.対応内容02 = True, ' ' + D.対応内容文言02, '') + 
        ... (20項目まで繰り返し)
    ), ' ', '/') AS 対応内容,
    D.印刷済FLG,
    D.入力日時,
    D.編集日時,
    D.完了確認日時,
    D.対応内容文言01～20,
    D.対応内容01～20
FROM 
    D_作業報告 D
    LEFT JOIN SQL_顧客 C ON D.顧客コード = C.SEQNO
    LEFT JOIN SQL_作業担当 ST ON D.作業担当コード = ST.担当者コード
    LEFT JOIN M_商品 M1 ON D.商品コード01 = M1.商品コード
    LEFT JOIN M_商品 M2 ON D.商品コード02 = M2.商品コード
    LEFT JOIN M_商品 M3 ON D.商品コード03 = M3.商品コード
    LEFT JOIN M_対応区分 K ON D.対応区分コード = K.対応区分コード
    LEFT JOIN SQL_作業担当 ST2 ON D.登録担当コード = ST2.担当者コード
ORDER BY 
    D.対応開始日時 DESC
```

**特徴**:
- 複数テーブルを LEFT JOIN で結合
- 商品は最大3件まで対応（M_商品を3回結合）
- 対応内容は20項目のチェックボックスを '/' 区切りで結合
- 日時は Access の FORMAT 関数で整形

**WEB化実装方針**:
- ストアドプロシージャまたは PHP の PDO で実装
- 商品名の結合: `CONCAT()` または配列操作
- 対応内容の結合: ループ処理で配列を結合
- 日時の整形: `DATE_FORMAT()` または PHP の `date()`
- ページング処理を追加（LIMIT/OFFSET）
- 検索条件（日付範囲、顧客、担当者等）を動的に追加

---

### 3.2 FQ_保守_商品_明細

**用途**: 商品マスタ保守画面  
**対象テーブル**: M_商品

**SQL概要**:
```sql
SELECT 
    分類コード,
    商品コード,
    商品名,
    使用区分,
    備考欄
FROM M_商品
ORDER BY 分類コード, 商品コード
```

**WEB化実装方針**:
- SELECT文をPHPで実装
- データテーブル（DataTables等）で一覧表示
- 行クリックで編集ダイアログを表示

---

### 3.3 FQ_保守_定型文_明細

**用途**: 定型文マスタ保守画面  
**対象テーブル**: M_定型文

**SQL概要**:
```sql
SELECT 
    定型文コード,
    定型文名,
    定型文本文,
    使用区分,
    備考欄
FROM M_定型文
ORDER BY 定型文コード
```

**WEB化実装方針**:
- FQ_保守_商品_明細と同様

---

### 3.4 FQ_保守_対応内容項目_明細

**用途**: 対応内容項目マスタ保守画面  
**対象テーブル**: M_対応内容項目

**SQL概要**:
```sql
SELECT 
    表示順,
    対応内容文言,
    使用区分,
    備考欄
FROM M_対応内容項目
ORDER BY 表示順
```

**WEB化実装方針**:
- FQ_保守_商品_明細と同様
- ドラッグ＆ドロップで表示順を変更できる機能を追加検討

---

### 3.5 FQ_保守_対応区分_明細

**用途**: 対応区分マスタ保守画面  
**対象テーブル**: M_対応区分

**SQL概要**:
```sql
SELECT 
    対応区分コード,
    対応区分名,
    使用区分,
    備考欄
FROM M_対応区分
ORDER BY 対応区分コード
```

**WEB化実装方針**:
- FQ_保守_商品_明細と同様

---

### 3.6 FQ_NEWS

**用途**: お知らせ表示（仕様不明）  
**対象テーブル**: （不明）

**推測**:
- システムのお知らせやメッセージを表示する機能
- 実装されているか不明

**WEB化実装方針**:
- 仕様確認後に実装判断
- 優先度低

---

## 4. データ用クエリ (DQ_*)

### 4.1 DQ_対応内容一覧

**用途**: 対応内容項目のチェックボックス一覧  
**対象テーブル**: M_対応内容項目

**SQL概要**:
```sql
SELECT 
    表示順,
    対応内容文言,
    使用区分
FROM M_対応内容項目
WHERE 使用区分 = 1
ORDER BY 表示順
```

**WEB化実装方針**:
- SELECT文をPHPで実装
- Ajaxで取得してチェックボックス群を動的生成
- 表示順に従ってチェックボックスを配置

---

## 5. レポート用クエリ (RQ_*)

### 5.1 RQ_サポート報告書

**用途**: サポート報告書の印刷用  
**対象テーブル**: D_作業報告、SQL_顧客、SQL_作業担当、M_商品、M_対応区分

**SQL概要**:
```sql
-- FQ_サポート報告_一覧表_明細と同様の結合
-- ただし、印刷用のフォーマット整形を含む
SELECT 
    ... (FQ_サポート報告_一覧表_明細と同様)
WHERE 
    D.SEQNO = [指定SEQNO]
```

**WEB化実装方針**:
- PDF出力機能として実装
- TCPDF または FPDF ライブラリを使用
- 別途、印刷用レイアウトのHTMLページを作成し、ブラウザ印刷機能を使用することも検討

---

## 6. その他クエリ

### 6.1 LQ_商品

**用途**: 商品一覧（詳細不明）  
**対象テーブル**: M_商品

**SQL概要**:
```sql
SELECT * FROM M_商品
ORDER BY 商品コード
```

**WEB化実装方針**:
- FQ_保守_商品_明細と重複の可能性
- 用途を確認後に実装判断

---

### 6.2 EXQ_サポート報告_一覧表_明細

**用途**: データエクスポート用  
**対象テーブル**: FQ_サポート報告_一覧表_明細と同様

**SQL概要**:
```sql
-- FQ_サポート報告_一覧表_明細と同一のSELECT文
```

**WEB化実装方針**:
- CSV/Excelエクスポート機能として実装
- PHPExcel（PhpSpreadsheet）または CSV出力関数を使用
- FQ_サポート報告_一覧表_明細の結果をそのまま出力

---

## 7. WEB化実装方針

### 7.1 全体方針

#### 7.1.1 クエリの実装方法
| 実装方法 | 対象クエリ | 優先度 |
|---------|----------|--------|
| **ストアドプロシージャ** | 複雑な結合・集計クエリ | 高 |
| **PHPのPDO（直接SQL）** | シンプルなSELECT文 | 中 |
| **VIEWの作成** | 頻繁に使用する結合クエリ | 低 |

#### 7.1.2 推奨実装方法
- **コンボボックス用クエリ (CQ_\*)**: PHPのPDO
- **フォーム用クエリ (FQ_\*)**: ストアドプロシージャまたはPHPのPDO
- **データ用クエリ (DQ_\*)**: PHPのPDO
- **レポート用クエリ (RQ_\*)**: ストアドプロシージャ + PDF生成ライブラリ

---

### 7.2 具体的な実装方針

#### 7.2.1 コンボボックス用クエリ

**実装方法**:
```php
// 例: CQ_商品
$sql = "SELECT 商品コード, 商品名, 分類コード
        FROM M_商品
        WHERE 使用区分 = 1
        ORDER BY 商品コード";
        
$stmt = $pdo->prepare($sql);
$stmt->execute();
$products = $stmt->fetchAll(PDO::FETCH_ASSOC);

// JSON形式で返す（Ajax用）
echo json_encode($products);
```

**JavaScript側**:
```javascript
// Ajaxで取得
$.ajax({
    url: 'api/get_products.php',
    method: 'GET',
    dataType: 'json',
    success: function(data) {
        var $select = $('#商品コード');
        $select.empty();
        $select.append('<option value="">選択してください</option>');
        $.each(data, function(i, item) {
            $select.append($('<option>', {
                value: item.商品コード,
                text: item.商品名
            }));
        });
    }
});
```

---

#### 7.2.2 一覧表示クエリ

**実装方法（ストアドプロシージャ）**:
```sql
-- ストアドプロシージャの作成
CREATE PROCEDURE SP_GET_REPORT_LIST
    @START_DATE DATETIME = NULL,
    @END_DATE DATETIME = NULL,
    @CUSTOMER_CODE INT = NULL,
    @STAFF_CODE INT = NULL,
    @LIMIT INT = 100,
    @OFFSET INT = 0
AS
BEGIN
    SELECT 
        D.SEQNO,
        ST.担当者名,
        FORMAT(D.対応開始日時, 'yyyy/MM/dd HH:mm') + '～' + FORMAT(D.対応終了日時, 'HH:mm') AS 対応日時,
        C.顧客名,
        CASE 
            WHEN D.商品コード01 > 0 THEN M1.商品名 
            ELSE '' 
        END + 
        CASE 
            WHEN D.商品コード02 > 0 THEN ', ' + M2.商品名 
            ELSE '' 
        END + 
        CASE 
            WHEN D.商品コード03 > 0 THEN ', ' + M3.商品名 
            ELSE '' 
        END AS 商品名,
        D.報告内容,
        D.備考欄,
        K.対応区分名
    FROM 
        D_作業報告 D
        LEFT JOIN SQL_顧客 C ON D.顧客コード = C.SEQNO
        LEFT JOIN SQL_作業担当 ST ON D.作業担当コード = ST.担当者コード
        LEFT JOIN M_商品 M1 ON D.商品コード01 = M1.商品コード
        LEFT JOIN M_商品 M2 ON D.商品コード02 = M2.商品コード
        LEFT JOIN M_商品 M3 ON D.商品コード03 = M3.商品コード
        LEFT JOIN M_対応区分 K ON D.対応区分コード = K.対応区分コード
    WHERE 
        (@START_DATE IS NULL OR D.対応開始日時 >= @START_DATE)
        AND (@END_DATE IS NULL OR D.対応開始日時 <= @END_DATE)
        AND (@CUSTOMER_CODE IS NULL OR D.顧客コード = @CUSTOMER_CODE)
        AND (@STAFF_CODE IS NULL OR D.作業担当コード = @STAFF_CODE)
    ORDER BY 
        D.対応開始日時 DESC
    OFFSET @OFFSET ROWS
    FETCH NEXT @LIMIT ROWS ONLY
END
```

**PHP実装**:
```php
$sql = "EXEC SP_GET_REPORT_LIST @START_DATE = :start_date, @END_DATE = :end_date, 
        @CUSTOMER_CODE = :customer_code, @STAFF_CODE = :staff_code,
        @LIMIT = :limit, @OFFSET = :offset";
        
$stmt = $pdo->prepare($sql);
$stmt->execute([
    'start_date' => $start_date,
    'end_date' => $end_date,
    'customer_code' => $customer_code,
    'staff_code' => $staff_code,
    'limit' => $limit,
    'offset' => $offset
]);

$results = $stmt->fetchAll(PDO::FETCH_ASSOC);
echo json_encode($results);
```

---

#### 7.2.3 マスタ保守クエリ

**実装方法（CRUD操作）**:
```php
// 取得（SELECT）
$sql = "SELECT * FROM M_商品 ORDER BY 分類コード, 商品コード";
$stmt = $pdo->prepare($sql);
$stmt->execute();
$results = $stmt->fetchAll(PDO::FETCH_ASSOC);

// 追加（INSERT）
$sql = "INSERT INTO M_商品 (商品コード, 商品名, 分類コード, 使用区分, 備考欄)
        VALUES (:code, :name, :category, :status, :note)";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);

// 更新（UPDATE）
$sql = "UPDATE M_商品 SET 商品名 = :name, 分類コード = :category,
        使用区分 = :status, 備考欄 = :note
        WHERE 商品コード = :code";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);

// 削除（DELETE）
$sql = "DELETE FROM M_商品 WHERE 商品コード = :code";
$stmt = $pdo->prepare($sql);
$stmt->execute(['code' => $code]);
```

---

### 7.3 Access特有の関数の対応

#### 7.3.1 FORMAT関数
- **Access**: `FORMAT(日付, 'yyyy/mm/dd hh:nn')`
- **SQL Server**: `FORMAT(日付, 'yyyy/MM/dd HH:mm')`
- **PHP**: `date('Y/m/d H:i', strtotime($date))`

#### 7.3.2 IIF関数
- **Access**: `IIF(条件, 真の値, 偽の値)`
- **SQL Server**: `CASE WHEN 条件 THEN 真の値 ELSE 偽の値 END`
- **PHP**: `$condition ? $true : $false`

#### 7.3.3 REPLACE/LTRIM関数
- **Access**: `REPLACE(LTRIM(文字列), ' ', '/')`
- **SQL Server**: `REPLACE(LTRIM(文字列), ' ', '/')`
- **PHP**: `str_replace(' ', '/', ltrim($str))`

---

### 7.4 実装優先度

#### Phase 09-10（DB接続・基本機能）
| No | クエリ名 | 優先度 | 備考 |
|----|---------|--------|------|
| 1 | CQ_商品 | ★★★ | 入力画面で必須 |
| 2 | CQ_担当者 | ★★★ | 入力画面で必須 |
| 3 | CQ_対応区分 | ★★★ | 入力画面で必須 |
| 4 | CQ_部門 | ★★ | 検索画面で使用 |
| 5 | DQ_対応内容一覧 | ★★★ | 入力画面で必須 |

#### Phase 11（メイン画面）
| No | クエリ名 | 優先度 | 備考 |
|----|---------|--------|------|
| 6 | FQ_サポート報告_一覧表_明細 | ★★★ | メイン画面の核 |
| 7 | CQ_担当者_検索 | ★★ | 検索機能 |

#### Phase 12以降（マスタ保守・帳票）
| No | クエリ名 | 優先度 | 備考 |
|----|---------|--------|------|
| 8 | FQ_保守_商品_明細 | ★★ | マスタ保守 |
| 9 | FQ_保守_定型文_明細 | ★★ | マスタ保守 |
| 10 | FQ_保守_対応区分_明細 | ★ | マスタ保守 |
| 11 | FQ_保守_対応内容項目_明細 | ★ | マスタ保守 |
| 12 | RQ_サポート報告書 | ★ | 印刷機能 |
| 13 | EXQ_サポート報告_一覧表_明細 | ★ | エクスポート機能 |

---

## 8. まとめ

### 8.1 クエリのWEB化方針
1. **シンプルなクエリ**: PHPのPDOで直接実装
2. **複雑なクエリ**: ストアドプロシージャで実装
3. **頻繁に使用するクエリ**: SQL ServerのVIEWも検討

### 8.2 実装時の注意点
1. **Access関数の変換**: FORMAT、IIF、REPLACE等をSQL ServerまたはPHPで書き換え
2. **LEFT JOINの保持**: 既存のテーブル結合ロジックをそのまま移植
3. **ページング処理**: 一覧表示には必ずLIMIT/OFFSET（またはOFFSET FETCH）を実装
4. **検索条件の動的追加**: WHERE句をパラメータ化
5. **Ajax化**: コンボボックス等はAjaxで動的に取得

### 8.3 削除するクエリ
- **FQ_NEWS**: 仕様不明のため実装見送り（必要に応じて追加）
- **LQ_商品**: FQ_保守_商品_明細と重複のため削除

---

**作成者**: Claude AI  
**最終更新**: 2025-11-20
