# サポート報告書WEBシステム コーディング規約書

**作成日**: 2025-11-20  
**バージョン**: 1.0  
**Phase**: 01

---

## 1. 概要

本規約書は、参考システム（C:\inetpub\func\、C:\inetpub\wwwroot\ois-web\）の分析結果に基づき、サポート報告書WEBシステム開発における統一的なコーディング規約を定めたものです。

---

## 2. PHPコーディング規約

### 2.1 基本方針
- **PHPバージョン**: PHP 7.4以上を対象
- **文字コード**: UTF-8（BOMなし）
- **改行コード**: LF（\n）
- **インデント**: タブまたはスペース4つ（プロジェクト内で統一）

### 2.2 ファイル構造

#### 2.2.1 PHPファイルの基本構造
```php
<?php
// 共通関数読み込み
require_once("../../func/inc.php");

// その他の必要なファイル読み込み
// require_once("xxx.php");

// セッション処理、権限チェック等

// 変数初期化

// POST/GET処理

// メイン処理

// HTML出力（別ファイルまたは同一ファイル内）
?>
```

#### 2.2.2 PHPタグ
- 開始タグ: `<?php`（省略形 `<?` は使用しない）
- 終了タグ: PHPのみのファイルでは省略可能、HTMLを含む場合は `?>` を使用

### 2.3 命名規則

#### 2.3.1 変数名
- **形式**: スネークケース（snake_case）
- **プレフィックス**: 特に規定なし、但し用途が明確な場合は使用推奨
  - `$err_msg`: エラーメッセージ配列
  - `$FLG`: フラグ変数
  - `$POST_MODE`: POSTモード判定
  - `$GET_MODE`: GETモード判定

```php
// 良い例
$user_name = "山田太郎";
$customer_code = 12345;
$err_msg = array();

// 避けるべき例
$userName = "山田太郎";  // キャメルケースは避ける
$cc = 12345;  // 略称は避ける（明らかな場合を除く）
```

#### 2.3.2 定数
- **形式**: 大文字スネークケース（UPPER_SNAKE_CASE）

```php
define('MAX_RETRY_COUNT', 3);
define('DEFAULT_PAGE_SIZE', 20);
```

#### 2.3.3 関数名
- **形式**: スネークケース（snake_case）
- **命名**: 動詞 + 名詞の組み合わせが基本

```php
function get_customer_info($customer_code) {
    // 処理
}

function validate_input_data($data) {
    // 処理
}
```

### 2.4 エラー処理

#### 2.4.1 エラー出力設定
```php
// 開発環境
error_reporting(E_ALL ^ E_NOTICE);
ini_set('display_errors', 'On');

// 本番環境（本番移行時に変更）
error_reporting(0);
ini_set('display_errors', 'Off');
```

#### 2.4.2 エラーメッセージ管理
```php
// エラーメッセージは配列で管理
$err_msg = array();

if ($validation_error) {
    $err_msg[] = "顧客コードを入力してください。";
}

if (count($err_msg) > 0) {
    // エラー表示処理
}
```

### 2.5 データベース接続

#### 2.5.1 PDO接続（inc.phpで定義済み）
```php
// inc.phpで既に接続済みの$pdo_connを使用
try {
    $stmt = $pdo_conn->prepare("EXEC dbo.stored_procedure_name @param = :param");
    $stmt->bindValue(':param', $value, PDO::PARAM_STR);
    $stmt->execute();
    $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    $err_msg[] = "データベースエラー: " . $e->getMessage();
}
```

#### 2.5.2 ストアドプロシージャの呼び出し
```php
// パラメータ付きストアドプロシージャ
$stmt = $pdo_conn->prepare("EXEC dbo.SEL_M_商品 @商品コード開始 = :start, @商品コード終了 = :end");
$stmt->bindValue(':start', $start_code, PDO::PARAM_INT);
$stmt->bindValue(':end', $end_code, PDO::PARAM_INT);
$stmt->execute();
$products = $stmt->fetchAll(PDO::FETCH_ASSOC);
```

### 2.6 セキュリティ

#### 2.6.1 XSS対策
```php
// 出力時は必ずhtmlspecialchars()でエスケープ
echo htmlspecialchars($user_input, ENT_QUOTES, 'UTF-8');

// 関数化して使用（myFunction.phpに定義推奨）
function h($str) {
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}
```

#### 2.6.2 SQLインジェクション対策
```php
// プリペアドステートメントを必ず使用
$stmt = $pdo_conn->prepare("SELECT * FROM table WHERE id = :id");
$stmt->bindValue(':id', $id, PDO::PARAM_INT);
$stmt->execute();

// 直接SQL文字列を組み立てない（NG例）
// $sql = "SELECT * FROM table WHERE id = " . $id;  // NG!
```

#### 2.6.3 CSRF対策
```php
// トークン生成（社内ネットワーク限定のため、今回は実装しない）
// 将来的な外部公開を考慮する場合は実装を検討
```

### 2.7 セッション管理

```php
// inc.phpでセッション開始済み
// セッション変数の使用例
$_SESSION['login_id'] = $user_id;
$_SESSION['user_name'] = $user_name;

// セッションタイムアウト: 9時間（inc.phpで設定済み）
// ini_set('session.gc_maxlifetime', 32400);
```

---

## 3. HTMLコーディング規約

### 3.1 基本方針
- **DOCTYPE**: XHTML 1.0 Transitional（参考システムに準拠）
- **文字コード**: UTF-8
- **レスポンシブ対応**: PC/Tablet/SP用CSSを分離

### 3.2 HTML構造

#### 3.2.1 基本テンプレート
```html
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>サポート報告書システム</title>
<link rel="stylesheet" type="text/css" href="css/pc.css" media="screen and (min-width:769px)" />
<link rel="stylesheet" type="text/css" href="css/tablet.css" media="screen and (min-width:481px) and (max-width:768px)" />
<link rel="stylesheet" type="text/css" href="css/sp.css" media="screen and (max-width:480px)" />
<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
</head>
<body>

<!-- コンテンツ -->

</body>
</html>
```

### 3.3 フォーム規約

#### 3.3.1 フォームの基本構造
```html
<form method="post" action="<?php echo htmlspecialchars($_SERVER['PHP_SELF']); ?>">
    <table class="input-table">
        <tr>
            <th>項目名</th>
            <td><input type="text" name="field_name" value="<?php echo h($field_value); ?>" /></td>
        </tr>
    </table>
    <div class="button-area">
        <input type="submit" name="submit" value="登録" />
    </div>
</form>
```

#### 3.3.2 input要素の命名
- **name属性**: スネークケース（snake_case）
- **id属性**: ケバブケース（kebab-case）

```html
<input type="text" name="customer_code" id="customer-code" />
<select name="response_type" id="response-type"></select>
```

---

## 4. CSSコーディング規約

### 4.1 基本方針
- **ファイル分割**: pc.css、tablet.css、sp.cssの3ファイル
- **命名規則**: BEMライクな命名を推奨（厳密なBEMでなくても可）
- **プレフィックス**: 特に規定なし

### 4.2 クラス命名規則

```css
/* 良い例 */
.header { }
.header-title { }
.button-primary { }
.input-table { }
.error-message { }

/* 避けるべき例 */
.hd { }  /* 略称は避ける */
.Header { }  /* キャメルケースは避ける */
```

### 4.3 メディアクエリ
```css
/* pc.css: 769px以上 */
/* tablet.css: 481px～768px */
/* sp.css: 480px以下 */

/* レスポンシブ対応時の注意点 */
/* - 各CSSファイルで同一クラスを定義 */
/* - メディアクエリはHTMLのlink要素で制御 */
```

---

## 5. JavaScriptコーディング規約

### 5.1 基本方針
- **ライブラリ**: jQuery 1.11.3を使用
- **ファイル配置**: js/ディレクトリ配下
- **命名規則**: キャメルケース（camelCase）

### 5.2 jQuery使用例

#### 5.2.1 基本構造
```javascript
$(function() {
    // DOM読み込み完了後の処理
    
    // イベントハンドラ
    $('#submit-button').on('click', function() {
        // 処理
    });
});
```

#### 5.2.2 Ajax通信
```javascript
$.ajax({
    type: 'POST',
    url: 'ajax_handler.php',
    data: {
        action: 'get_data',
        param: value
    },
    dataType: 'json',
    success: function(response) {
        // 成功時の処理
    },
    error: function(xhr, status, error) {
        // エラー時の処理
        alert('通信エラーが発生しました。');
    }
});
```

---

## 6. コメント規約

### 6.1 PHPコメント

#### 6.1.1 ファイルヘッダーコメント
```php
<?php
/*
 * ファイル名: support_main.php
 * 機能概要: サポート報告書メイン画面
 * 作成日: 2025-11-20
 * 作成者: Claude AI
 * 
 * 修正履歴:
 * 2025-11-20 新規作成
 */
```

#### 6.1.2 関数コメント
```php
/**
 * 顧客情報を取得する
 * 
 * @param int $customer_code 顧客コード
 * @return array 顧客情報配列
 */
function get_customer_info($customer_code) {
    // 処理
}
```

#### 6.1.3 処理ブロックコメント
```php
// ------------------------------------------------
// 入力チェック処理
// ------------------------------------------------
if (empty($_POST['customer_code'])) {
    $err_msg[] = "顧客コードを入力してください。";
}
```

### 6.2 HTML/CSSコメント

```html
<!-- メインコンテンツエリア開始 -->
<div class="main-content">
    <!-- 内容 -->
</div>
<!-- メインコンテンツエリア終了 -->
```

```css
/* ================================================
   ヘッダー部分
   ================================================ */
.header {
    /* スタイル */
}
```

---

## 7. バージョン管理規約

### 7.1 コミットメッセージ
```
[種別] 簡潔な説明

詳細な説明（必要な場合）

例:
[追加] ログイン機能の実装
[修正] 顧客検索のバグ修正
[更新] デザインの調整
[削除] 不要なコメントの削除
```

---

## 8. 参考情報

### 8.1 参考にした既存システムの特徴

#### 8.1.1 inc.php（共通初期化ファイル）
- セッション管理（タイムアウト9時間）
- エラー出力レベル設定
- PDO接続設定
- キャッシュ制御ヘッダー
- タイムゾーン設定（Asia/Tokyo）

#### 8.1.2 myFunction.php（共通関数ライブラリ）
- 画像リサイズ関数（myResizeImage）
- 画像回転関数（myImageRotate）
- その他汎用関数

#### 8.1.3 myConvert.php（文字コード変換）
- magic_quotes_gpc対応
- POST/GETデータのstripslashes処理

#### 8.1.4 既存画面ファイル（ken_main.php等）の特徴
- require_once()での共通ファイル読み込み
- セッション変数の活用
- エラーメッセージ配列管理
- ストアドプロシージャの積極活用
- 大量のコメント（修正履歴含む）

---

## 9. 補足事項

### 9.1 今回のプロジェクトで特に注意すべき点

1. **既存DBとの互換性**
   - SQL Serverのストアドプロシージャをそのまま使用
   - テーブル構造は変更しない
   - 日本語カラム名に対応

2. **社内ネットワーク限定**
   - セキュリティはやや緩和（CSRF対策等は省略）
   - ただしXSS、SQLインジェクション対策は必須

3. **レスポンシブ対応**
   - PC/Tablet/SP用のCSSを分離
   - メディアクエリはlink要素で制御

4. **既存システムとの一貫性**
   - 参考システム（ois-web）のコーディングスタイルを踏襲
   - 共通関数（inc.php、myFunction.php等）を活用

---

**本規約書は開発の進行に応じて適宜更新されます。**
